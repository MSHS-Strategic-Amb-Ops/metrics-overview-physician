---
output:
  html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```
<style type="text/css">
div.main-container {
  max-width: 2000px;
  margin-left: 0;
  margin-right: auto;
}
</style>
<style>
.tocify {
color: black;
}
<!-- } -->
<!-- .tocify .tocify-header { -->
<!--     position: fixed; -->
<!--     <!-- top: 50px; --> -->
<!--     left: 50px; -->
<!--     width: 350px; -->
<!--     <!-- border: solid 3px black; --> -->
<!--     <!-- height: 200px; --> -->
<!--  border: none; -->
<!-- } -->
.tocify .tocify-header .active {
color: white;
background: #d80b8c;
font-weight: bold;
}
<!-- .tocify .tocify-item { -->
<!-- background: white; -->
<!-- color: black; -->
<!--  border: none; -->
<!-- } -->
</style>
<style>
  .nav-pills>li>a:hover, .nav-pills>li>a:focus, .nav-pills>li.active>a,     .nav-pills>li.active>a:hover, .nav-pills>li.active>a:focus{
     background-color: #212070;
     }
</style>
<style>
.container { width: 1800px; }
h2 {
  background-color: #dddedd;
  color: black;
  text-indent: 20px;
  <!-- font-weight: bold; -->
}
h3 {
  background-color: #f2f2f2;
  color: black;
  text-indent: 20px;
  <!-- font-weight: bold; -->
}
h4 {
  <!-- background-color: #dddedd; -->
  <!-- color: black; -->
  text-indent: 50px;
  <!-- font-weight: bold; -->
}
</style>
<style>
.blackbox {
  padding: 1em;
  background: white;
  color: black;
  border: 2px solid #7f7f7f;
  width: 100%;
  position: center;
  align: center;
  margin: 0px auto;
}
.center {
  text-align: left;
  margin: 0px auto;
}
</style>
<!-- ```{css toc-content, echo = FALSE} -->
<!-- #TOC { -->
<!--   right: 270px; -->
<!--   margin: 20px 0px 25px 0px; -->
<!-- } -->
<!-- .main-container { -->
<!--     margin-left: 200px; -->
<!-- } -->
<!-- ``` -->
```{r Load Packages, echo = FALSE, warning = FALSE, message = FALSE}

# # Load packages -----------------------------------------------------------------------------------
suppressMessages({
  memory.limit(size = 8000000)
  library(readxl)
  library(writexl)
  library(plyr)
  library(dplyr)
  library(data.table)
  library(zoo)
  library(shiny)
  library(shinydashboard)
  library(shinydashboardPlus)
  library(shinyWidgets)
  library(htmlwidgets)
  library(lubridate)
  library(tcltk)
  library(tidyverse)
  library(plotly)
  library(knitr)
  library(kableExtra)
  library(leaflet)
  library(grid)
  library(gridExtra)
  library(eeptools)
  library(ggQC)
  library(zipcodeR)
  library(utils)
  library(scales)
  library(chron)
  library(bupaR)
  library(shiny)
  library(DT)
  library(DiagrammeR)
  library(shinyalert)
  library(edeaR)
  library(processmapR)
  library(processmonitR)
  library(processanimateR)
  library(tidyr)
  library(lubridate)
  library(RColorBrewer)
  library(DiagrammeR)
  library(ggplot2)
  library(leaflet)
  library(readr)
  library(highcharter)
  library(ggforce) # for 'geom_arc_bar'
  library(packcircles) # for packed circle graph
  library(viridis)
  library(ggiraph)
  library(treemapify)
  library(treemap)
  library(broom)
  library(extrafont)
  library(tis) # for US holidays
  library(vroom)
  library(sjmisc)
  library(tools)
  library(here)
  library(shinyBS)
  library(shinyscreenshot)
  library(fasttime)
  library(shinycssloaders)
  library(feather)
  # library(zipcodeR)
  library(formattable)
  library(shinyjs)
  library(janitor)
  library(patchwork)
  library(flexdashboard)
  # library(tidyverse)
  # library(viridis)
  # library(hrbrthemes)
  # library(plotly)
  # install.packages("bsts")
  library(bsts)
  library(reactable)
  # install.packages("reactablefmtr")
  library(reactablefmtr)
  library(svDialogs)
  # library(openxlsx)
  library(flextable)
  library(officedown)
  library(officer)
  library(magrittr)
  library(webshot) 
  library(png)
  library(ggh4x)
  library(RODBC)
  library(DBI)
  library(odbc)
  library(dbplyr)
  library(pool)
  library(emojifont)
  library(lubridate)
})

# devtools::install_github("hafen/lazyrmd")
# require(lazyrmd)
# 
# options(repos = c(tessera = "http://packages.tessera.io",
#   getOption("repos")))
# install.packages("lazyrmd")
# require(lazyrmd)

```


```{r Graph asthetics, echo = FALSE, warning = FALSE, message = FALSE}
### Color Functions for Graphs ============================================================

# Mount Sinai corporate colors "USE THIS TO ADD COLORS"
MountSinai_colors <- c(
  `dark purple`  = "#212070",
  `dark pink`    = "#d80b8c",
  `dark blue`    = "#00aeef",
  `dark grey`    = "#7f7f7f",
  `yellow`       = "#ffc000",
  `purple`       = "#7030a0",
  `med purple`   = "#5753d0",
  `med pink`     = "#f75dbe",
  `med blue`     = "#5cd3ff",
  `med grey`     = "#a5a7a5",
  `light purple` = "#c7c6ef",
  `light pink`   = "#fcc9e9",
  `light blue`   = "#c9f0ff",
  `light grey`   = "#dddedd"
  )

# Function to extract Mount Sinai colors as hex codes
# Use Character names of MountSinai_colors

MountSinai_cols <- function(...) {
  cols <- c(...)
  
  if (is.null(cols))
    return (MountSinai_colors)
  
  MountSinai_colors[cols]
}

# Color Function that can be used to call all colors is "MountSinai_cols()"
# Use in ggplot 

  #MountSinai_cols()       # will provide all colors and their hex codes in a table 
  #MountSinai_cols("pink") # will provide color name and the hex code for the pink color

# Create palettes 
MountSinai_palettes <- list(
  `all`   = MountSinai_cols("dark purple","dark pink","dark blue","dark grey",
                            "med purple","med pink","med blue","med grey", 
                            "light purple","light pink","light blue","light grey"),
  
  `main`  = MountSinai_cols("dark purple","dark pink","dark blue","dark grey"),
  
  `purple`  = MountSinai_cols("dark purple","med purple","light purple"),
  
  `pink`  = MountSinai_cols("dark pink","med pink","light pink"),
  
  `blue`  = MountSinai_cols("dark blue", "med blue", "light blue"),
  
  `grey`  = MountSinai_cols("dark grey", "med grey", "light grey"),
  
  `purpleGrey` = MountSinai_cols("dark purple", "dark grey"),
  
  `pinkBlue` = MountSinai_cols("dark pink", "dark blue")
  
)

# MountSinai_palettes
# Return function to interpolate a Mount Sinai color palette
# default value is the main palette, reverse = True will change the order

MountSinai_pal <- function(palette = "all", reverse = FALSE, ...) {
  pal <- MountSinai_palettes[[palette]]
  
  if (reverse) pal <- rev(pal)
  
  colorRampPalette(pal, ...)
}



# Scale Function for ggplot can be used instead of scale_color_manual
scale_color_MountSinai <- function(palette = "all", discrete = TRUE, reverse = FALSE, ...) {
  pal <- MountSinai_pal(palette = palette, reverse = reverse)
  
  if (discrete) {
    discrete_scale("colour", paste0("MountSinai_", palette), palette = pal, ...)
  } else {
    scale_color_gradientn(colours = pal(256), ...)
  }
}

# Scale Fill for ggplot insetead of scale_fill_manual 
scale_fill_MountSinai <- function(palette = "all", discrete = TRUE, reverse = FALSE, ...) {
  pal <- MountSinai_pal(palette = palette, reverse = reverse)

  if (discrete) {
    discrete_scale("fill", paste0("MountSinai_", palette), palette = pal, ...)
  } else {
    scale_fill_gradientn(colours = pal(256), ...)
  }
}

# Use in ggplot 
  # scale_color_MountSinai("main")

```


```{r Global Functions, echo = FALSE, warning = FALSE, message = FALSE}

'%!in%' <- function(x,y)!('%in%'(x,y)) # Does not include
not_all_na <- function(x) all(!is.na(x)) # Exclude columns with All NAs

```


```{r Data Connections, echo = FALSE, warning = FALSE, message = FALSE}

# Connection to Oracle DB ------------------------------------------------------
conn1 <- dbPool(drv = odbc(), dsn = "OAO Cloud DB SoYoun", timeout = 30)
conn3 <- dbPool(drv = odbc(), dsn = "OAO Cloud DB Production", timeout = 30)
conn2 <- dbConnect(odbc(), 
                  "Clarity_prod", 
                  uid = "kweons01" , 
                  pwd = "kweons01123$")
conn4 <- dbPool(drv = odbc(), dsn = "OAO Cloud DB Staging", timeout = 30)

conn5 <- dbConnect(odbc(),
                    Driver = "SQLServer",
                    # Server = "10.2.42.69", # old server
                    Server = "datahub-synapse.sql.azuresynapse.net",
                    database = "datahub_epic_dw",
                    UID = "MSS_USER",
                    PWD = "Apple_Bees456$",
                    Port = 1433)

# Import Slot Availability Data ------------------------------------------------
slot_raw_tbl <- tbl(conn2, "Y_DM_BOOKED_FILLED_RATE")
access_raw_tbl <- tbl(conn2, "MV_DM_PATIENT_ACCESS")
f_sched_appt_tbl <- tbl(conn2, "F_SCHED_APPT")
availability_raw_tbl <- tbl(conn2, "V_AVAILABILITY")
block_raw_tbl <- tbl(conn2, "AVAIL_BLOCK")
block_name_tbl <- tbl(conn2, "ZC_APPT_BLOCK")
orders_raw_tbl <- tbl(conn2, "ORDER_PROC")
coverage_tbl <- tbl(conn2, "V_PAT_ENC_COVERAGE")
clarity_ser_tbl <- tbl(conn2, "CLARITY_SER")
slot_view_tbl <- tbl(conn3, in_schema("OAO_PRODUCTION", "AMBULATORY_SLOT_TABLE"))
temp_slot_tbl <- tbl(conn4, "AMBULATORY_SLOT_TABLE_TEMP")

radiology_dep_mapping_tbl <- tbl(conn1, "RADIOLOGY_DEP_MAPPING")

# access_raw_tbl <- tbl(conn5, in_schema("CLARITY", "MV_DM_PATIENT_ACCESS"))
# f_sched_appt_tbl <- tbl(conn5, dbplyr::ident_q('"CLARITY"."F_SCHED_APPT"'))
clarity_dep_conn <- tbl(conn5, dbplyr::ident_q('"Clarity"."CLARITY_DEP"'))


referrals_conn <- tbl(conn5, dbplyr::ident_q('"MS_SOLUTIONS_DEV"."y_s2_referrals_tmp"'))
caboodle_referrals_conn <- tbl(conn5, dbplyr::ident_q('"CABOODLE"."ReferralsDataView"'))
caboodle_referralFact_conn <- tbl(conn5, dbplyr::ident_q('"CABOODLE"."ReferralFact"'))
patient_conn <- tbl(conn5, dbplyr::ident_q('"CABOODLE"."PatientDim"'))
department_conn <- tbl(conn5, dbplyr::ident_q('"CABOODLE"."DepartmentDim"'))
clarity_ser_conn <- tbl(conn5, dbplyr::ident_q('"CLARITY"."CLARITY_SER"'))  
clarity_ser_2_conn <- tbl(conn5, dbplyr::ident_q('"CLARITY"."CLARITY_SER_2"'))  



department <- department_conn %>%
  dplyr::select(DepartmentEpicId, PostalCode) %>%
  collect()

clarity_referrals_tbl <- tbl(conn5, dbplyr::ident_q('"Clarity"."REFERRAL"'))


clarity_ser_tbl <- tbl(conn2, "CLARITY_SER")
clarity_ser_2_tbl <- tbl(conn2, "CLARITY_SER_2")

clarity_ser <- clarity_ser_tbl %>% 
  select(PROV_ID, PROV_TYPE, PROV_NAME) %>%
  collect()

clarity_ser_2 <- clarity_ser_2_tbl %>% 
  select(PROV_ID, NPI) %>% 
  collect()

```


```{r Report Variables, echo = FALSE, warning = FALSE, message = FALSE}

report_run_date <- Sys.Date()
date_start <- format(Sys.Date(), "%Y-%m-%d")
# date_start <- paste0(format(Sys.Date(), "%Y-%m"),"-01")

current_year <- format(report_run_date, "%Y")
prior_year <- as.character(as.numeric(current_year) -1)

current_month <- format(report_run_date, "%m")

current_year_month <- paste0(current_year,"-",current_month)
```


```{r Scheduling Data Processing, echo = FALSE, warning = FALSE, message = FALSE}

# access_raw <- access_raw_tbl %>%
#   left_join(clarity_ser_tbl %>% select(PROV_ID, PROV_TYPE)) %>%
#   filter(PROV_TYPE == "Physician") %>%
#   filter(SITE %in% c("MSUS", "MSH- AMBULATORY CARE", "NETWORK", "MSW", "MSH-MSDFP",
#                      "MSDMG", "MSB", "MSM", "MSQ", "MSBI", "MSSN", "NYEE")) %>%
#   mutate(appt_year = year(CONTACT_DATE)) %>%
#   filter(appt_year >= 2024) %>%
#   filter(DERIVED_STATUS_DESC == "Arrived") %>%
#   group_by(appt_year, VISIT_GROUP_NUM, PRC_NAME, APPT_LENGTH) %>%
#   summarise(total = n()) %>%
#   collect()
# 
# require(openxlsx)
# write.xlsx(access_raw, "Volume by Appt Length.xlsx")

# access <- access_raw_tbl %>%
#   filter(PAT_ENC_CSN_ID == 100176727351) %>%
#   # mutate(appt_year = year(CONTACT_DATE),
#   #        appt_month = month(CONTACT_DATE)) %>%
#   # filter(SITE == "MSUS") %>%
#   # filter(appt_year == 2025) %>%
#   # filter(appt_month == 1) %>%
#   collect()

# require(openxlsx)
# write.xlsx(access, "MSUS Scheduling Data Jan25.xlsx")
```

```{r}

# appt_status_check <- access_raw_tbl %>%
#   filter(year(CONTACT_DATE) == 2025) %>%
#   group_by(APPT_STATUS_C, APPT_STATUS_NAME, DERIVED_STATUS_DESC) %>%
#   collect()
# 
# no_show_comparison <- access_raw_tbl %>%
#   # left_join(clarity_ser_tbl %>% select(PROV_ID, PROV_TYPE)) %>%
#   # filter(PROV_TYPE == "Physician") %>%
#   filter(year(CONTACT_DATE) == 2025) %>%
#   filter(month(CONTACT_DATE) == 2) %>%
#   filter(!is.na(SITE)) %>%
#   filter(SITE %in% c("MSUS", "MSH- AMBULATORY CARE", "NETWORK", "MSW", "MSH-MSDFP", 
#                      "MSDMG", "MSB", "MSM", "MSQ", "MSBI", "MSSN", "NYEE")) %>%
#   mutate(lead_days = CONTACT_DATE - APPT_MADE_DATE) %>%
#   mutate(cancel_lead_days = CONTACT_DATE - APPT_CANC_DATE) %>%
#   # mutate(lead_days =  as.numeric(difftime(as.Date(APPT_MADE_DATE), as.Date(CONTACT_DATE), units = "days"))) %>%
#   mutate(appt_status = ifelse(DERIVED_STATUS_DESC == "Canceled" & cancel_lead_days <=0, "SameDay_Canceled", DERIVED_STATUS_DESC)) %>%
#   mutate(appt_year = year(CONTACT_DATE),
#          appt_month = month(CONTACT_DATE)) %>%
#   mutate(appt_made_year = year(APPT_MADE_DATE),
#          appt_made_month = month(APPT_MADE_DATE)) %>%
#   mutate(visit_type = ifelse(is.na(VISIT_GROUP_NUM), "ESTABLISHED", "NEW")) %>%
#   mutate(lead_14days = ifelse(lead_days <= 14, "lead_14days", "lead_14days_more")) %>%
#   group_by(SITE, DEPARTMENT_NAME, DEPARTMENT_ID, APPT_STATUS_NAME, DERIVED_STATUS_DESC, )
  
```


```{r Template Utilization, echo = FALSE, warning = FALSE, message = FALSE}

slot_util <- slot_view_tbl %>%
  filter(!is.na(CAMPUS)) %>%
  filter(CAMPUS %in% c("MSUS", "MSH- AMBULATORY CARE", "NETWORK", "MSW", "MSH-MSDFP",
                     "MSDMG", "MSB", "MSM", "MSQ", "MSBI", "MSSN", "NYEE")) %>%
  filter(!(CAMPUS %in% c("MSH- AMBULATORY CARE") & SLOT_MONTH_YEAR %in% c("2024-01", "2024-02", "2024-03", "2024-04", "2024-05"))) %>%
  mutate(slot_year = year(SLOT_DATE),
         slot_month = month(SLOT_DATE)) %>%
  filter(slot_year >= prior_year) %>%
  filter(SLOT_DATE < TO_DATE(date_start, "YYYY-MM-DD HH24:MI:SS")) %>%
  mutate(SPECIALTY_GRP = ifelse(CAMPUS_SPECIALTY %in% 
                                  c("Adolescent Medicine", "Community and Preventive Medicine", 
                                    "Family Medicine", "Internal Medicine", "Pediatrics", "Geriatrics", "Gerontology", "Urgent Care"), "Primary Care", "Specialty")) %>%
  group_by(CAMPUS, SPECIALTY_GRP, CAMPUS_SPECIALTY, DEPARTMENT, DEPARTMENT_ID, PROVIDER, PROV_ID, slot_year, slot_month) %>%
  summarise(AVAILABLE_MINS= sum(AVAILABLE_MINS, na.rm = T),
            SCHEDULED_MINS = sum(SCHEDULED_MINS, na.rm = T),
            ARRIVED_MINS = sum(ARRIVED_MINS, na.rm = T)) %>%
  mutate(sched_util = ifelse(is.na(AVAILABLE_MINS), 0, SCHEDULED_MINS/AVAILABLE_MINS)) %>%
  filter(sched_util > 0.3 & sched_util <= 1.5) %>%
  collect() %>%
  left_join(clarity_ser) %>%
  left_join(clarity_ser_2)



slot_util_mshs_baseline <- slot_util %>%
  filter(slot_year == prior_year) %>%
  filter(PROV_TYPE == "Physician") %>%
  group_by(slot_year, slot_month) %>%
  summarise(avail_hours = sum(AVAILABLE_MINS, na.rm = T)/60,
            sched_hours = sum(SCHEDULED_MINS, na.rm = T)/60,
            arrived_hours = sum(ARRIVED_MINS, na.rm = T)/60) %>%
  mutate(sched_util = sched_hours/avail_hours,
         prov_util = arrived_hours/avail_hours) %>%
  rename("Year" = slot_year,
         "Month" = slot_month)



slot_util_mshs_ytd <- slot_util %>%
  filter(slot_year == current_year) %>%
  filter(PROV_TYPE == "Physician") %>%
  group_by(slot_year, slot_month) %>%
  summarise(avail_hours = sum(AVAILABLE_MINS, na.rm = T)/60,
            sched_hours = sum(SCHEDULED_MINS, na.rm = T)/60,
            arrived_hours = sum(ARRIVED_MINS, na.rm = T)/60) %>%
  mutate(sched_util = sched_hours/avail_hours,
         prov_util = arrived_hours/avail_hours) %>%
  rename("Year" = slot_year,
         "Month" = slot_month)



slot_util_dep <- slot_util %>%
  filter(PROV_TYPE == "Physician") %>%
  group_by(CAMPUS, SPECIALTY_GRP, CAMPUS_SPECIALTY, DEPARTMENT, DEPARTMENT_ID, slot_year, slot_month) %>%
  summarise(avail_hours = sum(AVAILABLE_MINS, na.rm = T)/60,
            sched_hours = sum(SCHEDULED_MINS, na.rm = T)/60,
            arrived_hours = sum(ARRIVED_MINS, na.rm = T)/60) %>%
  mutate(sched_util = sched_hours/avail_hours,
         prov_util = arrived_hours/avail_hours) %>%
  rename("SITE" = CAMPUS,
         "DEPT_SPECIALTY_NAME" = CAMPUS_SPECIALTY,
         "DEPARTMENT_NAME" = DEPARTMENT,
         "Year" = slot_year,
         "Month" = slot_month)


slot_util_prov <- slot_util %>%
  group_by(CAMPUS, SPECIALTY_GRP, CAMPUS_SPECIALTY, DEPARTMENT, DEPARTMENT_ID, PROV_ID, PROV_TYPE, PROV_NAME, slot_year, slot_month) %>%
  summarise(avail_hours = sum(AVAILABLE_MINS, na.rm = T)/60,
            sched_hours = sum(SCHEDULED_MINS, na.rm = T)/60,
            arrived_hours = sum(ARRIVED_MINS, na.rm = T)/60) %>%
  mutate(sched_util = sched_hours/avail_hours,
         prov_util = arrived_hours/avail_hours) %>%
  rename("SITE" = CAMPUS,
         "DEPT_SPECIALTY_NAME" = CAMPUS_SPECIALTY,
         "DEPARTMENT_NAME" = DEPARTMENT,
         "Year" = slot_year,
         "Month" = slot_month)


```


```{r No Show, echo = FALSE, warning = FALSE, message = FALSE}

no_show_mshs_baseline <- access_raw_tbl %>%
  # left_join(clarity_ser_tbl %>% select(PROV_ID, PROV_TYPE)) %>%
  # filter(PROV_TYPE == "Physician") %>%
  
  filter(!is.na(SITE)) %>%
  filter(SITE %in% c("MSUS", "MSH- AMBULATORY CARE", "NETWORK", "MSW", "MSH-MSDFP", 
                     "MSDMG", "MSB", "MSM", "MSQ", "MSBI", "MSSN", "NYEE")) %>%
  mutate(lead_days = CONTACT_DATE - APPT_MADE_DATE) %>%
  mutate(cancel_lead_days = CONTACT_DATE - APPT_CANC_DATE) %>%
  # mutate(lead_days =  as.numeric(difftime(as.Date(APPT_MADE_DATE), as.Date(CONTACT_DATE), units = "days"))) %>%
  mutate(appt_status = ifelse(DERIVED_STATUS_DESC == "Canceled" & cancel_lead_days <=0, "SameDay_Canceled", DERIVED_STATUS_DESC)) %>%
  mutate(appt_year = year(CONTACT_DATE),
         appt_month = month(CONTACT_DATE)) %>%
  mutate(appt_made_year = year(APPT_MADE_DATE),
         appt_made_month = month(APPT_MADE_DATE)) %>%
  mutate(visit_type = ifelse(is.na(VISIT_GROUP_NUM), "ESTABLISHED", "NEW")) %>%
  mutate(lead_14days = ifelse(lead_days <= 14, "lead_14days", "lead_14days_more")) %>%
  
  filter(year(CONTACT_DATE) == prior_year) %>%
  filter(CONTACT_DATE < TO_DATE(date_start, "YYYY-MM-DD HH24:MI:SS")) %>%
  filter(appt_status %in% c("No Show","SameDay_Canceled","Arrived")) %>%
  group_by(appt_year, appt_month, appt_status) %>%
  summarise(total = n()) %>%
  collect() %>%
  pivot_wider(names_from = appt_status,
              values_from = total,
              values_fill = 0) %>%
  mutate(perc_noShowPlus = (`No Show` + SameDay_Canceled)/(Arrived + `No Show` + SameDay_Canceled),
         perc_noShow = (`No Show`)/(Arrived + `No Show` + SameDay_Canceled),
         perc_SameDayCanceled = (SameDay_Canceled)/(Arrived + `No Show` + SameDay_Canceled)) %>%
  rename("No_Show" = `No Show`,
         "Year" = appt_year,
         "Month" = appt_month)


no_show_mshs_ytd <- access_raw_tbl %>%
  # left_join(clarity_ser_tbl %>% select(PROV_ID, PROV_TYPE)) %>%
  # filter(PROV_TYPE == "Physician") %>%

  filter(!is.na(SITE)) %>%
  filter(SITE %in% c("MSUS", "MSH- AMBULATORY CARE", "NETWORK", "MSW", "MSH-MSDFP", 
                     "MSDMG", "MSB", "MSM", "MSQ", "MSBI", "MSSN", "NYEE")) %>%
  mutate(lead_days = CONTACT_DATE - APPT_MADE_DATE) %>%
  mutate(cancel_lead_days = CONTACT_DATE - APPT_CANC_DATE) %>%
  # mutate(lead_days =  as.numeric(difftime(as.Date(APPT_MADE_DATE), as.Date(CONTACT_DATE), units = "days"))) %>%
  mutate(appt_status = ifelse(DERIVED_STATUS_DESC == "Canceled" & cancel_lead_days <=0, "SameDay_Canceled", DERIVED_STATUS_DESC)) %>%
  mutate(appt_year = year(CONTACT_DATE),
         appt_month = month(CONTACT_DATE)) %>%
  mutate(appt_made_year = year(APPT_MADE_DATE),
         appt_made_month = month(APPT_MADE_DATE)) %>%
  mutate(visit_type = ifelse(is.na(VISIT_GROUP_NUM), "ESTABLISHED", "NEW")) %>%
  mutate(lead_14days = ifelse(lead_days <= 14, "lead_14days", "lead_14days_more")) %>%
  
  filter(year(CONTACT_DATE) == current_year) %>%
  filter(CONTACT_DATE < TO_DATE(date_start, "YYYY-MM-DD HH24:MI:SS")) %>%
  filter(appt_status %in% c("No Show","SameDay_Canceled","Arrived")) %>%
  group_by(appt_year, appt_month, appt_status) %>%
  summarise(total = n()) %>%
  collect() %>%
  pivot_wider(names_from = appt_status,
              values_from = total,
              values_fill = 0) %>%
  mutate(perc_noShowPlus = (`No Show` + SameDay_Canceled)/(Arrived + `No Show` + SameDay_Canceled),
         perc_noShow = (`No Show`)/(Arrived + `No Show` + SameDay_Canceled),
         perc_SameDayCanceled = (SameDay_Canceled)/(Arrived + `No Show` + SameDay_Canceled)) %>%
  rename("No_Show" = `No Show`,
         "Year" = appt_year,
         "Month" = appt_month)


no_show_dep <- access_raw_tbl %>%
  # left_join(clarity_ser_tbl %>% select(PROV_ID, PROV_TYPE)) %>%
  # filter(PROV_TYPE == "Physician") %>%

  filter(!is.na(SITE)) %>%
  filter(SITE %in% c("MSUS", "MSH- AMBULATORY CARE", "NETWORK", "MSW", "MSH-MSDFP", 
                     "MSDMG", "MSB", "MSM", "MSQ", "MSBI", "MSSN", "NYEE")) %>%
  mutate(lead_days = CONTACT_DATE - APPT_MADE_DATE) %>%
  mutate(cancel_lead_days = CONTACT_DATE - APPT_CANC_DATE) %>%
  # mutate(lead_days =  as.numeric(difftime(as.Date(APPT_MADE_DATE), as.Date(CONTACT_DATE), units = "days"))) %>%
  mutate(appt_status = ifelse(DERIVED_STATUS_DESC == "Canceled" & cancel_lead_days <=0, "SameDay_Canceled", DERIVED_STATUS_DESC)) %>%
  mutate(appt_year = year(CONTACT_DATE),
         appt_month = month(CONTACT_DATE)) %>%
  mutate(appt_made_year = year(APPT_MADE_DATE),
         appt_made_month = month(APPT_MADE_DATE)) %>%
  mutate(visit_type = ifelse(is.na(VISIT_GROUP_NUM), "ESTABLISHED", "NEW")) %>%
  mutate(lead_14days = ifelse(lead_days <= 14, "lead_14days", "lead_14days_more")) %>%
  mutate(SPECIALTY_GRP = ifelse(DEPT_SPECIALTY_NAME %in% 
                                  c("Adolescent Medicine", "Community and Preventive Medicine", 
                                    "Family Medicine", "Internal Medicine", "Pediatrics", "Geriatrics", "Gerontology", "Urgent Care"), "Primary Care", "Specialty")) %>%
  
  filter(year(CONTACT_DATE) >= prior_year) %>%
  filter(CONTACT_DATE < TO_DATE(date_start, "YYYY-MM-DD HH24:MI:SS")) %>%
  filter(appt_status %in% c("No Show","SameDay_Canceled","Arrived")) %>%
  group_by(SITE, SPECIALTY_GRP, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, DEPARTMENT_ID, appt_year, appt_month, appt_status) %>%
  summarise(total = n()) %>%
  collect() %>%
  pivot_wider(names_from = appt_status,
              values_from = total,
              values_fill = 0) %>%
  mutate(perc_noShowPlus = (`No Show` + SameDay_Canceled)/(Arrived + `No Show` + SameDay_Canceled),
         perc_noShow = (`No Show`)/(Arrived + `No Show` + SameDay_Canceled),
         perc_SameDayCanceled = (SameDay_Canceled)/(Arrived + `No Show` + SameDay_Canceled)) %>%
  rename("No_Show" = `No Show`,
         "Year" = appt_year,
          "Month" = appt_month)


no_show_prov <- access_raw_tbl %>%
  left_join(clarity_ser_tbl %>% select(PROV_ID, PROV_TYPE, PROV_NAME)) %>%
  # filter(PROV_TYPE == "Physician") %>%

  filter(!is.na(SITE)) %>%
  filter(SITE %in% c("MSUS", "MSH- AMBULATORY CARE", "NETWORK", "MSW", "MSH-MSDFP", 
                     "MSDMG", "MSB", "MSM", "MSQ", "MSBI", "MSSN", "NYEE")) %>%
  mutate(lead_days = CONTACT_DATE - APPT_MADE_DATE) %>%
  mutate(cancel_lead_days = CONTACT_DATE - APPT_CANC_DATE) %>%
  # mutate(lead_days =  as.numeric(difftime(as.Date(APPT_MADE_DATE), as.Date(CONTACT_DATE), units = "days"))) %>%
  mutate(appt_status = ifelse(DERIVED_STATUS_DESC == "Canceled" & cancel_lead_days <=0, "SameDay_Canceled", DERIVED_STATUS_DESC)) %>%
  mutate(appt_year = year(CONTACT_DATE),
         appt_month = month(CONTACT_DATE)) %>%
  mutate(appt_made_year = year(APPT_MADE_DATE),
         appt_made_month = month(APPT_MADE_DATE)) %>%
  mutate(visit_type = ifelse(is.na(VISIT_GROUP_NUM), "ESTABLISHED", "NEW")) %>%
  mutate(lead_14days = ifelse(lead_days <= 14, "lead_14days", "lead_14days_more")) %>%
  mutate(SPECIALTY_GRP = ifelse(DEPT_SPECIALTY_NAME %in% 
                                  c("Adolescent Medicine", "Community and Preventive Medicine", 
                                    "Family Medicine", "Internal Medicine", "Pediatrics", "Geriatrics", "Gerontology", "Urgent Care"), "Primary Care", "Specialty")) %>%
  
  filter(year(CONTACT_DATE) >= prior_year) %>%
  filter(CONTACT_DATE < TO_DATE(date_start, "YYYY-MM-DD HH24:MI:SS")) %>%
  filter(appt_status %in% c("No Show","SameDay_Canceled","Arrived")) %>%
  group_by(SITE, SPECIALTY_GRP, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, DEPARTMENT_ID, PROV_ID, PROV_TYPE, PROV_NAME, appt_year, appt_month, appt_status) %>%
  summarise(total = n()) %>%
  collect() %>%
  pivot_wider(names_from = appt_status,
              values_from = total,
              values_fill = 0) %>%
  mutate(perc_noShowPlus = (`No Show` + SameDay_Canceled)/(Arrived + `No Show` + SameDay_Canceled),
         perc_noShow = (`No Show`)/(Arrived + `No Show` + SameDay_Canceled),
         perc_SameDayCanceled = (SameDay_Canceled)/(Arrived + `No Show` + SameDay_Canceled)) %>%
  rename("No_Show" = `No Show`,
         "Year" = appt_year,
          "Month" = appt_month)



```


```{r New Patient Ratio, echo = FALSE, warning = FALSE, message = FALSE}


new_pt_ratio_mshs_baseline <- access_raw_tbl %>%
  # left_join(clarity_ser_tbl %>% select(PROV_ID, PROV_TYPE)) %>%
  # filter(PROV_TYPE == "Physician") %>%

  filter(!is.na(SITE)) %>%
  filter(SITE %in% c("MSUS", "MSH- AMBULATORY CARE", "NETWORK", "MSW", "MSH-MSDFP", 
                     "MSDMG", "MSB", "MSM", "MSQ", "MSBI", "MSSN", "NYEE")) %>%
  mutate(lead_days = CONTACT_DATE - APPT_MADE_DATE) %>%
  mutate(cancel_lead_days = CONTACT_DATE - APPT_CANC_DATE) %>%
  # mutate(lead_days =  as.numeric(difftime(as.Date(APPT_MADE_DATE), as.Date(CONTACT_DATE), units = "days"))) %>%
  mutate(appt_status = ifelse(DERIVED_STATUS_DESC == "Canceled" & cancel_lead_days <=0, "SameDay_Canceled", DERIVED_STATUS_DESC)) %>%
  mutate(appt_year = year(CONTACT_DATE),
         appt_month = month(CONTACT_DATE)) %>%
  mutate(appt_made_year = year(APPT_MADE_DATE),
         appt_made_month = month(APPT_MADE_DATE)) %>%
  mutate(visit_type = ifelse(is.na(VISIT_GROUP_NUM), "ESTABLISHED", "NEW"),
         new_pt_los = ifelse(is.na(LOS_NAME), "ESTABLISHED_LOS", ifelse(LOS_NAME %LIKE% "%INITIAL%" | LOS_NAME %LIKE% "%NEW%", "NEW_LOS", "ESTABLISHED_LOS"))) %>%
  mutate(lead_14days = ifelse(lead_days <= 14, "lead_14days", "lead_14days_more")) %>%
  
  filter(year(CONTACT_DATE) == prior_year) %>%
  filter(CONTACT_DATE < TO_DATE(date_start, "YYYY-MM-DD HH24:MI:SS")) %>%
  filter(appt_status %in% c("Arrived")) %>%
  group_by(appt_year, appt_month, new_pt_los) %>%
  summarise(total = n()) %>%
  collect() %>%
  pivot_wider(names_from = new_pt_los,
              values_from = total,
              values_fill = 0) %>%
  rowwise() %>%
  mutate(appts_arrived = sum(NEW_LOS, ESTABLISHED_LOS, na.rm = T),
         perc_new_los = NEW_LOS/appts_arrived) %>%
  rename("Year" = appt_year,
         "Month" = appt_month)


new_pt_ratio_mshs_ytd <- access_raw_tbl %>%
  # left_join(clarity_ser_tbl %>% select(PROV_ID, PROV_TYPE)) %>%
  # filter(PROV_TYPE == "Physician") %>%

  filter(!is.na(SITE)) %>%
  filter(SITE %in% c("MSUS", "MSH- AMBULATORY CARE", "NETWORK", "MSW", "MSH-MSDFP", 
                     "MSDMG", "MSB", "MSM", "MSQ", "MSBI", "MSSN", "NYEE")) %>%
  mutate(lead_days = CONTACT_DATE - APPT_MADE_DATE) %>%
  mutate(cancel_lead_days = CONTACT_DATE - APPT_CANC_DATE) %>%
  # mutate(lead_days =  as.numeric(difftime(as.Date(APPT_MADE_DATE), as.Date(CONTACT_DATE), units = "days"))) %>%
  mutate(appt_status = ifelse(DERIVED_STATUS_DESC == "Canceled" & cancel_lead_days <=0, "SameDay_Canceled", DERIVED_STATUS_DESC)) %>%
  mutate(appt_year = year(CONTACT_DATE),
         appt_month = month(CONTACT_DATE)) %>%
  mutate(appt_made_year = year(APPT_MADE_DATE),
         appt_made_month = month(APPT_MADE_DATE)) %>%
  mutate(visit_type = ifelse(is.na(VISIT_GROUP_NUM), "ESTABLISHED", "NEW"),
         new_pt_los = ifelse(is.na(LOS_NAME), "ESTABLISHED_LOS", ifelse(LOS_NAME %LIKE% "%INITIAL%" | LOS_NAME %LIKE% "%NEW%", "NEW_LOS", "ESTABLISHED_LOS"))) %>%
  mutate(lead_14days = ifelse(lead_days <= 14, "lead_14days", "lead_14days_more")) %>%
  
  filter(year(CONTACT_DATE) == current_year) %>%
  filter(CONTACT_DATE < TO_DATE(date_start, "YYYY-MM-DD HH24:MI:SS")) %>%
  filter(appt_status %in% c("Arrived")) %>%
  group_by(appt_year, appt_month, new_pt_los) %>%
  summarise(total = n()) %>%
  collect() %>%
  pivot_wider(names_from = new_pt_los,
              values_from = total,
              values_fill = 0) %>%
  rowwise() %>%
  mutate(appts_arrived = sum(NEW_LOS, ESTABLISHED_LOS, na.rm = T),
         perc_new_los = NEW_LOS/appts_arrived) %>%
  rename("Year" = appt_year,
         "Month" = appt_month)


new_pt_ratio_dep <- access_raw_tbl %>%
  # left_join(clarity_ser_tbl %>% select(PROV_ID, PROV_TYPE)) %>%
  # filter(PROV_TYPE == "Physician") %>%

  filter(!is.na(SITE)) %>%
  filter(SITE %in% c("MSUS", "MSH- AMBULATORY CARE", "NETWORK", "MSW", "MSH-MSDFP", 
                     "MSDMG", "MSB", "MSM", "MSQ", "MSBI", "MSSN", "NYEE")) %>%
  mutate(lead_days = CONTACT_DATE - APPT_MADE_DATE) %>%
  mutate(cancel_lead_days = CONTACT_DATE - APPT_CANC_DATE) %>%
  # mutate(lead_days =  as.numeric(difftime(as.Date(APPT_MADE_DATE), as.Date(CONTACT_DATE), units = "days"))) %>%
  mutate(appt_status = ifelse(DERIVED_STATUS_DESC == "Canceled" & cancel_lead_days <=0, "SameDay_Canceled", DERIVED_STATUS_DESC)) %>%
  mutate(appt_year = year(CONTACT_DATE),
         appt_month = month(CONTACT_DATE)) %>%
  mutate(appt_made_year = year(APPT_MADE_DATE),
         appt_made_month = month(APPT_MADE_DATE)) %>%
  mutate(visit_type = ifelse(is.na(VISIT_GROUP_NUM), "ESTABLISHED", "NEW"),
         new_pt_los = ifelse(is.na(LOS_NAME), "ESTABLISHED_LOS", ifelse(LOS_NAME %LIKE% "%INITIAL%" | LOS_NAME %LIKE% "%NEW%", "NEW_LOS", "ESTABLISHED_LOS"))) %>%
  mutate(lead_14days = ifelse(lead_days <= 14, "lead_14days", "lead_14days_more")) %>%
  mutate(SPECIALTY_GRP = ifelse(DEPT_SPECIALTY_NAME %in% 
                                  c("Adolescent Medicine", "Community and Preventive Medicine", 
                                    "Family Medicine", "Internal Medicine", "Pediatrics", "Geriatrics", "Gerontology", "Urgent Care"), "Primary Care", "Specialty")) %>%
  
  filter(year(CONTACT_DATE) >= prior_year) %>%
  filter(CONTACT_DATE < TO_DATE(date_start, "YYYY-MM-DD HH24:MI:SS")) %>%
  filter(appt_status %in% c("Arrived")) %>%
  group_by(SITE, SPECIALTY_GRP, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, DEPARTMENT_ID, appt_year, appt_month, new_pt_los) %>%
  summarise(total = n()) %>%
  collect() %>%
  pivot_wider(names_from = new_pt_los,
              values_from = total,
              values_fill = 0) %>%
  rowwise() %>%
  mutate(appts_arrived = sum(NEW_LOS, ESTABLISHED_LOS, na.rm = T),
         perc_new_los = NEW_LOS/appts_arrived) %>%
  rename("Year" = appt_year,
         "Month" = appt_month)


new_pt_ratio_prov <- access_raw_tbl %>%
  left_join(clarity_ser_tbl %>% select(PROV_ID, PROV_TYPE, PROV_NAME)) %>%
  # filter(PROV_TYPE == "Physician") %>%

  filter(!is.na(SITE)) %>%
  filter(SITE %in% c("MSUS", "MSH- AMBULATORY CARE", "NETWORK", "MSW", "MSH-MSDFP", 
                     "MSDMG", "MSB", "MSM", "MSQ", "MSBI", "MSSN", "NYEE")) %>%
  mutate(lead_days = CONTACT_DATE - APPT_MADE_DATE) %>%
  mutate(cancel_lead_days = CONTACT_DATE - APPT_CANC_DATE) %>%
  # mutate(lead_days =  as.numeric(difftime(as.Date(APPT_MADE_DATE), as.Date(CONTACT_DATE), units = "days"))) %>%
  mutate(appt_status = ifelse(DERIVED_STATUS_DESC == "Canceled" & cancel_lead_days <=0, "SameDay_Canceled", DERIVED_STATUS_DESC)) %>%
  mutate(appt_year = year(CONTACT_DATE),
         appt_month = month(CONTACT_DATE)) %>%
  mutate(appt_made_year = year(APPT_MADE_DATE),
         appt_made_month = month(APPT_MADE_DATE)) %>%
  mutate(visit_type = ifelse(is.na(VISIT_GROUP_NUM), "ESTABLISHED", "NEW"),
         new_pt_los = ifelse(is.na(LOS_NAME), "ESTABLISHED_LOS", ifelse(LOS_NAME %LIKE% "%INITIAL%" | LOS_NAME %LIKE% "%NEW%", "NEW_LOS", "ESTABLISHED_LOS"))) %>%
  mutate(lead_14days = ifelse(lead_days <= 14, "lead_14days", "lead_14days_more")) %>%
  mutate(SPECIALTY_GRP = ifelse(DEPT_SPECIALTY_NAME %in% 
                                  c("Adolescent Medicine", "Community and Preventive Medicine", 
                                    "Family Medicine", "Internal Medicine", "Pediatrics", "Geriatrics", "Gerontology", "Urgent Care"), "Primary Care", "Specialty")) %>%
  
  filter(year(CONTACT_DATE) >= prior_year) %>%
  filter(CONTACT_DATE < TO_DATE(date_start, "YYYY-MM-DD HH24:MI:SS")) %>%
  filter(appt_status %in% c("Arrived")) %>%
  group_by(SITE, SPECIALTY_GRP, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, DEPARTMENT_ID, PROV_ID, PROV_TYPE, PROV_NAME, appt_year, appt_month, new_pt_los) %>%
  summarise(total = n()) %>%
  collect() %>%
  pivot_wider(names_from = new_pt_los,
              values_from = total,
              values_fill = 0) %>%
  rowwise() %>%
  mutate(appts_arrived = sum(NEW_LOS, ESTABLISHED_LOS, na.rm = T),
         perc_new_los = NEW_LOS/appts_arrived) %>%
  rename("Year" = appt_year,
         "Month" = appt_month)

```



```{r New Patient Access, echo = FALSE, warning = FALSE, message = FALSE}

new_pt_waitTime_mshs_baseline <- access_raw_tbl %>%
  # left_join(clarity_ser_tbl %>% select(PROV_ID, PROV_TYPE)) %>%
  # filter(PROV_TYPE == "Physician") %>%

  filter(!is.na(SITE)) %>%
  filter(SITE %in% c("MSUS", "MSH- AMBULATORY CARE", "NETWORK", "MSW", "MSH-MSDFP", 
                     "MSDMG", "MSB", "MSM", "MSQ", "MSBI", "MSSN", "NYEE")) %>%
  mutate(lead_days = CONTACT_DATE - APPT_MADE_DATE) %>%
  mutate(cancel_lead_days = CONTACT_DATE - APPT_CANC_DATE) %>%
  # mutate(lead_days =  as.numeric(difftime(as.Date(APPT_MADE_DATE), as.Date(CONTACT_DATE), units = "days"))) %>%
  mutate(appt_status = ifelse(DERIVED_STATUS_DESC == "Canceled" & cancel_lead_days <=0, "SameDay_Canceled", DERIVED_STATUS_DESC)) %>%
  mutate(appt_year = year(CONTACT_DATE),
         appt_month = month(CONTACT_DATE)) %>%
  mutate(appt_made_year = year(APPT_MADE_DATE),
         appt_made_month = month(APPT_MADE_DATE)) %>%
  mutate(visit_type = ifelse(is.na(VISIT_GROUP_NUM), "ESTABLISHED", "NEW")) %>%
  mutate(lead_14days = ifelse(lead_days <= 14, "lead_14days", "lead_14days_more")) %>%
  
  filter(year(APPT_MADE_DATE) == prior_year) %>%
  filter(APPT_MADE_DATE < TO_DATE(date_start, "YYYY-MM-DD HH24:MI:SS")) %>%
  filter(visit_type == "NEW") %>%
  group_by(appt_made_year, appt_made_month, visit_type, lead_14days) %>%
  summarise(total = n()) %>%
  collect() %>%
  pivot_wider(names_from = c("visit_type", "lead_14days"),
              values_from = total,
              values_fill = 0) %>%
  rowwise() %>%
  mutate(NEW_appts_scheduled = sum(NEW_lead_14days, NEW_lead_14days_more, na.rm = T),
         perc_new_lead_14days = NEW_lead_14days/NEW_appts_scheduled) %>%
  rename("Year" = appt_made_year,
         "Month" = appt_made_month)


new_pt_waitTime_mshs_ytd <- access_raw_tbl %>%
  # left_join(clarity_ser_tbl %>% select(PROV_ID, PROV_TYPE)) %>%
  # filter(PROV_TYPE == "Physician") %>%

  filter(!is.na(SITE)) %>%
  filter(SITE %in% c("MSUS", "MSH- AMBULATORY CARE", "NETWORK", "MSW", "MSH-MSDFP", 
                     "MSDMG", "MSB", "MSM", "MSQ", "MSBI", "MSSN", "NYEE")) %>%
  mutate(lead_days = CONTACT_DATE - APPT_MADE_DATE) %>%
  mutate(cancel_lead_days = CONTACT_DATE - APPT_CANC_DATE) %>%
  # mutate(lead_days =  as.numeric(difftime(as.Date(APPT_MADE_DATE), as.Date(CONTACT_DATE), units = "days"))) %>%
  mutate(appt_status = ifelse(DERIVED_STATUS_DESC == "Canceled" & cancel_lead_days <=0, "SameDay_Canceled", DERIVED_STATUS_DESC)) %>%
  mutate(appt_year = year(CONTACT_DATE),
         appt_month = month(CONTACT_DATE)) %>%
  mutate(appt_made_year = year(APPT_MADE_DATE),
         appt_made_month = month(APPT_MADE_DATE)) %>%
  mutate(visit_type = ifelse(is.na(VISIT_GROUP_NUM), "ESTABLISHED", "NEW")) %>%
  mutate(lead_14days = ifelse(lead_days <= 14, "lead_14days", "lead_14days_more")) %>%
  
  filter(year(APPT_MADE_DATE) == current_year) %>%
  filter(APPT_MADE_DATE < TO_DATE(date_start, "YYYY-MM-DD HH24:MI:SS")) %>%
  filter(visit_type == "NEW") %>%
  group_by(appt_made_year, appt_made_month, visit_type, lead_14days) %>%
  summarise(total = n()) %>%
  collect() %>%
  pivot_wider(names_from = c("visit_type", "lead_14days"),
              values_from = total,
              values_fill = 0) %>%
  rowwise() %>%
  mutate(NEW_appts_scheduled = sum(NEW_lead_14days, NEW_lead_14days_more, na.rm = T),
         perc_new_lead_14days = NEW_lead_14days/NEW_appts_scheduled) %>%
  rename("Year" = appt_made_year,
         "Month" = appt_made_month)


new_pt_waitTime_dep <- access_raw_tbl %>%
  # left_join(clarity_ser_tbl %>% select(PROV_ID, PROV_TYPE)) %>%
  # filter(PROV_TYPE == "Physician") %>%

  filter(!is.na(SITE)) %>%
  filter(SITE %in% c("MSUS", "MSH- AMBULATORY CARE", "NETWORK", "MSW", "MSH-MSDFP", 
                     "MSDMG", "MSB", "MSM", "MSQ", "MSBI", "MSSN", "NYEE")) %>%
  mutate(lead_days = CONTACT_DATE - APPT_MADE_DATE) %>%
  mutate(cancel_lead_days = CONTACT_DATE - APPT_CANC_DATE) %>%
  # mutate(lead_days =  as.numeric(difftime(as.Date(APPT_MADE_DATE), as.Date(CONTACT_DATE), units = "days"))) %>%
  mutate(appt_status = ifelse(DERIVED_STATUS_DESC == "Canceled" & cancel_lead_days <=0, "SameDay_Canceled", DERIVED_STATUS_DESC)) %>%
  mutate(appt_year = year(CONTACT_DATE),
         appt_month = month(CONTACT_DATE)) %>%
  mutate(appt_made_year = year(APPT_MADE_DATE),
         appt_made_month = month(APPT_MADE_DATE)) %>%
  mutate(visit_type = ifelse(is.na(VISIT_GROUP_NUM), "ESTABLISHED", "NEW")) %>%
  mutate(lead_14days = ifelse(lead_days <= 14, "lead_14days", "lead_14days_more")) %>%
  mutate(SPECIALTY_GRP = ifelse(DEPT_SPECIALTY_NAME %in% 
                                  c("Adolescent Medicine", "Community and Preventive Medicine", 
                                    "Family Medicine", "Internal Medicine", "Pediatrics", "Geriatrics", "Gerontology", "Urgent Care"), "Primary Care", "Specialty")) %>%
  
  filter(year(APPT_MADE_DATE) >= prior_year) %>%
  filter(APPT_MADE_DATE < TO_DATE(date_start, "YYYY-MM-DD HH24:MI:SS")) %>%
  filter(visit_type == "NEW") %>%
  group_by(SITE, SPECIALTY_GRP, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, DEPARTMENT_ID, appt_made_year, appt_made_month, visit_type, lead_14days) %>%
  summarise(total = n()) %>%
  collect() %>%
  pivot_wider(names_from = c("visit_type", "lead_14days"),
              values_from = total,
              values_fill = 0) %>%
  rowwise() %>%
  mutate(NEW_appts_scheduled = sum(NEW_lead_14days, NEW_lead_14days_more, na.rm = T),
         perc_new_lead_14days = NEW_lead_14days/NEW_appts_scheduled) %>%
  rename("Year" = appt_made_year,
          "Month" = appt_made_month)


new_pt_waitTime_prov <- access_raw_tbl %>%
  left_join(clarity_ser_tbl %>% select(PROV_ID, PROV_TYPE, PROV_NAME)) %>%
  # filter(PROV_TYPE == "Physician") %>%

  filter(!is.na(SITE)) %>%
  filter(SITE %in% c("MSUS", "MSH- AMBULATORY CARE", "NETWORK", "MSW", "MSH-MSDFP", 
                     "MSDMG", "MSB", "MSM", "MSQ", "MSBI", "MSSN", "NYEE")) %>%
  mutate(lead_days = CONTACT_DATE - APPT_MADE_DATE) %>%
  mutate(cancel_lead_days = CONTACT_DATE - APPT_CANC_DATE) %>%
  # mutate(lead_days =  as.numeric(difftime(as.Date(APPT_MADE_DATE), as.Date(CONTACT_DATE), units = "days"))) %>%
  mutate(appt_status = ifelse(DERIVED_STATUS_DESC == "Canceled" & cancel_lead_days <=0, "SameDay_Canceled", DERIVED_STATUS_DESC)) %>%
  mutate(appt_year = year(CONTACT_DATE),
         appt_month = month(CONTACT_DATE)) %>%
  mutate(appt_made_year = year(APPT_MADE_DATE),
         appt_made_month = month(APPT_MADE_DATE)) %>%
  mutate(visit_type = ifelse(is.na(VISIT_GROUP_NUM), "ESTABLISHED", "NEW")) %>%
  mutate(lead_14days = ifelse(lead_days <= 14, "lead_14days", "lead_14days_more")) %>%
  mutate(SPECIALTY_GRP = ifelse(DEPT_SPECIALTY_NAME %in% 
                                  c("Adolescent Medicine", "Community and Preventive Medicine", 
                                    "Family Medicine", "Internal Medicine", "Pediatrics", "Geriatrics", "Gerontology", "Urgent Care"), "Primary Care", "Specialty")) %>%
  
  filter(year(APPT_MADE_DATE) >= prior_year) %>%
  filter(APPT_MADE_DATE < TO_DATE(date_start, "YYYY-MM-DD HH24:MI:SS")) %>%
  filter(visit_type == "NEW") %>%
  group_by(SITE, SPECIALTY_GRP, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, DEPARTMENT_ID, PROV_ID, PROV_TYPE, PROV_NAME, 
           appt_made_year, appt_made_month, visit_type, lead_14days) %>%
  summarise(total = n()) %>%
  collect() %>%
  pivot_wider(names_from = c("visit_type", "lead_14days"),
              values_from = total,
              values_fill = 0) %>%
  rowwise() %>%
  mutate(NEW_appts_scheduled = sum(NEW_lead_14days, NEW_lead_14days_more, na.rm = T),
         perc_new_lead_14days = NEW_lead_14days/NEW_appts_scheduled) %>%
  rename("Year" = appt_made_year,
          "Month" = appt_made_month)
```


```{r Payer Mix, echo = FALSE, warning = FALSE, message = FALSE}


payer_mix_dep <- access_raw_tbl %>%
  # left_join(clarity_ser_tbl %>% select(PROV_ID, PROV_TYPE)) %>%
  # filter(PROV_TYPE == "Physician") %>%

  filter(!is.na(SITE)) %>%
  filter(SITE %in% c("MSUS", "MSH- AMBULATORY CARE", "NETWORK", "MSW", "MSH-MSDFP", 
                     "MSDMG", "MSB", "MSM", "MSQ", "MSBI", "MSSN", "NYEE")) %>%
  mutate(lead_days = CONTACT_DATE - APPT_MADE_DATE) %>%
  mutate(cancel_lead_days = CONTACT_DATE - APPT_CANC_DATE) %>%
  # mutate(lead_days =  as.numeric(difftime(as.Date(APPT_MADE_DATE), as.Date(CONTACT_DATE), units = "days"))) %>%
  mutate(appt_status = ifelse(DERIVED_STATUS_DESC == "Canceled" & cancel_lead_days <=0, "SameDay_Canceled", DERIVED_STATUS_DESC)) %>%
  mutate(appt_year = year(CONTACT_DATE),
         appt_month = month(CONTACT_DATE)) %>%
  mutate(appt_made_year = year(APPT_MADE_DATE),
         appt_made_month = month(APPT_MADE_DATE)) %>%
  mutate(visit_type = ifelse(is.na(VISIT_GROUP_NUM), "ESTABLISHED", "NEW"),
         new_pt_los = ifelse(is.na(LOS_NAME), "ESTABLISHED_LOS", ifelse(LOS_NAME %LIKE% "%INITIAL%" | LOS_NAME %LIKE% "%NEW%", "NEW_LOS", "ESTABLISHED_LOS"))) %>%
  mutate(lead_14days = ifelse(lead_days <= 14, "lead_14days", "lead_14days_more")) %>%
  mutate(SPECIALTY_GRP = ifelse(DEPT_SPECIALTY_NAME %in% 
                                  c("Adolescent Medicine", "Community and Preventive Medicine", 
                                    "Family Medicine", "Internal Medicine", "Pediatrics", "Geriatrics", "Gerontology", "Urgent Care"), "Primary Care", "Specialty")) %>%
  filter(year(CONTACT_DATE) >= prior_year) %>%
  filter(CONTACT_DATE < TO_DATE(date_start, "YYYY-MM-DD HH24:MI:SS")) %>%
  filter(appt_status %in% c("Arrived")) %>%
  mutate(FINCLASS_GRP = ifelse(is.na(FINCLASS), "OTHER",
                               ifelse(FINCLASS %LIKE% "%Commercial%", "COMMERCIAL_MANAGED_CARE",
                                      ifelse(FINCLASS %LIKE% "%Medicare Managed Care%", "MEDICARE_HMO",
                                             ifelse(FINCLASS %LIKE% "%Medicaid Managed Care%", "MEDICAID_HMO",
                                                    ifelse(FINCLASS %LIKE% "%Medicare MS%", "MEDICARE",
                                                           ifelse(FINCLASS %LIKE% "%Medicaid MS%", "MEDICAID",
                                                                  ifelse(FINCLASS %LIKE% "%WTC%" | FINCLASS %LIKE% "%Transplant%" | 
                                                                           FINCLASS %LIKE% "%Worker's%" | FINCLASS %LIKE% "%Unspecified%" | FINCLASS %LIKE% "%Other%", "OTHER",
                                                                         ifelse(FINCLASS %LIKE% "%Self%", "SELF_PAY",
                                                                                ifelse(FINCLASS %LIKE% "%No Coverage%", "NO_COVERAGE_ASSIGNED", "OTHER")))))))))) %>%
  
  group_by(SITE, SPECIALTY_GRP, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, DEPARTMENT_ID, appt_year, appt_month, FINCLASS_GRP, new_pt_los) %>%
  summarise(total = n()) %>%
  collect() %>%
  pivot_wider(names_from = c("FINCLASS_GRP", "new_pt_los"),
              values_from = total,
              values_fill = 0) %>%
  rename("Year" = appt_year,
         "Month" = appt_month)


  
payer_mix_prov <- access_raw_tbl %>%
  left_join(clarity_ser_tbl %>% select(PROV_ID, PROV_TYPE, PROV_NAME)) %>%
  # filter(PROV_TYPE == "Physician") %>%

  filter(!is.na(SITE)) %>%
  filter(SITE %in% c("MSUS", "MSH- AMBULATORY CARE", "NETWORK", "MSW", "MSH-MSDFP", 
                     "MSDMG", "MSB", "MSM", "MSQ", "MSBI", "MSSN", "NYEE")) %>%
  mutate(lead_days = CONTACT_DATE - APPT_MADE_DATE) %>%
  mutate(cancel_lead_days = CONTACT_DATE - APPT_CANC_DATE) %>%
  # mutate(lead_days =  as.numeric(difftime(as.Date(APPT_MADE_DATE), as.Date(CONTACT_DATE), units = "days"))) %>%
  mutate(appt_status = ifelse(DERIVED_STATUS_DESC == "Canceled" & cancel_lead_days <=0, "SameDay_Canceled", DERIVED_STATUS_DESC)) %>%
  mutate(appt_year = year(CONTACT_DATE),
         appt_month = month(CONTACT_DATE)) %>%
  mutate(appt_made_year = year(APPT_MADE_DATE),
         appt_made_month = month(APPT_MADE_DATE)) %>%
  mutate(visit_type = ifelse(is.na(VISIT_GROUP_NUM), "ESTABLISHED", "NEW"),
         new_pt_los = ifelse(is.na(LOS_NAME), "ESTABLISHED_LOS", ifelse(LOS_NAME %LIKE% "%INITIAL%" | LOS_NAME %LIKE% "%NEW%", "NEW_LOS", "ESTABLISHED_LOS"))) %>%
  mutate(lead_14days = ifelse(lead_days <= 14, "lead_14days", "lead_14days_more")) %>%
  mutate(SPECIALTY_GRP = ifelse(DEPT_SPECIALTY_NAME %in% 
                                  c("Adolescent Medicine", "Community and Preventive Medicine", 
                                    "Family Medicine", "Internal Medicine", "Pediatrics", "Geriatrics", "Gerontology", "Urgent Care"), "Primary Care", "Specialty")) %>%
  
  filter(year(CONTACT_DATE) >= prior_year) %>%
  filter(CONTACT_DATE < TO_DATE(date_start, "YYYY-MM-DD HH24:MI:SS")) %>%
  filter(appt_status %in% c("Arrived")) %>%
  mutate(FINCLASS_GRP = ifelse(is.na(FINCLASS), "OTHER",
                               ifelse(FINCLASS %LIKE% "%Commercial%", "COMMERCIAL_MANAGED_CARE",
                                      ifelse(FINCLASS %LIKE% "%Medicare Managed Care%", "MEDICARE_HMO",
                                             ifelse(FINCLASS %LIKE% "%Medicaid Managed Care%", "MEDICAID_HMO",
                                                    ifelse(FINCLASS %LIKE% "%Medicare MS%", "MEDICARE",
                                                           ifelse(FINCLASS %LIKE% "%Medicaid MS%", "MEDICAID",
                                                                  ifelse(FINCLASS %LIKE% "%WTC%" | FINCLASS %LIKE% "%Transplant%" | 
                                                                           FINCLASS %LIKE% "%Worker's%" | FINCLASS %LIKE% "%Unspecified%" | FINCLASS %LIKE% "%Other%", "OTHER",
                                                                         ifelse(FINCLASS %LIKE% "%Self%", "SELF_PAY",
                                                                                ifelse(FINCLASS %LIKE% "%No Coverage%", "NO_COVERAGE_ASSIGNED", "OTHER")))))))))) %>%
  
  group_by(SITE, SPECIALTY_GRP, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, DEPARTMENT_ID, PROV_ID, PROV_TYPE, PROV_NAME, 
           appt_year, appt_month, FINCLASS_GRP, new_pt_los) %>%
  summarise(total = n()) %>%
  collect() %>%
  pivot_wider(names_from = c("FINCLASS_GRP", "new_pt_los"),
              values_from = total,
              values_fill = 0) %>%
  rename("Year" = appt_year,
         "Month" = appt_month)


```


```{r Wait Time by Payer Mix, echo = FALSE, warning = FALSE, message = FALSE}


waitTime_payer_mix_dep <- access_raw_tbl %>%
  # left_join(clarity_ser_tbl %>% select(PROV_ID, PROV_TYPE)) %>%
  # filter(PROV_TYPE == "Physician") %>%

  filter(!is.na(SITE)) %>%
  filter(SITE %in% c("MSUS", "MSH- AMBULATORY CARE", "NETWORK", "MSW", "MSH-MSDFP", 
                     "MSDMG", "MSB", "MSM", "MSQ", "MSBI", "MSSN", "NYEE")) %>%
  mutate(lead_days = CONTACT_DATE - APPT_MADE_DATE) %>%
  mutate(cancel_lead_days = CONTACT_DATE - APPT_CANC_DATE) %>%
  # mutate(lead_days =  as.numeric(difftime(as.Date(APPT_MADE_DATE), as.Date(CONTACT_DATE), units = "days"))) %>%
  mutate(appt_status = ifelse(DERIVED_STATUS_DESC == "Canceled" & cancel_lead_days <=0, "SameDay_Canceled", DERIVED_STATUS_DESC)) %>%
  mutate(appt_year = year(CONTACT_DATE),
         appt_month = month(CONTACT_DATE)) %>%
  mutate(appt_made_year = year(APPT_MADE_DATE),
         appt_made_month = month(APPT_MADE_DATE)) %>%
  mutate(visit_type = ifelse(is.na(VISIT_GROUP_NUM), "ESTABLISHED", "NEW"),
         new_pt_los = ifelse(is.na(LOS_NAME), "ESTABLISHED_LOS", ifelse(LOS_NAME %LIKE% "%INITIAL%" | LOS_NAME %LIKE% "%NEW%", "NEW_LOS", "ESTABLISHED_LOS"))) %>%
  mutate(lead_14days = ifelse(lead_days <= 14, "lead_14days", "lead_14days_more")) %>%
  mutate(SPECIALTY_GRP = ifelse(DEPT_SPECIALTY_NAME %in% 
                                  c("Adolescent Medicine", "Community and Preventive Medicine", 
                                    "Family Medicine", "Internal Medicine", "Pediatrics", "Geriatrics", "Gerontology", "Urgent Care"), "Primary Care", "Specialty")) %>%
  filter(year(APPT_MADE_DATE) >= prior_year) %>%
  filter(APPT_MADE_DATE < TO_DATE(date_start, "YYYY-MM-DD HH24:MI:SS")) %>%
  # filter(appt_status %in% c("Arrived")) %>%
  mutate(FINCLASS_GRP = ifelse(is.na(FINCLASS), "OTHER",
                               ifelse(FINCLASS %LIKE% "%Commercial%", "COMMERCIAL_MANAGED_CARE",
                                      ifelse(FINCLASS %LIKE% "%Medicare Managed Care%", "MEDICARE_HMO",
                                             ifelse(FINCLASS %LIKE% "%Medicaid Managed Care%", "MEDICAID_HMO",
                                                    ifelse(FINCLASS %LIKE% "%Medicare MS%", "MEDICARE",
                                                           ifelse(FINCLASS %LIKE% "%Medicaid MS%", "MEDICAID",
                                                                  ifelse(FINCLASS %LIKE% "%WTC%" | FINCLASS %LIKE% "%Transplant%" | 
                                                                           FINCLASS %LIKE% "%Worker's%" | FINCLASS %LIKE% "%Unspecified%" | FINCLASS %LIKE% "%Other%", "OTHER",
                                                                         ifelse(FINCLASS %LIKE% "%Self%", "SELF_PAY",
                                                                                ifelse(FINCLASS %LIKE% "%No Coverage%", "NO_COVERAGE_ASSIGNED", "OTHER")))))))))) %>%
  
  group_by(SITE, SPECIALTY_GRP, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, DEPARTMENT_ID, appt_made_year, appt_made_month, FINCLASS_GRP, visit_type, lead_14days) %>%
  summarise(total = n()) %>%
  collect() %>%
  pivot_wider(names_from = c("FINCLASS_GRP", "visit_type", "lead_14days"),
              values_from = total,
              values_fill = 0) %>%
  rename("Year" = appt_made_year,
         "Month" = appt_made_month)


  
waitTime_payer_mix_prov <- access_raw_tbl %>%
  left_join(clarity_ser_tbl %>% select(PROV_ID, PROV_TYPE, PROV_NAME)) %>%
  # filter(PROV_TYPE == "Physician") %>%

  filter(!is.na(SITE)) %>%
  filter(SITE %in% c("MSUS", "MSH- AMBULATORY CARE", "NETWORK", "MSW", "MSH-MSDFP", 
                     "MSDMG", "MSB", "MSM", "MSQ", "MSBI", "MSSN", "NYEE")) %>%
  mutate(lead_days = CONTACT_DATE - APPT_MADE_DATE) %>%
  mutate(cancel_lead_days = CONTACT_DATE - APPT_CANC_DATE) %>%
  # mutate(lead_days =  as.numeric(difftime(as.Date(APPT_MADE_DATE), as.Date(CONTACT_DATE), units = "days"))) %>%
  mutate(appt_status = ifelse(DERIVED_STATUS_DESC == "Canceled" & cancel_lead_days <=0, "SameDay_Canceled", DERIVED_STATUS_DESC)) %>%
  mutate(appt_year = year(CONTACT_DATE),
         appt_month = month(CONTACT_DATE)) %>%
  mutate(appt_made_year = year(APPT_MADE_DATE),
         appt_made_month = month(APPT_MADE_DATE)) %>%
  mutate(visit_type = ifelse(is.na(VISIT_GROUP_NUM), "ESTABLISHED", "NEW"),
         new_pt_los = ifelse(is.na(LOS_NAME), "ESTABLISHED_LOS", ifelse(LOS_NAME %LIKE% "%INITIAL%" | LOS_NAME %LIKE% "%NEW%", "NEW_LOS", "ESTABLISHED_LOS"))) %>%
  mutate(lead_14days = ifelse(lead_days <= 14, "lead_14days", "lead_14days_more")) %>%
  mutate(SPECIALTY_GRP = ifelse(DEPT_SPECIALTY_NAME %in% 
                                  c("Adolescent Medicine", "Community and Preventive Medicine", 
                                    "Family Medicine", "Internal Medicine", "Pediatrics", "Geriatrics", "Gerontology", "Urgent Care"), "Primary Care", "Specialty")) %>%
  
  filter(year(APPT_MADE_DATE) >= prior_year) %>%
  filter(APPT_MADE_DATE < TO_DATE(date_start, "YYYY-MM-DD HH24:MI:SS")) %>%
  # filter(appt_status %in% c("Arrived")) %>%
  mutate(FINCLASS_GRP = ifelse(is.na(FINCLASS), "OTHER",
                               ifelse(FINCLASS %LIKE% "%Commercial%", "COMMERCIAL_MANAGED_CARE",
                                      ifelse(FINCLASS %LIKE% "%Medicare Managed Care%", "MEDICARE_HMO",
                                             ifelse(FINCLASS %LIKE% "%Medicaid Managed Care%", "MEDICAID_HMO",
                                                    ifelse(FINCLASS %LIKE% "%Medicare MS%", "MEDICARE",
                                                           ifelse(FINCLASS %LIKE% "%Medicaid MS%", "MEDICAID",
                                                                  ifelse(FINCLASS %LIKE% "%WTC%" | FINCLASS %LIKE% "%Transplant%" | 
                                                                           FINCLASS %LIKE% "%Worker's%" | FINCLASS %LIKE% "%Unspecified%" | FINCLASS %LIKE% "%Other%", "OTHER",
                                                                         ifelse(FINCLASS %LIKE% "%Self%", "SELF_PAY",
                                                                                ifelse(FINCLASS %LIKE% "%No Coverage%", "NO_COVERAGE_ASSIGNED", "OTHER")))))))))) %>%
  
  group_by(SITE, SPECIALTY_GRP, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, DEPARTMENT_ID, PROV_ID, PROV_TYPE, PROV_NAME, 
           appt_made_year, appt_made_month, FINCLASS_GRP, visit_type, lead_14days) %>%
  summarise(total = n()) %>%
  collect() %>%
  pivot_wider(names_from = c("FINCLASS_GRP", "visit_type", "lead_14days"),
              values_from = total,
              values_fill = 0) %>%
  rename("Year" = appt_made_year,
         "Month" = appt_made_month)

```


```{r Referral Exclusion,  echo = FALSE, warning = FALSE, message = FALSE}

#Referral Orders to Exclude from Conversion Reporting
#Last Updated: 03.11.2025
# Referral Orders Excluded

ref_exclude <- c(
  "AMB REF TO ACUPUNCTURE",
  "AMB REF TO ADOL HEALTH COLPOSCOPY",
  "AMB REF TO ADOL HEALTH ENDOCRINE",
  "AMB REF TO ADOL HEALTH FITNESS SOCIAL WORK",
  "AMB REF TO ADOL HEALTH HEALTH EDUCATION",
  "AMB REF TO ADOL HEALTH HIV PRE TEST",
  "AMB REF TO ADOL HEALTH NUTRITION",
  "AMB REF TO ADOL HEALTH PRIMARY CARE SW",
  "AMB REF TO ADOL HEALTH PROJECT IMPACT",
  "AMB REF TO ADOL HEALTH PSYCHIATRY",
  "AMB REF TO AHC GENERAL DENTAL",
  "AMB REF TO AHC HEALTH NUTRITION",
  "AMB REF TO AHC LARC",
  "AMB REF TO AHC LEGAL HEALTH CLINIC",
  "AMB REF TO AHC MENTAL HEALTH",
  "AMB REF TO AHC OPTOMETRY",
  "AMB REF TO AHC ORAL SURGERY",
  "AMB REF TO AHC PEDS GI",
  "AMB REF TO AHC PSYCHOLOGY",
  "AMB REF TO AHC PSYCHOLOGY TESTING",
  "AMB REF TO ALCOHOL ADDICTION LIVER CLINIC",
  "AMB REF TO ALCOHOL/DRUG USE CLINIC",
  "AMB REF TO ALLERGY & CLIN IMM (FPA ASTHMA)",
  "AMB REF TO AMBULATORY BP MONITORING",
  "AMB REF TO ANESTHESIOLOGY",
  "AMB REF TO APHERESIS",
  "AMB REF TO APHERESIS - CELL COLLECTION ALLOGENEIC",
  "AMB REF TO APHERESIS - CELL COLLECTION AUTOLOGOUS",
  "AMB REF TO BACK AND NECK CENTER OF EXCELLENCE",
  "AMB REF TO BH SCREENING COLONOSCOPY",
  "AMB REF TO CAPSULE ENDOSCOPY",
  "AMB REF TO CARDIAC CATH (NS)",
  "AMB REF TO CARDIAC REHAB",
  "AMB REF TO CARDIOTHORACIC SURGERY",
  "AMB REF TO CARE MANAGEMENT",
  "AMB REF TO CHIROPRACTOR",
  "AMB REF TO CHRONIC CARE MANAGEMENT",
  "AMB REF TO CKD TEACHING/EDUCATION",
  "AMB REF TO CO INFECTION CLINIC",
  "AMB REF TO COGNITIVE NEUROLOGY",
  "AMB REF TO COLONOSCOPY (SCREENING)",
  "AMB REF TO COLONOSCOPY,DIAGNOSTIC",
  "AMB REF TO COLPOSCOPY",
  "AMB REF TO COMMUNITY PARAMEDICINE",
  "AMB REF TO CONDITION MANAGEMENT PROGRAM - REMOTE PATIENT MONITORING",
  "AMB REF TO CONSULT WORKERS COMPENSATION/SELIKOFF CENTER FOR OCCUPATIONAL HEALTH",
  "AMB REF TO COUMADIN CLINIC",
  "AMB REF TO COVID-19 FOLLOW UP",
  "AMB REF TO COVID-19 TESTING (SYMPTOMATIC ONLY)",
  "AMB REF TO COVID-19 THERAPEUTIC INFUSION",
  "AMB REF TO CYSTIC FIBROSIS",
  "AMB REF TO DENTISTRY",
  "AMB REF TO DENTISTRY (OB)",
  "AMB REF TO DIABETES ALLIANCE",
  "AMB REF TO DIABETES CARE PROGRAM",
  "AMB REF TO DIABETIC EDUCATOR",
  "AMB REF TO DUBIN PSYCHOLOGY",
  "AMB REF TO ENV & OCC MED (FPA ASTHMA PROG)",
  "AMB REF TO ESTHETICIAN",
  "AMB REF TO EXTERNAL BEHAVIORAL HEALTH (RAP NETWORK)",
  "AMB REF TO EXTERNAL DENTAL",
  "AMB REF TO EXTERNAL EARLY INTERVENTION",
  "AMB REF TO EXTERNAL OCCUPATIONAL THERAPY",
  "AMB REF TO EXTERNAL PHYSICAL THERAPY",
  "AMB REF TO EXTERNAL SPEECH THERAPY",
  "AMB REF TO FAMILY PLANNING",
  "AMB REF TO FETAL ECHO",
  "AMB REF TO FEU",
  "AMB REF TO FPA SELIKOFF OCCUPATIONAL HEALTH",
  "AMB REF TO FPA SOCIAL WORK",
  "AMB REF TO GASTROENTEROLOGY (FPA ASTHMA)",
  "AMB REF TO GERIATRIC PSYCHIATRY",
  "AMB REF TO GYNECOLOGY",
  "AMB REF TO HAND THERAPY",
  "AMB REF TO HOME PALLIATIVE CARE",
  "AMB REF TO HOME RADIOLOGY",
  "AMB REF TO HOSPICE CARE",
  "AMB REF TO IBD MALNUTRITION",
  "AMB REF TO IMA BEHAVIORAL HEALTH (DEPRESSION CARE + IMA PSYCH + IMA EVAL)",
  "AMB REF TO IMA DIABETES EDUCATOR",
  "AMB REF TO IMA LONG COVID CLINIC",
  "AMB REF TO IMA NEPHROLOGY",
  "AMB REF TO IMA NUTRITION",
  "AMB REF TO IMA PHARMACIST",
  "AMB REF TO INFERTILITY PRACTICE",
  "AMB REF TO INSTITUTE FOR LIVER MEDICINE NUTRITION",
  "AMB REF TO INTERVENTIONAL RADIOLOGY",
  "AMB REF TO INTESTINAL TRANSPLANT",
  "AMB REF TO JMF",
  "AMB REF TO JMF GYN",
  "AMB REF TO JMF NEUROLOGY",
  "AMB REF TO JMF PAIN MANAGEMENT",
  "AMB REF TO JMF PSYCHIATRY",
  "AMB REF TO JMF RENAL",
  "AMB REF TO JMFC",
  "AMB REF TO KIDNEY & PANCREAS TRANSPLANT",
  "AMB REF TO LEAP",
  "AMB REF TO LIGHTHOUSE OPHTHALMOLOGY",
  "AMB REF TO MASSAGE THERAPY",
  "AMB REF TO MENTAL HEALTH INITIAL",
  "AMB REF TO MFM",
  "AMB REF TO MFMA CONSULTATIVE SERVICES",
  "AMB REF TO MFMA EVALUATION UNIT",
  "AMB REF TO MOUNT SINAI FIT SMOKING CESSATION",
  "AMB REF TO MSD FOREST HILLS CARDIOMETABOLIC WELLNESS PROGRAM",
  "AMB REF TO MSH NETWORK CHF DISEASE MANAGEMENT PROGRAM",
  "AMB REF TO MSQ EXPRESS CARE",
  "AMB REF TO MSS TOTAL JOINT REPLACEMENT COE",
  "AMB REF TO MSSN DIABETES EDUCATION",
  "AMB REF TO MSSN PRE-OP CLEARANCE",
  "AMB REF TO NEURO BEHAVIORAL CLINIC",
  "AMB REF TO NEUROPHYS/PSYCH",
  "AMB REF TO NOOM",
  "AMB REF TO NURSING ADHERENCE VISIT",
  "AMB REF TO NUTRITION",
  "AMB REF TO NUTRITION CVI CLINIC",
  "AMB REF TO NYS SMOKING CESSATION",
  "AMB REF TO OB BOOKING",
  "AMB REF TO OCCUPATIONAL THERAPY",
  "AMB REF TO ONCOLOGY CLINICAL TRIALS",
  "AMB REF TO ONCOLOGY NUTRITION",
  "AMB REF TO ORTHOTICS",
  "AMB REF TO OTOLARYNGOLOGY",
  "AMB REF TO PACEMAKER CLINIC",
  "AMB REF TO PATHOLOGY",
  "AMB REF TO PEDIATRIC SOCIAL WORK/MENTAL HEALTH",
  "AMB REF TO PEDIATRICS ENVIRONMENTAL",
  "AMB REF TO PEDS ASTHMA FOLLOW UP",
  "AMB REF TO PEDS CHILD DEVELOP",
  "AMB REF TO PEDS CHILD/FAM SUP",
  "AMB REF TO PEDS DENTAL",
  "AMB REF TO PEDS EARLY INTER.",
  "AMB REF TO PEDS GENETICS",
  "AMB REF TO PEDS HEMATOLOGY",
  "AMB REF TO PEDS OCCUP THERAPY",
  "AMB REF TO PEDS PHYS THERAPY",
  "AMB REF TO PEDS PSYCHIATRY",
  "AMB REF TO PEDS PSYCHOLOGY",
  "AMB REF TO PEDS SPEECH THERAPY",
  "AMB REF TO PHARMACOGENETICS",
  "AMB REF TO PHARMACY",
  "AMB REF TO PHYSICAL THERAPY",
  "AMB REF TO PREP",
  "AMB REF TO PRE-PROCEDURE COVID-19 TESTING (ASYMPTOMATIC ONLY)",
  "AMB REF TO PRIMARY CARE_SPECIALTY USE ONLY",
  "AMB REF TO PROSTHETICS",
  "AMB REF TO PSYCHIATRY",
  "AMB REF TO PSYCHIATRY (FPA ASTHMA PROGRAM)",
  "AMB REF TO PSYCHIATRY (PAS ONLY)",
  "AMB REF TO PSYCHOLOGY",
  "AMB REF TO PULMONARY FUNCTION LAB",
  "AMB REF TO PULMONARY HYPERTENSION",
  "AMB REF TO RAD ONCOLOGY",
  "AMB REF TO RAINBOW CLINIC",
  "AMB REF TO REACH PROGRAM(FOR SUBSTANCE USE AND/OR HEPATITUS C TREATMENT",
  "AMB REF TO REGISTERED DIETICIAN",
  "AMB REF TO REHAB PHASE II",
  "AMB REF TO REHAB/MODIFIED BARIUM STUDY",
  "AMB REF TO RMA REPRODUCTIVE ENDOCRINOLOGY",
  "AMB REF TO RN-LED HTN MANAGEMENT CLINIC",
  "AMB REF TO SELIKOFF SMOKING CESSATION PROGRAM",
  "AMB REF TO SICKLE CELL",
  "AMB REF TO SOCIAL WORK",
  "AMB REF TO SPECIALTY SOCIAL WORK",
  "AMB REF TO SPEECH THERAPY",
  "AMB REF TO SPIRITUAL CARE",
  "AMB REF TO SPORTS CONCUSSION",
  "AMB REF TO SPORTS FELLOWSHIP",
  "AMB REF TO SUPPORTIVE CARDIOLOGY",
  "AMB REF TO SW FOR HIV COUNS/TEST",
  "AMB REF TO SW MH SERVICES",
  "AMB REF TO THORACIC DISEASES",
  "AMB REF TO TOP (EXTERNAL)",
  "AMB REF TO TRANSPLANT HBIG INFUSION",
  "AMB REF TO UPPER ENDOSCOPY",
  "AMB REF TO UROLOGY-INCONTINENCE",
  "AMB REF TO VIRTUAL MED MANAGEMENT",
  "AMB REF TO VISITING DOCTORS",
  "AMB REF TO VISITING NURSE SERVICE",
  "AMB REF TO VOCATIONAL THERAPY",
  "AMB REF TO WHEELCHAIR CLINIC",
  "AMB REF TO WOMEN, INFANT & CHILDREN'S FOOD SUPPLEMENT PROGRAM",
  "AMB REF TO WOMEN'S HEALTH FPA",
  "AMB REFERRAL TO PRECISION RECOVERY",
  "AMB REFERRAL TO VASCULAR ACCESS SERVICE",
  "AMBULATORY REFERRAL TO ED",
  "APPOINTMENT AFTER ECONSULT",
  "APRETUDE AUTHORIZATION REFERRAL",
  "CABENUVA AUTHORIZATION REFERRAL",
  "CARE MANAGEMENT REFERRAL FOR EXTERNAL SERVICES",
  "IP SOCIAL WORK CONSULT TO CORAM CVS/SPECIALTY INFUSION SERVICES",
  "MS AMB REF TO MIDI (EXTERNAL)",
  "MSSN SURGICAL BOOKING ORDER",
  "PHX REFERRAL TO LUNG TRANSPLANT",
  "REFERRAL NUCLEAR STRESS TEST"

)


```


```{r Referrals- Caboodle ReferralsDataView, echo = FALSE, warning = FALSE, message = FALSE}


referrals_mshs_baseline <- caboodle_referrals_conn %>%
  filter(!(ProcedureName %in% ref_exclude)) %>%
  filter(year(Creation_Date) == prior_year) %>%
  filter(ReceivedByDept != "*Unspecified") %>%
  filter(Status != "Denied") %>%
  filter(Class != "Outgoing") %>%
  mutate(start_year = year(Creation_Date),
         start_month = month(Creation_Date)) %>%
  group_by(start_year, start_month, TicketsSentToPatBy_X) %>%
  summarise(non_converted = n_distinct(ReferralEpicId[is.na(AppointmentStatus)]),
            scheduled = n_distinct(ReferralEpicId[!is.na(AppointmentStatus)]),
            completed = n_distinct(ReferralEpicId[AppointmentStatus %in% c("Arrived", "Completed")])) %>%
  collect() %>%
  mutate(TicketsSentToPatBy_X = ifelse(TicketsSentToPatBy_X=="", "None", TicketsSentToPatBy_X)) %>%
  pivot_wider(names_from = TicketsSentToPatBy_X,
              values_from = c("non_converted", "scheduled", "completed"),
              values_fill = 0) %>%
  rowwise() %>% 
  mutate(total_referrals = sum(c_across(contains("non_converted") | contains("scheduled"))),
         total_scheduled = sum(c_across(contains("scheduled"))),
         total_completed = sum(c_across(contains("completed"))),
         total_tkt_sent_scheduler = sum(c_across(contains("converted_scheduler") | contains("scheduled_scheduler"))),
         total_tkt_sent_automated = sum(c_across(contains("converted_Automated") | contains("scheduled_Automated"))),
         total_tkt_sent_both = sum(c_across(contains("converted_both") | contains("scheduled_both"))),
         total_tkt_sent = sum(total_tkt_sent_scheduler, total_tkt_sent_automated, total_tkt_sent_both)) %>%
  mutate(perc_conversion = total_scheduled/total_referrals,
         perc_completion = total_completed/total_referrals,
         perc_tkt_sent = total_tkt_sent/total_referrals,
         perc_tkt_sent_automated = total_tkt_sent_automated/total_referrals,
         perc_tkt_sent_scheduler = total_tkt_sent_scheduler/total_referrals,
         perc_tkt_sent_both = total_tkt_sent_both/total_referrals) %>%
  rename("Year" = start_year,
         "Month" = start_month)



referrals_mshs_ytd <- caboodle_referrals_conn %>%
  filter(!(ProcedureName %in% ref_exclude)) %>%
  filter(year(Creation_Date) == current_year) %>%
  filter(as.Date(Creation_Date) < as.Date(date_start)) %>%
  filter(ReceivedByDept != "*Unspecified") %>%
  filter(Status != "Denied") %>%
  filter(Class != "Outgoing") %>%
  mutate(start_year = year(Creation_Date),
         start_month = month(Creation_Date)) %>%
  group_by(start_year, start_month, TicketsSentToPatBy_X) %>%
  summarise(non_converted = n_distinct(ReferralEpicId[is.na(AppointmentStatus)]),
            scheduled = n_distinct(ReferralEpicId[!is.na(AppointmentStatus)]),
            completed = n_distinct(ReferralEpicId[AppointmentStatus %in% c("Arrived", "Completed")])) %>%
  collect() %>%
  mutate(TicketsSentToPatBy_X = ifelse(TicketsSentToPatBy_X=="", "None", TicketsSentToPatBy_X)) %>%
  pivot_wider(names_from = TicketsSentToPatBy_X,
              values_from = c("non_converted", "scheduled", "completed"),
              values_fill = 0) %>%
  rowwise() %>% 
  mutate(total_referrals = sum(c_across(contains("non_converted") | contains("scheduled"))),
         total_scheduled = sum(c_across(contains("scheduled"))),
         total_completed = sum(c_across(contains("completed"))),
         total_tkt_sent_scheduler = sum(c_across(contains("converted_scheduler") | contains("scheduled_scheduler"))),
         total_tkt_sent_automated = sum(c_across(contains("converted_Automated") | contains("scheduled_Automated"))),
         total_tkt_sent_both = sum(c_across(contains("converted_both") | contains("scheduled_both"))),
         total_tkt_sent = sum(total_tkt_sent_scheduler, total_tkt_sent_automated, total_tkt_sent_both)) %>%
  mutate(perc_conversion = total_scheduled/total_referrals,
         perc_completion = total_completed/total_referrals,
         perc_tkt_sent = total_tkt_sent/total_referrals,
         perc_tkt_sent_automated = total_tkt_sent_automated/total_referrals,
         perc_tkt_sent_scheduler = total_tkt_sent_scheduler/total_referrals,
         perc_tkt_sent_both = total_tkt_sent_both/total_referrals) %>%
  rename("Year" = start_year,
         "Month" = start_month)



referrals_dep <- caboodle_referrals_conn %>%
  filter(!(ProcedureName %in% ref_exclude)) %>%
  filter(year(Creation_Date) >= prior_year) %>%
  filter(as.Date(Creation_Date) < as.Date(date_start)) %>%
  filter(ReceivedByDept != "*Unspecified") %>%
  filter(Status != "Denied") %>%
  filter(Class != "Outgoing") %>%
  mutate(start_year = year(Creation_Date),
         start_month = month(Creation_Date)) %>%
  group_by(ReceivedByDept, ReceivedByDepID, start_year, start_month, TicketsSentToPatBy_X) %>%
  summarise(non_converted = n_distinct(ReferralEpicId[is.na(AppointmentStatus)]),
            scheduled = n_distinct(ReferralEpicId[!is.na(AppointmentStatus)]),
            completed = n_distinct(ReferralEpicId[AppointmentStatus %in% c("Arrived", "Completed")])) %>%
  collect() %>%
  mutate(TicketsSentToPatBy_X = ifelse(TicketsSentToPatBy_X=="", "None", TicketsSentToPatBy_X)) %>%
  pivot_wider(names_from = TicketsSentToPatBy_X,
              values_from = c("non_converted", "scheduled", "completed"),
              values_fill = 0) %>%
  rowwise() %>% 
  mutate(total_referrals = sum(c_across(contains("non_converted") | contains("scheduled"))),
         total_scheduled = sum(c_across(contains("scheduled"))),
         total_completed = sum(c_across(contains("completed"))),
         total_tkt_sent_scheduler = sum(c_across(contains("converted_scheduler") | contains("scheduled_scheduler"))),
         total_tkt_sent_automated = sum(c_across(contains("converted_Automated") | contains("scheduled_Automated"))),
         total_tkt_sent_both = sum(c_across(contains("converted_both") | contains("scheduled_both"))),
         total_tkt_sent = sum(total_tkt_sent_scheduler, total_tkt_sent_automated, total_tkt_sent_both)) %>%
  mutate(perc_conversion = total_scheduled/total_referrals,
         perc_completion = total_completed/total_referrals,
         perc_tkt_sent = total_tkt_sent/total_referrals,
         perc_tkt_sent_automated = total_tkt_sent_automated/total_referrals,
         perc_tkt_sent_scheduler = total_tkt_sent_scheduler/total_referrals,
         perc_tkt_sent_both = total_tkt_sent_both/total_referrals) %>%
  rename("DEPARTMENT_NAME" =  ReceivedByDept,
         "DEPARTMENT_ID" = ReceivedByDepID,
         "Year" = start_year,
         "Month" = start_month)



referrals_prov <- caboodle_referrals_conn %>%
  filter(!(ProcedureName %in% ref_exclude)) %>%
  filter(year(Creation_Date) >= prior_year) %>%
  filter(as.Date(Creation_Date) < as.Date(date_start)) %>%
  filter(ReceivedByDept != "*Unspecified") %>%
  filter(Status != "Denied") %>%
  filter(Class != "Outgoing") %>%
  mutate(start_year = year(Creation_Date),
         start_month = month(Creation_Date)) %>%
  group_by(ReceivedByDept, ReceivedByDepID, ReceivedByProvNPI, ReceivedByProvider, start_year, start_month, TicketsSentToPatBy_X) %>%
  summarise(non_converted = n_distinct(ReferralEpicId[is.na(AppointmentStatus)]),
            scheduled = n_distinct(ReferralEpicId[!is.na(AppointmentStatus)]),
            completed = n_distinct(ReferralEpicId[AppointmentStatus %in% c("Arrived", "Completed")])) %>%
  collect() %>%
  mutate(TicketsSentToPatBy_X = ifelse(TicketsSentToPatBy_X=="", "None", TicketsSentToPatBy_X)) %>%
  pivot_wider(names_from = TicketsSentToPatBy_X,
              values_from = c("non_converted", "scheduled", "completed"),
              values_fill = 0) %>%
  rowwise() %>% 
  mutate(total_referrals = sum(c_across(contains("non_converted") | contains("scheduled"))),
         total_scheduled = sum(c_across(contains("scheduled"))),
         total_completed = sum(c_across(contains("completed"))),
         total_tkt_sent_scheduler = sum(c_across(contains("converted_scheduler") | contains("scheduled_scheduler"))),
         total_tkt_sent_automated = sum(c_across(contains("converted_Automated") | contains("scheduled_Automated"))),
         total_tkt_sent_both = sum(c_across(contains("converted_both") | contains("scheduled_both"))),
         total_tkt_sent = sum(total_tkt_sent_scheduler, total_tkt_sent_automated, total_tkt_sent_both)) %>%
  mutate(perc_conversion = total_scheduled/total_referrals,
         perc_completion = total_completed/total_referrals,
         perc_tkt_sent = total_tkt_sent/total_referrals,
         perc_tkt_sent_automated = total_tkt_sent_automated/total_referrals,
         perc_tkt_sent_scheduler = total_tkt_sent_scheduler/total_referrals,
         perc_tkt_sent_both = total_tkt_sent_both/total_referrals) %>%
  rename("DEPARTMENT_NAME" =  ReceivedByDept,
         "DEPARTMENT_ID" = ReceivedByDepID,
         "Year" = start_year,
         "Month" = start_month) %>%
  left_join(clarity_ser_2 %>%
              dplyr::select(NPI, PROV_ID) %>%
              collect() %>%
              filter(!is.na(NPI)),
            by = c("ReceivedByProvNPI" = "NPI")) %>%
  left_join(clarity_ser %>%
              dplyr::select(PROV_TYPE, PROV_ID, PROV_NAME) %>%
              collect(),
            by = c("PROV_ID")) 



# referral_check <- caboodle_referrals %>%
#   mutate(start_year = year(Creation_Date),
#          start_month = month(Creation_Date)) %>%
#   filter(start_year == 2024) %>%
#   filter(start_month == 12) %>%
#   filter(ReceivedByProvider == "MORSE, DANIEL CLAYTON") %>%
#   group_by(ReceivedBySite, ReceivedByDept, ReceivedByDepID, ReceivedByProvNPI, ReceivedByProvider, ReferralEpicId, AppointmentStatus, TicketsSentToPatBy_X) %>%
#   summarise(total = n()) %>%
#     collect()

```


```{r Online Appointments, echo = FALSE, warning = FALSE, message = FALSE}

appt_online <- access_raw_tbl %>%
  # left_join(clarity_ser_tbl %>% select(PROV_ID, PROV_TYPE)) %>%
  # filter(PROV_TYPE == "Physician") %>%

  filter(!is.na(SITE)) %>%
  filter(SITE %in% c("MSUS", "MSH- AMBULATORY CARE", "NETWORK", "MSW", "MSH-MSDFP",
                     "MSDMG", "MSB", "MSM", "MSQ", "MSBI", "MSSN", "NYEE")) %>%
  mutate(lead_days = CONTACT_DATE - APPT_MADE_DATE) %>%
  mutate(cancel_lead_days = CONTACT_DATE - APPT_CANC_DATE) %>%
  # mutate(lead_days =  as.numeric(difftime(as.Date(APPT_MADE_DATE), as.Date(CONTACT_DATE), units = "days"))) %>%
  mutate(appt_status = ifelse(DERIVED_STATUS_DESC == "Canceled" & cancel_lead_days <=0, "SameDay_Canceled", DERIVED_STATUS_DESC)) %>%
  mutate(appt_year = year(CONTACT_DATE),
         appt_month = month(CONTACT_DATE)) %>%
  mutate(appt_made_year = year(APPT_MADE_DATE),
         appt_made_month = month(APPT_MADE_DATE)) %>%
  mutate(visit_type = ifelse(is.na(VISIT_GROUP_NUM), "ESTABLISHED", "NEW")) %>%
  mutate(lead_14days = ifelse(lead_days <= 14, "lead_14days", "lead_14days_more")) %>%
  mutate(SPECIALTY_GRP = ifelse(DEPT_SPECIALTY_NAME %in% 
                                  c("Adolescent Medicine", "Community and Preventive Medicine", 
                                    "Family Medicine", "Internal Medicine", "Pediatrics", "Geriatrics", "Gerontology", "Urgent Care"), "Primary Care", "Specialty")) %>%

  filter(year(APPT_MADE_DATE) >= prior_year) %>%
  filter(APPT_MADE_DATE < TO_DATE(date_start, "YYYY-MM-DD HH24:MI:SS")) %>%
  left_join(f_sched_appt_tbl %>%
              dplyr::select(PAT_ENC_CSN_ID, COULD_DIR_SCHED_C, COULD_OPEN_SCHED_C, COULD_TKT_SCHED_C, APPT_SCHED_SOURCE_C, PAT_ONLINE_YN)) %>%
  group_by(SITE, SPECIALTY_GRP, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, DEPARTMENT_ID, appt_made_year, appt_made_month,
           COULD_DIR_SCHED_C, COULD_OPEN_SCHED_C, COULD_TKT_SCHED_C, APPT_SCHED_SOURCE_C, APPT_SCHED_SOURCE, DERIVED_STATUS_DESC, SCHED_METHOD, PAT_ONLINE_YN, WALK_IN_YN) %>%
  summarise(total = n()) %>%
  collect()


appt_online <- appt_online %>%
  filter(!is.na(COULD_DIR_SCHED_C) | !is.na(COULD_OPEN_SCHED_C) | !is.na(COULD_TKT_SCHED_C)) %>%
  filter(!(COULD_DIR_SCHED_C %in% c(13) & COULD_OPEN_SCHED_C %in% c(13) & COULD_TKT_SCHED_C %in% c(13))) %>%
  mutate(COULD_DIR_SCHED = ifelse(COULD_DIR_SCHED_C %in% c(11), 1, 0),
         COULD_OPEN_SCHED = ifelse(COULD_OPEN_SCHED_C %in% c(11), 1, 0),
         COULD_TKT_SCHED = ifelse(COULD_TKT_SCHED_C %in% c(11), 1, 0)) %>%
  mutate(avail_online_exclude = ifelse(APPT_SCHED_SOURCE_C %in% c(27, 28, 33, 34), "Y", "N")) %>%
  # mutate(avail_online = ifelse((COULD_DIR_SCHED + COULD_OPEN_SCHED + COULD_TKT_SCHED)>0, "Y", "N")) %>%
  # mutate(sched_online = ifelse((avail_online == "Y" & WALK_IN_YN == "N" & PAT_ONLINE_YN == "Y"), "Y", "N")) %>%
  mutate(avail_online = ifelse((COULD_DIR_SCHED + COULD_OPEN_SCHED + COULD_TKT_SCHED)>0, "avail_Y", "avail_N")) %>%
  mutate(sched_online = ifelse((avail_online == "avail_Y" & WALK_IN_YN == "N" & PAT_ONLINE_YN == "Y"), "sched_Y", "sched_N"))



appt_avail_online_mshs_baseline <- appt_online %>%
  filter(appt_made_year == prior_year) %>%
  filter(avail_online_exclude == "N") %>%
  group_by(appt_made_year, appt_made_month, avail_online, sched_online) %>%
  summarise(appts_sched = sum(total, na.rm = T))  %>%
  pivot_wider(names_from = c("avail_online", "sched_online"),
              values_from = appts_sched,
              values_fill = 0) %>%
  mutate(perc_avail_online = (avail_Y_sched_N + avail_Y_sched_Y) / (avail_N_sched_N + avail_Y_sched_N + avail_Y_sched_Y),
         perc_sched_online = (avail_Y_sched_Y) / (avail_N_sched_N + avail_Y_sched_N + avail_Y_sched_Y)) %>%
         # perc_sched_online = (avail_Y_sched_Y) / (avail_Y_sched_Y + avail_Y_sched_N)) %>%
  rename("Year" = appt_made_year,
         "Month" = appt_made_month)


appt_avail_online_mshs_ytd <- appt_online %>%
  filter(appt_made_year == current_year) %>%
  filter(avail_online_exclude == "N") %>%
  group_by(appt_made_year, appt_made_month, avail_online, sched_online) %>%
  summarise(appts_sched = sum(total, na.rm = T))  %>%
  pivot_wider(names_from = c("avail_online", "sched_online"),
              values_from = appts_sched,
              values_fill = 0) %>%
  mutate(perc_avail_online = (avail_Y_sched_N + avail_Y_sched_Y) / (avail_N_sched_N + avail_Y_sched_N + avail_Y_sched_Y),
         perc_sched_online = (avail_Y_sched_Y) / (avail_N_sched_N + avail_Y_sched_N + avail_Y_sched_Y)) %>%
         # perc_sched_online = (avail_Y_sched_Y) / (avail_Y_sched_Y + avail_Y_sched_N)) %>%
  rename("Year" = appt_made_year,
         "Month" = appt_made_month)


appt_avail_online_dep <- appt_online %>%
  filter(avail_online_exclude == "N") %>%
  group_by(SITE, SPECIALTY_GRP, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, DEPARTMENT_ID, appt_made_year, appt_made_month, avail_online, sched_online) %>%
  summarise(appts_sched = sum(total, na.rm = T))  %>%
  pivot_wider(names_from = c("avail_online", "sched_online"),
              values_from = appts_sched,
              values_fill = 0) %>%
  mutate(perc_avail_online = (avail_Y_sched_N + avail_Y_sched_Y) / (avail_N_sched_N + avail_Y_sched_N + avail_Y_sched_Y),
         perc_sched_online = (avail_Y_sched_Y) / (avail_N_sched_N + avail_Y_sched_N + avail_Y_sched_Y)) %>%
         # perc_sched_online = (avail_Y_sched_Y) / (avail_Y_sched_Y + avail_Y_sched_N)) %>%
  rename("Year" = appt_made_year,
         "Month" = appt_made_month)

```


```{r Online Appointments Provider, echo = FALSE, warning = FALSE, message = FALSE}

appt_online_prov <- access_raw_tbl %>%
  left_join(clarity_ser_tbl %>% select(PROV_ID, PROV_TYPE, PROV_NAME)) %>%
  # filter(PROV_TYPE == "Physician") %>%

  filter(!is.na(SITE)) %>%
  filter(SITE %in% c("MSUS", "MSH- AMBULATORY CARE", "NETWORK", "MSW", "MSH-MSDFP",
                     "MSDMG", "MSB", "MSM", "MSQ", "MSBI", "MSSN", "NYEE")) %>%
  mutate(lead_days = CONTACT_DATE - APPT_MADE_DATE) %>%
  mutate(cancel_lead_days = CONTACT_DATE - APPT_CANC_DATE) %>%
  # mutate(lead_days =  as.numeric(difftime(as.Date(APPT_MADE_DATE), as.Date(CONTACT_DATE), units = "days"))) %>%
  mutate(appt_status = ifelse(DERIVED_STATUS_DESC == "Canceled" & cancel_lead_days <=0, "SameDay_Canceled", DERIVED_STATUS_DESC)) %>%
  mutate(appt_year = year(CONTACT_DATE),
         appt_month = month(CONTACT_DATE)) %>%
  mutate(appt_made_year = year(APPT_MADE_DATE),
         appt_made_month = month(APPT_MADE_DATE)) %>%
  mutate(visit_type = ifelse(is.na(VISIT_GROUP_NUM), "ESTABLISHED", "NEW")) %>%
  mutate(lead_14days = ifelse(lead_days <= 14, "lead_14days", "lead_14days_more")) %>%
  mutate(SPECIALTY_GRP = ifelse(DEPT_SPECIALTY_NAME %in% 
                                  c("Adolescent Medicine", "Community and Preventive Medicine", 
                                    "Family Medicine", "Internal Medicine", "Pediatrics", "Geriatrics", "Gerontology", "Urgent Care"), "Primary Care", "Specialty")) %>%

  filter(year(APPT_MADE_DATE) >= prior_year) %>%
  filter(APPT_MADE_DATE < TO_DATE(date_start, "YYYY-MM-DD HH24:MI:SS")) %>%
  left_join(f_sched_appt_tbl %>%
              dplyr::select(PAT_ENC_CSN_ID, COULD_DIR_SCHED_C, COULD_OPEN_SCHED_C, COULD_TKT_SCHED_C, APPT_SCHED_SOURCE_C, PAT_ONLINE_YN)) %>%
  group_by(SITE, SPECIALTY_GRP, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, DEPARTMENT_ID, PROV_ID, PROV_TYPE, PROV_NAME,
           appt_made_year, appt_made_month,
           COULD_DIR_SCHED_C, COULD_OPEN_SCHED_C, COULD_TKT_SCHED_C, APPT_SCHED_SOURCE_C, APPT_SCHED_SOURCE, DERIVED_STATUS_DESC, SCHED_METHOD, PAT_ONLINE_YN, WALK_IN_YN) %>%
  summarise(total = n()) %>%
  collect()


appt_online_prov <- appt_online_prov %>%
  filter(!is.na(COULD_DIR_SCHED_C) | !is.na(COULD_OPEN_SCHED_C) | !is.na(COULD_TKT_SCHED_C)) %>%
  filter(!(COULD_DIR_SCHED_C %in% c(13) & COULD_OPEN_SCHED_C %in% c(13) & COULD_TKT_SCHED_C %in% c(13))) %>%
  mutate(COULD_DIR_SCHED = ifelse(COULD_DIR_SCHED_C %in% c(11), 1, 0),
         COULD_OPEN_SCHED = ifelse(COULD_OPEN_SCHED_C %in% c(11), 1, 0),
         COULD_TKT_SCHED = ifelse(COULD_TKT_SCHED_C %in% c(11), 1, 0)) %>%
  mutate(avail_online_exclude = ifelse(APPT_SCHED_SOURCE_C %in% c(27, 28, 33, 34), "Y", "N")) %>%
  # mutate(avail_online = ifelse((COULD_DIR_SCHED + COULD_OPEN_SCHED + COULD_TKT_SCHED)>0, "Y", "N")) %>%
  # mutate(sched_online = ifelse((avail_online == "Y" & WALK_IN_YN == "N" & PAT_ONLINE_YN == "Y"), "Y", "N")) %>%
  mutate(avail_online = ifelse((COULD_DIR_SCHED + COULD_OPEN_SCHED + COULD_TKT_SCHED)>0, "avail_Y", "avail_N")) %>%
  mutate(sched_online = ifelse((avail_online == "avail_Y" & WALK_IN_YN == "N" & PAT_ONLINE_YN == "Y"), "sched_Y", "sched_N"))


appt_avail_online_prov <- appt_online_prov %>%
  filter(avail_online_exclude == "N") %>%
  group_by(SITE, SPECIALTY_GRP, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, DEPARTMENT_ID, PROV_ID, PROV_TYPE, PROV_NAME,
           appt_made_year, appt_made_month, avail_online, sched_online) %>%
  summarise(appts_sched = sum(total, na.rm = T))  %>%
  pivot_wider(names_from = c("avail_online", "sched_online"),
              values_from = appts_sched,
              values_fill = 0) %>%
  mutate(perc_avail_online = (avail_Y_sched_N + avail_Y_sched_Y) / (avail_N_sched_N + avail_Y_sched_N + avail_Y_sched_Y),
         perc_sched_online = (avail_Y_sched_Y) / (avail_N_sched_N + avail_Y_sched_N + avail_Y_sched_Y)) %>%
         # perc_sched_online = (avail_Y_sched_Y) / (avail_Y_sched_Y + avail_Y_sched_N)) %>%
  rename("Year" = appt_made_year,
         "Month" = appt_made_month)

```


```{r Department Data Merged}

department_merged <- merge(slot_util_dep, no_show_dep, all = T)
department_merged <- merge(department_merged, new_pt_ratio_dep, all = T)
department_merged <- merge(department_merged, new_pt_waitTime_dep, all = T)
department_merged <- merge(department_merged, new_pt_ratio_dep, all = T)
department_merged <- merge(department_merged, appt_avail_online_dep, all = T)
department_merged <- merge(department_merged, referrals_dep, all = T)
department_merged <- merge(department_merged, payer_mix_dep, all = T)
department_merged <- merge(department_merged, waitTime_payer_mix_dep, all = T)

department_merged <- department_merged %>%
  mutate(Year = as.character(Year),
         Month = as.character(Month)) %>%
  mutate(across(where(is.numeric), ~replace(., is.na(.), 0))) %>%
  mutate(`Year-Month` = paste0(Year,"-",Month)) %>%
  rename("Specialty" = DEPT_SPECIALTY_NAME,
         "Specialty Type" = SPECIALTY_GRP) 


# Referral Conversion and Completion of Tickets Sent
department_merged <- department_merged %>%
  mutate(perc_conversion_None = (scheduled_None/(non_converted_None + scheduled_None)),
         perc_conversion_Automated = (scheduled_Automated/(non_converted_Automated + scheduled_Automated)),
         perc_conversion_Scheduler = (scheduled_Scheduler/(non_converted_Scheduler + scheduled_Scheduler)),
         perc_conversion_Both = (scheduled_Both/(non_converted_Both + scheduled_Both)),
         # Payer Mix
         # perc_mcr_hmo = (MEDICARE_HMO_ESTABLISHED_LOS + MEDICARE_HMO_NEW_LOS)/Arrived,
         perc_mcr = (MEDICARE_ESTABLISHED_LOS + MEDICARE_NEW_LOS + MEDICARE_HMO_ESTABLISHED_LOS + MEDICARE_HMO_NEW_LOS)/Arrived,
         # perc_mcd_hmo = (MEDICAID_HMO_ESTABLISHED_LOS + MEDICAID_HMO_NEW_LOS)/Arrived,
         perc_mcd = (MEDICAID_ESTABLISHED_LOS + MEDICAID_NEW_LOS + MEDICAID_HMO_ESTABLISHED_LOS + MEDICAID_HMO_NEW_LOS)/Arrived,
         perc_commercial = (COMMERCIAL_MANAGED_CARE_ESTABLISHED_LOS + COMMERCIAL_MANAGED_CARE_NEW_LOS)/Arrived,
         perc_self = (SELF_PAY_ESTABLISHED_LOS + SELF_PAY_NEW_LOS)/Arrived,
         perc_other = (OTHER_ESTABLISHED_LOS + OTHER_NEW_LOS)/Arrived,
         perc_no_coverage = (NO_COVERAGE_ASSIGNED_ESTABLISHED_LOS + NO_COVERAGE_ASSIGNED_NEW_LOS)/Arrived,
         # Wait Time by Payer 
         perc_new_lead_14days_mcr = (MEDICARE_NEW_lead_14days + MEDICARE_HMO_NEW_lead_14days)/
           (MEDICARE_NEW_lead_14days + MEDICARE_NEW_lead_14days_more + MEDICARE_HMO_NEW_lead_14days + MEDICARE_HMO_NEW_lead_14days_more),
         perc_est_lead_14days_mcr = (MEDICARE_ESTABLISHED_lead_14days + MEDICARE_HMO_ESTABLISHED_lead_14days)/
           (MEDICARE_ESTABLISHED_lead_14days + MEDICARE_ESTABLISHED_lead_14days_more + MEDICARE_HMO_ESTABLISHED_lead_14days + MEDICARE_HMO_ESTABLISHED_lead_14days_more),
         perc_new_lead_14days_mcd = (MEDICAID_NEW_lead_14days + MEDICAID_HMO_NEW_lead_14days)/
           (MEDICAID_NEW_lead_14days + MEDICAID_NEW_lead_14days_more + MEDICAID_HMO_NEW_lead_14days + MEDICAID_HMO_NEW_lead_14days_more),
         perc_est_lead_14days_mcd = (MEDICAID_ESTABLISHED_lead_14days + MEDICAID_HMO_ESTABLISHED_lead_14days)/
           (MEDICAID_ESTABLISHED_lead_14days + MEDICAID_ESTABLISHED_lead_14days_more + MEDICAID_HMO_ESTABLISHED_lead_14days + MEDICAID_HMO_ESTABLISHED_lead_14days_more),
         perc_new_lead_14days_commercial = COMMERCIAL_MANAGED_CARE_NEW_lead_14days/
           (COMMERCIAL_MANAGED_CARE_NEW_lead_14days + COMMERCIAL_MANAGED_CARE_NEW_lead_14days_more),
         perc_est_lead_14days_commercial = COMMERCIAL_MANAGED_CARE_ESTABLISHED_lead_14days/
           (COMMERCIAL_MANAGED_CARE_ESTABLISHED_lead_14days + COMMERCIAL_MANAGED_CARE_ESTABLISHED_lead_14days_more),
         )


# require(openxlsx)
# write.xlsx(department_merged, "department_merged_org_041725.xlsx")

```



```{r Provider Data Merged}

provider_merged <- merge(slot_util_prov, no_show_prov, all = T)
provider_merged <- merge(provider_merged, new_pt_ratio_prov, all = T)
provider_merged <- merge(provider_merged, new_pt_waitTime_prov, all = T)
provider_merged <- merge(provider_merged, new_pt_ratio_prov, all = T)
provider_merged <- merge(provider_merged, appt_avail_online_prov, all = T)
provider_merged <- merge(provider_merged, referrals_prov, all = T)
provider_merged <- merge(provider_merged, payer_mix_prov, all = T)
provider_merged <- merge(provider_merged, waitTime_payer_mix_prov, all = T)


provider_merged <- provider_merged %>%
  mutate(Year = as.character(Year),
         Month = as.character(Month)) %>%
  mutate(across(where(is.numeric), ~replace(., is.na(.), 0))) %>%
  mutate(`Year-Month` = paste0(Year,"-",Month)) %>%
  rename("Specialty" = DEPT_SPECIALTY_NAME,
         "Specialty Type" = SPECIALTY_GRP) 


# Referral Conversion and Completion of Tickets Sent
provider_merged <- provider_merged %>%
  mutate(perc_conversion_None = (scheduled_None/(non_converted_None + scheduled_None)),
         perc_conversion_Automated = (scheduled_Automated/(non_converted_Automated + scheduled_Automated)),
         perc_conversion_Scheduler = (scheduled_Scheduler/(non_converted_Scheduler + scheduled_Scheduler)),
         perc_conversion_Both = (scheduled_Both/(non_converted_Both + scheduled_Both)),
         # Payer Mix
         # perc_mcr_hmo = (MEDICARE_HMO_ESTABLISHED_LOS + MEDICARE_HMO_NEW_LOS)/Arrived,
         perc_mcr = (MEDICARE_ESTABLISHED_LOS + MEDICARE_NEW_LOS + MEDICARE_HMO_ESTABLISHED_LOS + MEDICARE_HMO_NEW_LOS)/Arrived,
         # perc_mcd_hmo = (MEDICAID_HMO_ESTABLISHED_LOS + MEDICAID_HMO_NEW_LOS)/Arrived,
         perc_mcd = (MEDICAID_ESTABLISHED_LOS + MEDICAID_NEW_LOS + MEDICAID_HMO_ESTABLISHED_LOS + MEDICAID_HMO_NEW_LOS)/Arrived,
         perc_commercial = (COMMERCIAL_MANAGED_CARE_ESTABLISHED_LOS + COMMERCIAL_MANAGED_CARE_NEW_LOS)/Arrived,
         perc_self = (SELF_PAY_ESTABLISHED_LOS + SELF_PAY_NEW_LOS)/Arrived,
         perc_other = (OTHER_ESTABLISHED_LOS + OTHER_NEW_LOS)/Arrived,
         perc_no_coverage = (NO_COVERAGE_ASSIGNED_ESTABLISHED_LOS + NO_COVERAGE_ASSIGNED_NEW_LOS)/Arrived,
         # Wait Time by Payer 
         perc_new_lead_14days_mcr = (MEDICARE_NEW_lead_14days + MEDICARE_HMO_NEW_lead_14days)/
           (MEDICARE_NEW_lead_14days + MEDICARE_NEW_lead_14days_more + MEDICARE_HMO_NEW_lead_14days + MEDICARE_HMO_NEW_lead_14days_more),
         perc_est_lead_14days_mcr = (MEDICARE_ESTABLISHED_lead_14days + MEDICARE_HMO_ESTABLISHED_lead_14days)/
           (MEDICARE_ESTABLISHED_lead_14days + MEDICARE_ESTABLISHED_lead_14days_more + MEDICARE_HMO_ESTABLISHED_lead_14days + MEDICARE_HMO_ESTABLISHED_lead_14days_more),
         perc_new_lead_14days_mcd = (MEDICAID_NEW_lead_14days + MEDICAID_HMO_NEW_lead_14days)/
           (MEDICAID_NEW_lead_14days + MEDICAID_NEW_lead_14days_more + MEDICAID_HMO_NEW_lead_14days + MEDICAID_HMO_NEW_lead_14days_more),
         perc_est_lead_14days_mcd = (MEDICAID_ESTABLISHED_lead_14days + MEDICAID_HMO_ESTABLISHED_lead_14days)/
           (MEDICAID_ESTABLISHED_lead_14days + MEDICAID_ESTABLISHED_lead_14days_more + MEDICAID_HMO_ESTABLISHED_lead_14days + MEDICAID_HMO_ESTABLISHED_lead_14days_more),
         perc_new_lead_14days_commercial = COMMERCIAL_MANAGED_CARE_NEW_lead_14days/
           (COMMERCIAL_MANAGED_CARE_NEW_lead_14days + COMMERCIAL_MANAGED_CARE_NEW_lead_14days_more),
         perc_est_lead_14days_commercial = COMMERCIAL_MANAGED_CARE_ESTABLISHED_lead_14days/
           (COMMERCIAL_MANAGED_CARE_ESTABLISHED_lead_14days + COMMERCIAL_MANAGED_CARE_ESTABLISHED_lead_14days_more),
         )


# require(openxlsx)
# write.xlsx(provider_merged, "Metric Overview by Provider_042325.xlsx")

```



```{r Executive Scorecard Data Pull}

# site_merged <- department_merged %>%
#   group_by(SITE, Year, Month) %>%
#   summarise(`Referral Volume` = sum(total_referrals, na.rm = T),
#             `Referrals Scheduled` = sum(total_scheduled, na.rm = T),
#             `Referral Conversion Rate`= round(`Referrals Scheduled`/`Referral Volume`,2),
#             `Appts Scheduled Online` = sum(avail_Y_sched_Y, na.rm = T),
#             `Appts Available for Online Scheduling` = sum(avail_N_sched_N, avail_Y_sched_N, avail_Y_sched_Y, na.rm = T),
#             `Percent Appts Scheduled Online` = round(`Appts Scheduled Online`/`Appts Available for Online Scheduling`, 2)) %>%
#   filter(!(Year == 2025 & Month == 4))
# 
# 
# require(openxlsx)
# write.xlsx(site_merged, "Executive Scorecard Ambulatory Metrics_041425.xlsx")

  
```




```{r 2025 ROI Overview, echo=FALSE, out.width = '15%'}

# Target 2025
# access_target <- data.frame(
#   Month = c(rep(seq(1:12),4)),
#   metric_name = c(rep("prov_util",12), rep("perc_noShowPlus",12), rep("Arrived",12), rep("perc_conversion",12)),
#   accenture_target_low = c(rep(0.85,12), rep(0.10,12), rep(0.01,12), rep(0.61,12)),
#   accenture_target_high = c(rep(0.9,12), rep(0.07,12), rep(0.02,12), rep(0.63,12)),
#   mshs_target = c(rep(0.7,12), rep(0.12,12), rep(0.01,12), rep(0.60,12)),
#   mshs_budget_impact = c(rep(4000000/12,12), rep(2000000/12,12), rep(1000000/12,12), rep(1000000/12,12))
# )


access_target <- data.frame(
  Month = c(rep(seq(1:12),3)),
  metric_name = c(rep("prov_util",12), rep("perc_noShowPlus",12), rep("perc_conversion",12)),
  accenture_target_low = c(rep(0.85,12), rep(0.10,12), rep(0.61,12)),
  accenture_target_high = c(rep(0.9,12), rep(0.07,12), rep(0.63,12)),
  mshs_target = c(rep(0.7,12), rep(0.12,12), rep(0.60,12)),
  mshs_budget_impact = c(rep(4000000/12,12), rep(2000000/12,12), rep(1000000/12,12))
)

access_target <- access_target %>%
  pivot_wider(names_from = metric_name,
              values_from = 3:length(access_target),
              names_glue = "{metric_name}_{.value}") 

# Prior Year Baseline Metrics
mshs_merged_baseline <- merge(slot_util_mshs_baseline, no_show_mshs_baseline, all = T)
mshs_merged_baseline <- merge(mshs_merged_baseline, new_pt_ratio_mshs_baseline, all = T)
mshs_merged_baseline <- merge(mshs_merged_baseline, new_pt_waitTime_mshs_baseline, all = T)
mshs_merged_baseline <- merge(mshs_merged_baseline, appt_avail_online_mshs_baseline, all = T)
mshs_merged_baseline <- merge(mshs_merged_baseline, referrals_mshs_baseline, all = T)

mshs_merged_baseline <- mshs_merged_baseline %>%
  mutate(Year = "prior_year") %>%
  pivot_wider(names_from = Year,
              values_from = 3:length(mshs_merged_baseline))


# Current YTD Metrics 
mshs_merged_ytd <- merge(slot_util_mshs_ytd, no_show_mshs_ytd, all = T)
mshs_merged_ytd <- merge(mshs_merged_ytd, new_pt_ratio_mshs_ytd, all = T)
mshs_merged_ytd <- merge(mshs_merged_ytd, new_pt_waitTime_mshs_ytd, all = T)
mshs_merged_ytd <- merge(mshs_merged_ytd, appt_avail_online_mshs_ytd, all = T)
mshs_merged_ytd <- merge(mshs_merged_ytd, referrals_mshs_ytd, all = T)


# MSHS ROI 
mshs_roi <- merge(mshs_merged_ytd, mshs_merged_baseline, by = "Month", all = T)
mshs_roi <- left_join(mshs_roi, access_target)



mshs_roi <- mshs_roi %>%
  mutate(prov_util_var_baseline= (prov_util - prov_util_prior_year),
         prov_util_actualized= ifelse((prov_util - prov_util_prior_year) >0, (prov_util - prov_util_prior_year)*avail_hours, 0),
         prov_util_actualized_budget= prov_util_actualized*110,
         perc_noShowPlus_var_target= (perc_noShowPlus - perc_noShowPlus_mshs_target),
         perc_conversion_var_target = (perc_conversion - perc_conversion_mshs_target)
         # Arrived_var_baseline = (Arrived - Arrived_prior_year)/Arrived_prior_year,
         ) %>%
  mutate(Year = current_year)
  
```


```{r YTD ROI Overview, echo=FALSE, out.width = '15%'}

# Template Utilization
# No Show 
# New PT
# Referrals
## Conversion, Completion
## automated Ticket

#Ticket Scheduling
##% of providers ticket scheduling enabled?
##52% automated in tickets
##end of Q2 - we should have 6-7 specialties (decision tree lite?)
#Late-releasing

# mshs_merged_ytd <- merge(slot_util_mshs_ytd, no_show_mshs_ytd, all = T)
# mshs_merged_ytd <- merge(mshs_merged_ytd, new_pt_ratio_mshs_ytd, all = T)
# mshs_merged_ytd <- merge(mshs_merged_ytd, new_pt_waitTime_mshs_ytd, all = T)
# mshs_merged_ytd <- merge(mshs_merged_ytd, appt_avail_online_mshs_ytd, all = T)
# mshs_merged_ytd <- merge(mshs_merged_ytd, referrals_mshs_ytd, all = T)
# 
# 
# mshs_merged_baseline_tbl <- mshs_merged_baseline %>%
#   dplyr::select(Arrived, perc_noShowPlus, perc_conversion, perc_avail_online, perc_sched_online) %>%
#   pivot_longer(Arrived:perc_sched_online,
#                names_to = "metric_name",
#                values_to = "baseline_value")
# 
# 
# 
# mshs_merged_baseline <- mshs_merged_baseline %>%
#   mutate(Year = as.character(Year),
#          Month = as.character(Month)) %>%
#   mutate(across(where(is.numeric), ~replace(., is.na(.), 0))) %>%
#   mutate(`Year-Month` = paste0(Year,"-",Month)) %>%
#   pivot_longer(avail_hours:perc_tkt_sent_both,
#                names_to = "metric_name",
#                values_to = "value_name") %>%
#   filter(metric_name %in% c("avail_hours",))
# 
# 
# metric_target_2024 <- data.frame(
#   metric_name = c("BMW", "TOYOTA", "HONDA"),
#   accenture_target = c(),
#   metric_target_2025 = c(),
#   metric_impact_2025 = c()
# )

```


```{r Accenture Data Request, echo=FALSE, out.width = '15%'}

# visits_enabled_volume <- access_raw_tbl %>%
#   filter(!is.na(SITE)) %>%
#   filter(SITE %in% c("MSUS", "MSH- AMBULATORY CARE", "NETWORK", "MSW", "MSH-MSDFP",
#                      "MSDMG", "MSB", "MSM", "MSQ", "MSBI", "MSSN", "NYEE")) %>%
#   mutate(lead_days = CONTACT_DATE - APPT_MADE_DATE) %>%
#   mutate(cancel_lead_days = CONTACT_DATE - APPT_CANC_DATE) %>%
#   # mutate(lead_days =  as.numeric(difftime(as.Date(APPT_MADE_DATE), as.Date(CONTACT_DATE), units = "days"))) %>%
#   mutate(appt_status = ifelse(DERIVED_STATUS_DESC == "Canceled" & cancel_lead_days <=0, "SameDay_Canceled", DERIVED_STATUS_DESC)) %>%
#   mutate(appt_year = year(CONTACT_DATE),
#          appt_month = month(CONTACT_DATE)) %>%
#   mutate(appt_made_year = year(APPT_MADE_DATE),
#          appt_made_month = month(APPT_MADE_DATE)) %>%
#   mutate(visit_type = ifelse(is.na(VISIT_GROUP_NUM), "ESTABLISHED", "NEW")) %>%
#   mutate(lead_14days = ifelse(lead_days <= 14, "lead_14days", "lead_14days_more")) %>%
# 
#   filter(year(APPT_MADE_DATE) == prior_year) %>%
#   # filter(APPT_MADE_DATE < TO_DATE(date_start, "YYYY-MM-DD HH24:MI:SS")) %>%
#   left_join(f_sched_appt_tbl %>%
#               dplyr::select(PAT_ENC_CSN_ID, COULD_DIR_SCHED_C, COULD_OPEN_SCHED_C, COULD_TKT_SCHED_C, APPT_SCHED_SOURCE_C, PAT_ONLINE_YN)) %>%
#   left_join(clarity_ser_tbl %>%
#               dplyr::select(PROV_ID, PROV_NAME, PROV_TYPE)) %>%
#   group_by(SITE, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, DEPARTMENT_ID, PROV_ID, PROV_NAME, PROV_TYPE, VISIT_PROV_STAFF_RESOURCE_C, appt_made_year, appt_made_month,
#            PRC_NAME, SAME_DAY_YN, visit_type, COULD_DIR_SCHED_C, COULD_OPEN_SCHED_C, COULD_TKT_SCHED_C, APPT_SCHED_SOURCE_C, APPT_SCHED_SOURCE, appt_status, SCHED_METHOD, PAT_ONLINE_YN, WALK_IN_YN) %>%
#   summarise(total = n()) %>%
#   collect()
# 
# visits_enabled_volume_summary <- visits_enabled_volume %>%
#   mutate(COULD_DIR_SCHED = ifelse(COULD_DIR_SCHED_C %in% c(11), "Y", "N"),
#          COULD_OPEN_SCHED = ifelse(COULD_OPEN_SCHED_C %in% c(11), "Y", "N"),
#          COULD_TKT_SCHED = ifelse(COULD_TKT_SCHED_C %in% c(11), "Y", "N")) %>%
#   mutate(scheduling_channel = case_when(PAT_ONLINE_YN == "Y" ~ "Self-Service Portal",
#                                         str_detect(SCHED_METHOD, "Access Center") ~ "Access Center",
#                                         TRUE ~ "Practice")) %>%
#   mutate(VISIT_PROV_STAFF_RESOURCE = case_when(VISIT_PROV_STAFF_RESOURCE_C == 1 ~ "Provider",
#                                        VISIT_PROV_STAFF_RESOURCE_C == 2 ~ "Resource",
#                                        TRUE ~ " ")) %>%
#   group_by(PROV_NAME, PROV_ID, PROV_TYPE, VISIT_PROV_STAFF_RESOURCE, SITE, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, DEPARTMENT_ID, PRC_NAME, SAME_DAY_YN, visit_type,
#            COULD_DIR_SCHED, COULD_OPEN_SCHED, COULD_TKT_SCHED, scheduling_channel) %>%
#   summarise(total_appts_scheduled = sum(total, na.rm = T),
#             total_appts_scheduled_show = sum(total[appt_status %in% c("Arrived", "No Show", "SameDay_Canceled")], na.rm = T),
#             total_appts_arrived = sum(total[appt_status == "Arrived"], na.rm = T))
# 
# 
# require(openxlsx)
# write.xlsx(visits_enabled_volume_summary, "Accenture_Visits Enabled and Volume_2024.xlsx")
# 
# 
# no_shows <- access_raw_tbl %>%
#   filter(!is.na(SITE)) %>%
#   filter(SITE %in% c("MSUS", "MSH- AMBULATORY CARE", "NETWORK", "MSW", "MSH-MSDFP",
#                      "MSDMG", "MSB", "MSM", "MSQ", "MSBI", "MSSN", "NYEE")) %>%
#   mutate(lead_days = CONTACT_DATE - APPT_MADE_DATE) %>%
#   mutate(cancel_lead_days = CONTACT_DATE - APPT_CANC_DATE) %>%
#   # mutate(lead_days =  as.numeric(difftime(as.Date(APPT_MADE_DATE), as.Date(CONTACT_DATE), units = "days"))) %>%
#   mutate(appt_status = ifelse(DERIVED_STATUS_DESC == "Canceled" & cancel_lead_days <=0, "SameDay_Canceled", DERIVED_STATUS_DESC)) %>%
#   mutate(appt_year = year(CONTACT_DATE),
#          appt_month = month(CONTACT_DATE)) %>%
#   mutate(appt_made_year = year(APPT_MADE_DATE),
#          appt_made_month = month(APPT_MADE_DATE)) %>%
#   mutate(visit_type = ifelse(is.na(VISIT_GROUP_NUM), "ESTABLISHED", "NEW")) %>%
#   mutate(lead_14days = ifelse(lead_days <= 14, "lead_14days", "lead_14days_more")) %>%
# 
#   filter(year(CONTACT_DATE) == prior_year) %>%
#   filter(month(CONTACT_DATE) >= 10) %>%
#   # filter(APPT_MADE_DATE < TO_DATE(date_start, "YYYY-MM-DD HH24:MI:SS")) %>%
#   left_join(f_sched_appt_tbl %>%
#               dplyr::select(PAT_ENC_CSN_ID, COULD_DIR_SCHED_C, COULD_OPEN_SCHED_C, COULD_TKT_SCHED_C, APPT_SCHED_SOURCE_C, PAT_ONLINE_YN)) %>%
#   left_join(clarity_ser_tbl %>%
#               dplyr::select(PROV_ID, PROV_NAME, PROV_TYPE)) %>%
#   group_by(SITE, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, DEPARTMENT_ID, PROV_ID, PROV_NAME, PROV_TYPE, VISIT_PROV_STAFF_RESOURCE_C, appt_year, appt_month,
#            PRC_NAME, SAME_DAY_YN, visit_type, COULD_DIR_SCHED_C, COULD_OPEN_SCHED_C, COULD_TKT_SCHED_C, APPT_SCHED_SOURCE_C, APPT_SCHED_SOURCE, appt_status, SCHED_METHOD, PAT_ONLINE_YN, WALK_IN_YN) %>%
#   summarise(total = n()) %>%
#   collect()
# 
# 
# no_shows_summary <- no_shows %>%
#   group_by(PAT_ONLINE_YN, appt_status) %>%
#   summarise(total = sum(total, na.rm=T)) %>%
#   pivot_wider(names_from = appt_status, 
#               values_from = total) %>%
#   adorn_totals("row") %>%
#   rowwise() %>%
#   mutate(perc_noShow = round((`No Show` + SameDay_Canceled)/(Arrived + `No Show` + SameDay_Canceled),3))
#   

```


```{r Sinai Logo, echo=FALSE, out.width = '15%'}
knitr::include_graphics("Mount_Sinai_Logo_H.png")
```


# Metrics Overview {.tabset .tabset-fade .tabset-pills}
*Report run date: `r report_run_date`*<br/>
*Excludes templates with provider utilization <30% & >150% per month*<br/>
*Excludes MSH-Ambulatory Care Templates from Jan-May 2024*<br/>
______________________________________________________________________________________________________________________________
<br/>
<br/>


<!-- ## Access Workstream ROI -->
<!-- ```{r Accenture Workstream ROI, echo = FALSE, warning = FALSE, message = FALSE} -->


<!-- # htmltools::browsable( -->
<!-- #   tagList( -->
<!-- #     tags$button( -->
<!-- #       tagList(fontawesome::fa("download"), "Download Table"), -->
<!-- #       onclick = "Reactable.downloadDataCSV('new-pt-waitTime', 'New Patient Wait Time')" -->
<!-- #     ), -->

<!-- # htmltools::browsable( -->
<!-- #   tagList( -->
<!-- #     div(tags$label("Summary by", `for` = "access-roi")), -->
<!-- #     tags$select( -->
<!-- #       id = "access-roi", -->
<!-- #       onchange = "Reactable.setGroupBy('access-metrics', this.value ? [this.value] : [])", -->
<!-- #       tags$option("None", value = ""), -->
<!-- #       lapply(c("Year", "Month"), tags$option) -->
<!-- #     ), -->
<!-- #  -->
<!-- #     tags$hr("aria-hidden" = "true"), -->

<!-- reactable( -->
<!--   mshs_roi, -->
<!--   elementId = "access-roi", -->
<!--   # elementId = "referral-vol-download-table", -->
<!--   style = list(fontFamily = 'Calibri', -->
<!--                  fontSize = '14px'), -->
<!--     defaultColDef = colDef(align = "left", -->
<!--                            headerStyle = list(fontWeight = "Bold", fontSize = "14px"), -->
<!--                            headerClass = "bar-sort-header"), -->
<!--   # RowStyle = function(index) { -->
<!--   #           if (index %in% c(nrow(referral_vol_site_data_mshs))) { -->
<!--   #             list(`border-top` = "2px solid rgb(184,184,184)", -->
<!--   #                  fontWeight = "Bold") -->
<!--   #           } -->
<!--   #         }, -->
<!--     highlight = TRUE, -->
<!--     # filterable = TRUE, -->
<!--     pagination = FALSE, -->
<!--     # height = 800, -->
<!--     wrap = TRUE, -->
<!--   searchable = TRUE, -->

<!--   groupBy = c("Year"), -->

<!--   columnGroups = list( -->
<!--     colGroup(name = "", columns = c("Year", "Month"), -->
<!--              headerStyle = list(color = "black", fontSize = "15px"), -->
<!--              sticky = "left"), -->
<!--     colGroup(name = paste0("C.1.1 - C.1.3 Estimated Impact: Provider Utilization"), -->
<!--              columns = c("avail_hours_prior_year", "avail_hours", "sched_util", "sched_util_prior_year", -->
<!--                          "prov_util_prior_year", "prov_util", "prov_util_var_baseline", "prov_util_actualized_budget"), -->
<!--              headerStyle = list(background = "#212070", color = "white", fontSize = "15px")), -->
<!--     colGroup(name = paste0("C.1.1 No Show & Same-Day Cancel Reduction"), -->
<!--              columns = c("perc_noShowPlus_prior_year", "perc_noShowPlus", "perc_noShowPlus_mshs_target", "perc_noShowPlus_var_target", -->
<!--                          "perc_noShowPlus_mshs_budget_impact"), -->
<!--              headerStyle = list(background = "#d80b8c", color = "white", fontSize = "15px")), -->
<!--     # colGroup(name = paste0("C.1.2 Visit Volume Growth"), -->
<!--     #          columns = c("Arrived_prior_year", "Arrived", "Arrived_mshs_target", "Arrived_var_target"), -->
<!--     #          headerStyle = list(background = "#212070", color = "white", fontSize = "15px")), -->
<!--     colGroup(name = paste0("C.1.3 Referral Retention"), -->
<!--              columns = c("perc_conversion_prior_year", "perc_conversion", "perc_conversion_mshs_target", "perc_conversion_var_target"), -->
<!--              headerStyle = list(background = "#00aeef", color = "white", fontSize = "15px")) -->
<!--     ), -->

<!--   columns = list( -->

<!--     Year = colDef( -->
<!--       maxWidth = 100), -->

<!--     Month = colDef( -->
<!--       maxWidth = 120), -->

<!--     avail_hours_prior_year = colDef( -->
<!--       name = "2024 Available Hours", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       # Calculate the aggregate conversion rate as `(total-pending) / total` -->
<!--       aggregate = 'sum', -->
<!--       format = colFormat(separators = TRUE, digits = 0) -->
<!--     ), -->

<!--     avail_hours = colDef( -->
<!--       name = "2025 Available Hours", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       # Calculate the aggregate conversion rate as `(total-pending) / total` -->
<!--       aggregate = 'sum', -->
<!--       format = colFormat(separators = TRUE, digits = 0) -->
<!--     ), -->

<!--     # arrived_hours = colDef( -->
<!--     #   name = "2025 Arrived Hours", -->
<!--     #   maxWidth = 100, -->
<!--     #   headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--     #   # Calculate the aggregate conversion rate as `(total-pending) / total` -->
<!--     #   aggregate = 'sum', -->
<!--     #   format = colFormat(separators = TRUE, digits = 0) -->
<!--     # ), -->

<!--     sched_util_prior_year = colDef( -->
<!--       name = "2024 Sched Util", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       # Calculate the aggregate conversion rate as `(total-pending) / total` -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalavail_hours_prior_year = 0 -->
<!--         let totalsched_hours_prior_year = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalavail_hours_prior_year += row['avail_hours_prior_year'] -->
<!--           totalsched_hours_prior_year += row['sched_hours_prior_year'] -->
<!--         }) -->
<!--         return (totalsched_hours_prior_year) / (totalavail_hours_prior_year) || '-' -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1) -->
<!--     ), -->

<!--     sched_util= colDef( -->
<!--       name = "2025 Sched Util", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       # Calculate the aggregate conversion rate as `(total-pending) / total` -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalavail_hours = 0 -->
<!--         let totalsched_hours = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalavail_hours += row['avail_hours'] -->
<!--           totalsched_hours += row['sched_hours'] -->
<!--         }) -->
<!--         return (totalsched_hours) / (totalavail_hours) || '-' -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1) -->
<!--     ), -->

<!--     prov_util_prior_year = colDef( -->
<!--       name = "2024 Prov Util", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       # Calculate the aggregate conversion rate as `(total-pending) / total` -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalavail_hours_prior_year = 0 -->
<!--         let totalarrived_hours_prior_year = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalavail_hours_prior_year += row['avail_hours_prior_year'] -->
<!--           totalarrived_hours_prior_year += row['arrived_hours_prior_year'] -->
<!--         }) -->
<!--         return (totalarrived_hours_prior_year) / (totalavail_hours_prior_year) || '-' -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1) -->
<!--     ), -->

<!--     prov_util= colDef( -->
<!--       name = "2025 Prov Util", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       # Calculate the aggregate conversion rate as `(total-pending) / total` -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalavail_hours = 0 -->
<!--         let totalarrived_hours = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalavail_hours += row['avail_hours'] -->
<!--           totalarrived_hours += row['arrived_hours'] -->
<!--         }) -->
<!--         return (totalarrived_hours) / (totalavail_hours) || '-' -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1) -->
<!--     ), -->

<!--     prov_util_var_baseline = colDef( -->
<!--       name = "Variance to 2024 Prov Util", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       # Calculate the aggregate conversion rate as `(total-pending) / total` -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalavail_hours = 0 -->
<!--         let totalarrived_hours = 0 -->
<!--         let totalavail_hours_prior_year = 0 -->
<!--         let totalarrived_hours_prior_year = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalavail_hours += row['avail_hours'] -->
<!--           totalarrived_hours += row['arrived_hours'] -->
<!--           totalavail_hours_prior_year += row['avail_hours_prior_year'] -->
<!--           totalarrived_hours_prior_year += row['arrived_hours_prior_year'] -->
<!--         }) -->
<!--         return (totalarrived_hours/totalavail_hours) - (totalarrived_hours_prior_year/totalavail_hours_prior_year) || '-' -->
<!--       }"), -->
<!--       style = JS("function(rowInfo) { -->
<!--         var value = rowInfo.row['prov_util_var_baseline'] -->
<!--         if (value >= 0) { -->
<!--           var color = '#008000' -->
<!--         } else if (value < 0.12) { -->
<!--           var color = '#e00000' -->
<!--         } else { -->
<!--           var color = '#000000' -->
<!--         } -->
<!--         return { color: color, fontFamily: 'calibri', fontWeight: 'bold'} -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1) -->
<!--     ), -->

<!--      prov_util_actualized_budget = colDef( -->
<!--       name = "Estimated Revenue Impact*", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       # Calculate the aggregate conversion rate as `(total-pending) / total` -->
<!--       aggregate = 'sum', -->
<!--       format = colFormat(prefix = "$", separators = TRUE, digits = 0) -->
<!--     ), -->

<!--     perc_noShowPlus_prior_year = colDef( -->
<!--       name = "2024 Baseline", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalArrived_prior_year = 0 -->
<!--         let totalNo_Show_prior_year = 0 -->
<!--         let totalSameDay_Canceled_prior_year = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalArrived_prior_year += row['Arrived_prior_year'] -->
<!--           totalNo_Show_prior_year += row['No_Show_prior_year'] -->
<!--           totalSameDay_Canceled_prior_year += row['SameDay_Canceled_prior_year'] -->
<!--         }) -->
<!--         return (totalNo_Show_prior_year + totalSameDay_Canceled_prior_year) / (totalArrived_prior_year + totalNo_Show_prior_year + totalSameDay_Canceled_prior_year) || '-' -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1)), -->

<!--     perc_noShowPlus = colDef( -->
<!--       name = "2025 YTD", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalArrived = 0 -->
<!--         let totalNo_Show = 0 -->
<!--         let totalSameDay_Canceled = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalArrived += row['Arrived'] -->
<!--           totalNo_Show += row['No_Show'] -->
<!--           totalSameDay_Canceled += row['SameDay_Canceled'] -->
<!--         }) -->
<!--         return (totalNo_Show + totalSameDay_Canceled) / (totalArrived + totalNo_Show + totalSameDay_Canceled) || '-' -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1)), -->

<!--     perc_noShowPlus_mshs_target = colDef( -->
<!--       name = "2025 Target", -->
<!--       aggregate = "max", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       format = colFormat(percent = TRUE, digits = 1)), -->

<!--     perc_noShowPlus_var_target = colDef( -->
<!--       name = "Variance to 2025 Target", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalArrived = 0 -->
<!--         let totalNo_Show = 0 -->
<!--         let totalSameDay_Canceled = 0 -->
<!--         let totalperc_noShowPlus_mshs_target = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalArrived += row['Arrived'] -->
<!--           totalNo_Show += row['No_Show'] -->
<!--           totalSameDay_Canceled += row['SameDay_Canceled'] -->
<!--           totalperc_noShowPlus_mshs_target += row['perc_noShowPlus_mshs_target'] -->
<!--         }) -->
<!--         return ((totalNo_Show + totalSameDay_Canceled) / (totalArrived + totalNo_Show + totalSameDay_Canceled))-.12 || '-' -->
<!--       }"), -->
<!--       style = JS("function(rowInfo) { -->
<!--         var value = rowInfo.row['perc_noShowPlus_var_target'] -->
<!--         if (value > 0) { -->
<!--           var color = '#e00000' -->
<!--         } else if (value < 0.12) { -->
<!--           var color = '#008000' -->
<!--         } else { -->
<!--           var color = '#000000' -->
<!--         } -->
<!--         return { color: color, fontFamily: 'calibri', fontWeight: 'bold'} -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1)), -->

<!--     perc_conversion_prior_year = colDef( -->
<!--       name = "2024 Baseline", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totaltotal_referrals_prior_year = 0 -->
<!--         let totaltotal_scheduled_prior_year = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totaltotal_referrals_prior_year += row['total_referrals_prior_year'] -->
<!--           totaltotal_scheduled_prior_year += row['total_scheduled_prior_year'] -->
<!--         }) -->
<!--         return (totaltotal_scheduled_prior_year) / (totaltotal_referrals_prior_year) -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1)), -->

<!--     perc_conversion = colDef( -->
<!--       name = "2025 YTD", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totaltotal_referrals = 0 -->
<!--         let totaltotal_scheduled = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totaltotal_referrals += row['total_referrals'] -->
<!--           totaltotal_scheduled += row['total_scheduled'] -->
<!--         }) -->
<!--         return (totaltotal_scheduled) / (totaltotal_referrals) || '-' -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1)), -->

<!--     perc_conversion_mshs_target = colDef( -->
<!--       name = "2025 Target", -->
<!--       aggregate = "max", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       format = colFormat(percent = TRUE, digits = 1)), -->

<!--     perc_conversion_var_target = colDef( -->
<!--       name = "Variance to 2025 Target", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totaltotal_referrals = 0 -->
<!--         let totaltotal_scheduled = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totaltotal_referrals += row['total_referrals'] -->
<!--           totaltotal_scheduled += row['total_scheduled'] -->
<!--         }) -->
<!--         return ((totaltotal_scheduled) / (totaltotal_referrals)) -.60 || '-' -->
<!--       }"), -->
<!--       style = JS("function(rowInfo) { -->
<!--         var value = rowInfo.row['perc_conversion_var_target'] -->
<!--         if (value >= 0) { -->
<!--           var color = '#008000' -->
<!--         } else if (value < 0.12) { -->
<!--           var color = '#e00000' -->
<!--         } else { -->
<!--           var color = '#000000' -->
<!--         } -->
<!--         return { color: color, fontFamily: 'calibri', fontWeight: 'bold'} -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1)), -->








<!--     # total_referrals = colDef( -->
<!--     #   name = "2025 Referral Volume", -->
<!--     #   aggregate = "sum", -->
<!--     #   maxWidth = 100, -->
<!--     #   headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--     #   format = colFormat(percent = TRUE, digits = 1)), -->
<!--     #  -->
<!--     # total_referrals_prior_year = colDef( -->
<!--     #   name = "2024 Referral Volume", -->
<!--     #   aggregate = "sum", -->
<!--     #   maxWidth = 100, -->
<!--     #   headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--     #   format = colFormat(percent = TRUE, digits = 1)), -->
<!--     #  -->
<!--     # perc_conversion_mshs_target = colDef( -->
<!--     #   name = "2025 Target", -->
<!--     #   aggregate = "max", -->
<!--     #   maxWidth = 100, -->
<!--     #   headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--     #   format = colFormat(percent = TRUE, digits = 1)), -->
<!--     #  -->
<!--     # perc_conversion_mshs_impact = colDef( -->
<!--     #   name = "2025 Target Impact", -->
<!--     #   aggregate = "sum", -->
<!--     #   maxWidth = 100, -->
<!--     #   headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--     #   format = colFormat(prefix = "$", separators = TRUE, digits = 0)), -->
<!--     #  -->
<!--     # perc_conversion_prior_year = colDef( -->
<!--     #   name = "2024 Baseline", -->
<!--     #   maxWidth = 100, -->
<!--     #   headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--     #   aggregate = JS("function(values, rows) { -->
<!--     #     let totaltotal_referrals_prior_year = 0 -->
<!--     #     let totaltotal_scheduled_prior_year = 0 -->
<!--     #     rows.forEach(function(row) { -->
<!--     #       totaltotal_referrals_prior_year += row['total_referrals_prior_year'] -->
<!--     #       totaltotal_scheduled_prior_year += row['total_scheduled_prior_year'] -->
<!--     #     }) -->
<!--     #     return (totaltotal_scheduled_prior_year) / (totaltotal_referrals_prior_year) -->
<!--     #   }"), -->
<!--     #   format = colFormat(percent = TRUE, digits = 1)), -->
<!--     #  -->
<!--     # perc_conversion = colDef( -->
<!--     #   name = "2025 YTD", -->
<!--     #   maxWidth = 100, -->
<!--     #   headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--     #   aggregate = JS("function(values, rows) { -->
<!--     #     let totaltotal_referrals = 0 -->
<!--     #     let totaltotal_scheduled = 0 -->
<!--     #     rows.forEach(function(row) { -->
<!--     #       totaltotal_referrals += row['total_referrals'] -->
<!--     #       totaltotal_scheduled += row['total_scheduled'] -->
<!--     #     }) -->
<!--     #     return (totaltotal_scheduled) / (totaltotal_referrals) -->
<!--     #   }"), -->
<!--     #   format = colFormat(percent = TRUE, digits = 1)), -->
<!--     #  -->
<!--     # conversion_actual = colDef( -->
<!--     #   name = "2025 YTD Impact", -->
<!--     #   aggregate = "sum", -->
<!--     #   maxWidth = 100, -->
<!--     #   headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--     #   format = colFormat(prefix = "$", separators = TRUE, digits = 0)), -->
<!--     #  -->
<!--     # conversion_budget_actualized = colDef( -->
<!--     #   name = "2025 Target Impact Actualized", -->
<!--     #   maxWidth = 100, -->
<!--     #   headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--     #   aggregate = JS("function(values, rows) { -->
<!--     #     let totalconversion_actual = 0 -->
<!--     #     let totalperc_conversion_mshs_impact = 0 -->
<!--     #     rows.forEach(function(row) { -->
<!--     #       totalconversion_actual += row['conversion_actual'] -->
<!--     #       totalperc_conversion_mshs_impact += row['perc_conversion_mshs_impact'] -->
<!--     #     }) -->
<!--     #     return (totalconversion_actual) / (totalperc_conversion_mshs_impact) || '-' -->
<!--     #   }"), -->
<!--     #   format = colFormat(percent = TRUE, digits = 1)), -->





<!--     avail_hours = colDef(show =F), -->
<!--     sched_hours = colDef(show =F), -->
<!--     arrived_hours = colDef(show =F), -->
<!--     sched_util = colDef(show =F), -->
<!--     prov_util = colDef(show =F), -->
<!--     Arrived = colDef(show =F), -->
<!--     SameDay_Canceled = colDef(show =F), -->
<!--     No_Show = colDef(show =F), -->
<!--     perc_noShow = colDef(show =F), -->
<!--     perc_SameDayCanceled = colDef(show =F), -->
<!--     NEW_LOS = colDef(show =F), -->
<!--     appts_arrived = colDef(show =F), -->
<!--     ESTABLISHED_LOS = colDef(show =F), -->
<!--     perc_new_los = colDef(show =F), -->
<!--     total_referrals = colDef(show =F), -->
<!--     total_scheduled = colDef(show =F), -->
<!--     total_completed = colDef(show =F), -->
<!--     perc_completion = colDef(show =F), -->
<!--     total_tkt_sent_automated = colDef(show =F), -->
<!--     total_tkt_sent_scheduler = colDef(show =F), -->
<!--     total_tkt_sent_both = colDef(show =F), -->
<!--     total_tkt_sent = colDef(show =F), -->
<!--     non_converted_None = colDef(show =F), -->
<!--     non_converted_Automated = colDef(show =F), -->
<!--     non_converted_Scheduler = colDef(show =F), -->
<!--     non_converted_Both = colDef(show =F), -->
<!--     scheduled_None = colDef(show =F), -->
<!--     scheduled_Automated = colDef(show =F), -->
<!--     scheduled_Scheduler = colDef(show =F), -->
<!--     scheduled_Both = colDef(show =F), -->
<!--     perc_tkt_sent = colDef(show =F), -->
<!--     perc_tkt_sent_automated = colDef(show =F), -->
<!--     perc_tkt_sent_scheduler = colDef(show =F), -->
<!--     perc_tkt_sent_both = colDef(show =F), -->
<!--     completed_None = colDef(show =F), -->
<!--     completed_Automated = colDef(show =F), -->
<!--     completed_Scheduler = colDef(show =F), -->
<!--     completed_Both = colDef(show =F), -->
<!--     ESTABLISHED = colDef(show =F), -->
<!--     NEW = colDef(show =F), -->
<!--     appts_scheduled = colDef(show =F), -->
<!--     perc_new = colDef(show =F), -->
<!--     NEW_lead_14days = colDef(show =F), -->
<!--     NEW_lead_14days_more = colDef(show =F), -->
<!--     NEW_appts_scheduled = colDef(show =F), -->
<!--     perc_new_lead_14days = colDef(show =F), -->
<!--     avail_N_sched_N = colDef(show =F), -->
<!--     avail_Y_sched_N = colDef(show =F), -->
<!--     avail_Y_sched_Y = colDef(show =F), -->
<!--     perc_avail_online = colDef(show =F), -->
<!--     perc_sched_online = colDef(show =F), -->

<!--     avail_hours_prior_year = colDef(show =F), -->
<!--     sched_hours_prior_year = colDef(show =F), -->
<!--     arrived_hours_prior_year = colDef(show =F), -->
<!--     sched_util_prior_year = colDef(show =F), -->
<!--     prov_util_prior_year = colDef(show =F), -->
<!--     Arrived_prior_year = colDef(show =F), -->
<!--     SameDay_Canceled_prior_year = colDef(show =F), -->
<!--     No_Show_prior_year = colDef(show =F), -->
<!--     perc_noShow_prior_year = colDef(show =F), -->
<!--     perc_SameDayCanceled_prior_year = colDef(show =F), -->
<!--     NEW_LOS_prior_year = colDef(show =F), -->
<!--     appts_arrived_prior_year = colDef(show =F), -->
<!--     ESTABLISHED_LOS_prior_year = colDef(show =F), -->
<!--     perc_new_los_prior_year = colDef(show =F), -->
<!--     total_referrals_prior_year = colDef(show =F), -->
<!--     total_scheduled_prior_year = colDef(show =F), -->
<!--     total_completed_prior_year = colDef(show =F), -->
<!--     perc_completion_prior_year = colDef(show =F), -->
<!--     total_tkt_sent_automated_prior_year = colDef(show =F), -->
<!--     total_tkt_sent_scheduler_prior_year = colDef(show =F), -->
<!--     total_tkt_sent_both_prior_year = colDef(show =F), -->
<!--     total_tkt_sent_prior_year = colDef(show =F), -->
<!--     non_converted_None_prior_year = colDef(show =F), -->
<!--     non_converted_Automated_prior_year = colDef(show =F), -->
<!--     non_converted_Scheduler_prior_year = colDef(show =F), -->
<!--     non_converted_Both_prior_year = colDef(show =F), -->
<!--     scheduled_None_prior_year = colDef(show =F), -->
<!--     scheduled_Automated_prior_year = colDef(show =F), -->
<!--     scheduled_Scheduler_prior_year = colDef(show =F), -->
<!--     scheduled_Both_prior_year = colDef(show =F), -->
<!--     perc_tkt_sent_prior_year = colDef(show =F), -->
<!--     perc_tkt_sent_automated_prior_year = colDef(show =F), -->
<!--     perc_tkt_sent_scheduler_prior_year = colDef(show =F), -->
<!--     perc_tkt_sent_both_prior_year = colDef(show =F), -->
<!--     completed_None_prior_year = colDef(show =F), -->
<!--     completed_Automated_prior_year = colDef(show =F), -->
<!--     completed_Scheduler_prior_year = colDef(show =F), -->
<!--     completed_Both_prior_year = colDef(show =F), -->
<!--     ESTABLISHED_prior_year = colDef(show =F), -->
<!--     NEW_prior_year = colDef(show =F), -->
<!--     appts_scheduled_prior_year = colDef(show =F), -->
<!--     perc_new_prior_year = colDef(show =F), -->
<!--     NEW_lead_14days_prior_year = colDef(show =F), -->
<!--     NEW_lead_14days_more_prior_year = colDef(show =F), -->
<!--     NEW_appts_scheduled_prior_year = colDef(show =F), -->
<!--     perc_new_lead_14days_prior_year = colDef(show =F), -->
<!--     avail_N_sched_N_prior_year = colDef(show =F), -->
<!--     avail_Y_sched_N_prior_year = colDef(show =F), -->
<!--     avail_Y_sched_Y_prior_year = colDef(show =F), -->
<!--     perc_avail_online_prior_year = colDef(show =F), -->
<!--     perc_sched_online_prior_year = colDef(show =F), -->

<!--     perc_noShowPlus_accenture_target_low = colDef(show =F), -->
<!--     perc_conversion_accenture_target_low = colDef(show =F), -->
<!--     perc_noShowPlus_accenture_target_high = colDef(show =F), -->
<!--     perc_conversion_accenture_target_high = colDef(show =F), -->
<!--     prov_util_accenture_target_low = colDef(show =F), -->
<!--     Arrived_accenture_target_low = colDef(show =F), -->
<!--     prov_util_accenture_target_high = colDef(show =F), -->
<!--     Arrived_accenture_target_high = colDef(show =F), -->
<!--     prov_util_mshs_target = colDef(show =F), -->
<!--     prov_util_mshs_budget_impact = colDef(show =F), -->
<!--     Arrived_mshs_budget_impact = colDef(show =F),  -->
<!--     per_conversion_mshs_budget_impact = colDef(show =F), -->
<!--     perc_noShowPlus_mshs_budget_impact = colDef(show =F),  -->
<!--     perc_conversion_mshs_budget_impact = colDef(show =F),  -->
<!--     prov_util_actualized = colDef(show =F), -->

<!--     avail_hours_adj = colDef(show =F), -->
<!--     sched_util_adj = colDef(show =F), -->
<!--     prov_util_adj = colDef(show =F), -->
<!--     avail_hours_adj_prior_year = colDef(show =F), -->
<!--     sched_util_adj_prior_year = colDef(show =F), -->
<!--     prov_util_adj_prior_year = colDef(show =F) -->

<!--   ) # Close Columns -->

<!--   ) # Close Reactable -->
<!-- # ) # Close Taglist -->
<!-- # ) # Close htmltools -->

<!-- ``` -->
<!-- <br/> -->
<!-- <p style="font-size:10pt; font-style:italic">*Estimated Revenue Impact is calculated based on (2025 - 2024 Provider Utilization) X (2025 Available Hours) X (1 Hour per Visit) X ($110 per Visit)<p/><br/> -->
<!-- <br/> -->

<!-- ## Metrics by Department -->
<!-- ```{r By Department Output, echo = FALSE, warning = FALSE, message = FALSE} -->


<!-- htmltools::browsable( -->
<!--   tagList( -->
<!--     tags$button( -->
<!--       tagList(fontawesome::fa("download"), "Download Table"), -->
<!--       onclick = "Reactable.downloadDataCSV('access-metrics', 'Metric Overview by Department')" -->
<!--     ), -->

<!-- # htmltools::browsable( -->
<!-- #   tagList( -->
<!-- #     div(tags$label("Summary by", `for` = "access-metrics")), -->
<!-- #     tags$select( -->
<!-- #       id = "new-pt-waitTime", -->
<!-- #       onchange = "Reactable.setGroupBy('access-metrics', this.value ? [this.value] : [])", -->
<!-- #       tags$option("None", value = ""), -->
<!-- #       lapply(c("Year", "Year-Month", "SITE", "Specialty Type", "Specialty"), tags$option) -->
<!-- #     ), -->
<!-- # -->
<!-- #     tags$hr("aria-hidden" = "true"), -->
<!-- # -->
<!-- reactable( -->
<!--   department_merged, -->
<!--   elementId = "access-metrics", -->
<!--   # elementId = "referral-vol-download-table", -->
<!--   style = list(fontFamily = 'Calibri', -->
<!--                  fontSize = '14px'), -->
<!--     defaultColDef = colDef(align = "left", -->
<!--                            headerStyle = list(fontWeight = "Bold", fontSize = "14px"), -->
<!--                            headerClass = "bar-sort-header"), -->
<!--   # RowStyle = function(index) { -->
<!--   #           if (index %in% c(nrow(referral_vol_site_data_mshs))) { -->
<!--   #             list(`border-top` = "2px solid rgb(184,184,184)", -->
<!--   #                  fontWeight = "Bold") -->
<!--   #           } -->
<!--   #         }, -->
<!--     highlight = TRUE, -->
<!--     filterable = TRUE, -->
<!--     pagination = FALSE, -->
<!--     # height = 800, -->
<!--     wrap = TRUE, -->
<!--   searchable = TRUE, -->

<!--   groupBy = c("Year", "Year-Month", "SITE", "Specialty Type", "Specialty", "DEPARTMENT_NAME"), -->

<!--   columnGroups = list( -->
<!--     colGroup(name = "", columns = c("Year", "Year-Month", "SITE", "Specialty Type", "Specialty", "DEPARTMENT_NAME"), -->
<!--              headerStyle = list(color = "black", fontSize = "15px"), -->
<!--              sticky = "left"), -->
<!--     colGroup(name = paste0("Template Utilization (Physicians Only)"), -->
<!--              columns = c("avail_hours", "sched_util", "prov_util"), -->
<!--              headerStyle = list(background = "#212070", color = "white", fontSize = "15px")), -->
<!--     colGroup(name = paste0("No Show"), -->
<!--              columns = c("perc_noShowPlus"), -->
<!--              headerStyle = list(background = "#d80b8c", color = "white", fontSize = "15px")), -->
<!--     colGroup(name = paste0("New Patient Access"), -->
<!--              columns = c("perc_new_lead_14days", "perc_new_los"), -->
<!--              headerStyle = list(background = "#9E1A6D", color = "white", fontSize = "15px")), -->
<!--     colGroup(name = paste0("Referrals + Ticket Scheduling"), -->
<!--              columns = c("total_referrals", "total_scheduled", "perc_conversion", "perc_completion", -->
<!--                          "perc_tkt_sent", "perc_tkt_sent_automated", -->
<!--                          "perc_conversion_None", "perc_conversion_Automated", "perc_conversion_Scheduler", "perc_conversion_Both"), -->
<!--              headerStyle = list(background = "#00aeef", color = "white", fontSize = "15px")), -->
<!--     colGroup(name = paste0("Digital Scheduling"), -->
<!--              columns = c("perc_avail_online", "perc_sched_online"), -->
<!--              headerStyle = list(background = "#7f7f7f", color = "white", fontSize = "15px")), -->
<!--     colGroup(name = paste0("Payer Mix: Volume"), -->
<!--              columns = c("perc_mcr", "perc_mcd", "perc_commercial", "perc_self", "perc_other", "perc_no_coverage"), -->
<!--              headerStyle = list(background = "#7030a0", color = "white", fontSize = "15px")), -->
<!--     colGroup(name = paste0("Payer Mix: Established Patient Access"), -->
<!--              columns = c("perc_est_lead_14days_mcr", "perc_est_lead_14days_mcd", "perc_est_lead_14days_commercial"), -->
<!--              headerStyle = list(background = "#ffcc00", color = "white", fontSize = "15px")), -->
<!--     colGroup(name = paste0("Payer Mix: New Patient Access"), -->
<!--              columns = c("perc_new_lead_14days_mcr", "perc_new_lead_14days_mcd", "perc_new_lead_14days_commercial"), -->
<!--              headerStyle = list(background = "#cca300", color = "white", fontSize = "15px")) -->
<!--     ), -->

<!--   columns = list( -->

<!--     Year = colDef( -->
<!--       maxWidth = 100), -->

<!--     `Year-Month` = colDef( -->
<!--       maxWidth = 220), -->

<!--     SITE = colDef( -->
<!--       # footer = "Total", -->
<!--       name = "Site", -->
<!--       maxWidth = 150), -->

<!--     `Specialty Type` = colDef( -->
<!--       name = "Specialty Type*", -->
<!--       maxWidth = 150), -->

<!--     Specialty = colDef( -->
<!--       maxWidth = 230), -->

<!--     DEPARTMENT_NAME = colDef( -->
<!--       name = "Department", -->
<!--       maxWidth = 230), -->

<!--     avail_hours = colDef( -->
<!--       name = "Available Hrs", -->
<!--       aggregate = "sum", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       format = colFormat(separators = TRUE, digits = 0)), -->

<!--     sched_util = colDef( -->
<!--       name = "Schedule Utilization", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       # Calculate the aggregate conversion rate as `(total-pending) / total` -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalsched_hours = 0 -->
<!--         let totalavail_hours = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalsched_hours+= row['sched_hours'] -->
<!--           totalavail_hours += row['avail_hours'] -->
<!--         }) -->
<!--         return (totalsched_hours) / (totalavail_hours) || '-' -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 0) -->
<!--     ), -->

<!--     prov_util = colDef( -->
<!--       name = "Provider Utilization", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       # Calculate the aggregate conversion rate as `(total-pending) / total` -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalavail_hours = 0 -->
<!--         let totalarrived_hours = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalavail_hours += row['avail_hours'] -->
<!--           totalarrived_hours += row['arrived_hours'] -->
<!--         }) -->
<!--         return (totalarrived_hours) / (totalavail_hours) || '-' -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 0) -->
<!--     ), -->

<!--     perc_noShowPlus = colDef( -->
<!--       name = "No Show Plus Rate", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       # Calculate the aggregate conversion rate as `(total-pending) / total` -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalArrived = 0 -->
<!--         let totalNo_Show = 0 -->
<!--         let totalSameDay_Canceled = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalArrived += row['Arrived'] -->
<!--           totalNo_Show += row['No_Show'] -->
<!--           totalSameDay_Canceled += row['SameDay_Canceled'] -->
<!--         }) -->
<!--         return (totalNo_Show + totalSameDay_Canceled) / (totalArrived + totalNo_Show + totalSameDay_Canceled) || '-' -->
<!--       }"), -->
<!--       style = JS("function(rowInfo) { -->
<!--         var value = rowInfo.row['perc_noShowPlus'] -->
<!--         if (value >= 0.12) { -->
<!--           var color = '#e00000' -->
<!--         } else if (value < 0.12) { -->
<!--           var color = '#008000' -->
<!--         } else { -->
<!--           var color = '#000000' -->
<!--         } -->
<!--         return { color: color, fontFamily: 'calibri', fontWeight: 'bold'} -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1) -->
<!--     ), -->

<!--     perc_new_lead_14days = colDef( -->
<!--       name = "% New Scheduled within 14 Days", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#9E1A6D", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       # Calculate the aggregate conversion rate as `(total-pending) / total` -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalNEW_lead_14days = 0 -->
<!--         let totalNEW_appts_scheduled = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalNEW_lead_14days += row['NEW_lead_14days'] -->
<!--           totalNEW_appts_scheduled += row['NEW_appts_scheduled'] -->
<!--         }) -->
<!--         return (totalNEW_lead_14days) / (totalNEW_appts_scheduled) || '-' -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1) -->
<!--     ), -->

<!--     perc_new_los = colDef( -->
<!--       name = "New Patient Ratio*", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#9E1A6D", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       # Calculate the aggregate conversion rate as `(total-pending) / total` -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalNEW_LOS = 0 -->
<!--         let totalESTABLISHED_LOS = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalNEW_LOS += row['NEW_LOS'] -->
<!--           totalESTABLISHED_LOS += row['ESTABLISHED_LOS'] -->
<!--         }) -->
<!--         return (totalNEW_LOS) / (totalNEW_LOS + totalESTABLISHED_LOS) || '-' -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1) -->
<!--     ), -->

<!--     total_referrals = colDef( -->
<!--       name = "Total Referrals", -->
<!--       aggregate = "sum", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       format = colFormat(separators = TRUE, digits = 0)), -->

<!--     total_scheduled = colDef( -->
<!--       name = "Total Referrals Scheduled", -->
<!--       aggregate = "sum", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       format = colFormat(separators = TRUE, digits = 0)), -->

<!--     perc_conversion = colDef( -->
<!--       name = "Conversion Rate", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totaltotal_referrals = 0 -->
<!--         let totaltotal_scheduled = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totaltotal_referrals += row['total_referrals'] -->
<!--           totaltotal_scheduled += row['total_scheduled'] -->
<!--         }) -->
<!--         return (totaltotal_scheduled) / (totaltotal_referrals) || '-' -->
<!--       }"), -->
<!--       style = JS("function(rowInfo) { -->
<!--         var value = rowInfo.row['perc_conversion'] -->
<!--         if (value >= 0.60) { -->
<!--           var color = '#008000' -->
<!--         } else if (value < 0.60) { -->
<!--           var color = '#e00000' -->
<!--         } else { -->
<!--           var color = '#000000' -->
<!--         } -->
<!--         return { color: color, fontFamily: 'calibri', fontWeight: 'bold'} -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1) -->
<!--     ), -->

<!--     perc_completion = colDef( -->
<!--       name = "Completion Rate", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totaltotal_referrals = 0 -->
<!--         let totaltotal_completed = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totaltotal_referrals += row['total_referrals'] -->
<!--           totaltotal_completed += row['total_completed'] -->
<!--         }) -->
<!--         return (totaltotal_completed) / (totaltotal_referrals) || '-' -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1) -->
<!--     ), -->

<!--     perc_tkt_sent = colDef( -->
<!--       name = "% Tickets Sent", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totaltotal_referrals = 0 -->
<!--         let totaltotal_tkt_sent = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totaltotal_referrals += row['total_referrals'] -->
<!--           totaltotal_tkt_sent += row['total_tkt_sent'] -->
<!--         }) -->
<!--         return (totaltotal_tkt_sent) / (totaltotal_referrals) || '-' -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1) -->
<!--     ), -->

<!--     perc_tkt_sent_automated = colDef( -->
<!--       name = "% Automated Tickets Sent", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totaltotal_referrals = 0 -->
<!--         let totaltotal_tkt_sent_automated = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totaltotal_referrals += row['total_referrals'] -->
<!--           totaltotal_tkt_sent_automated += row['total_tkt_sent_automated'] -->
<!--         }) -->
<!--         return (totaltotal_tkt_sent_automated) / (totaltotal_referrals) || '-' -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1) -->
<!--     ), -->

<!--     # perc_tkt_sent_scheduler = colDef( -->
<!--     #   name = "% Scheduler Tickets Sent", -->
<!--     #   maxWidth = 100, -->
<!--     #   headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--     #   aggregate = JS("function(values, rows) { -->
<!--     #     let totaltotal_referrals = 0 -->
<!--     #     let totaltotal_tkt_sent_scheduler = 0 -->
<!--     #     rows.forEach(function(row) { -->
<!--     #       totaltotal_referrals += row['total_referrals'] -->
<!--     #       totaltotal_tkt_sent_scheduler += row['total_tkt_sent_scheduler'] -->
<!--     #     }) -->
<!--     #     return (totaltotal_tkt_sent_scheduler) / (totaltotal_referrals) -->
<!--     #   }"), -->
<!--     #   format = colFormat(percent = TRUE, digits = 1) -->
<!--     # ), -->

<!--     # perc_tkt_sent_both = colDef( -->
<!--     #   name = "% Both Tickets Sent", -->
<!--     #   maxWidth = 100, -->
<!--     #   headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--     #   aggregate = JS("function(values, rows) { -->
<!--     #     let totaltotal_referrals = 0 -->
<!--     #     let totaltotal_tkt_sent_both = 0 -->
<!--     #     rows.forEach(function(row) { -->
<!--     #       totaltotal_referrals += row['total_referrals'] -->
<!--     #       totaltotal_tkt_sent_both += row['total_tkt_sent_both'] -->
<!--     #     }) -->
<!--     #     return (totaltotal_tkt_sent_both) / (totaltotal_referrals) -->
<!--     #   }"), -->
<!--     #   format = colFormat(percent = TRUE, digits = 1) -->
<!--     # ), -->

<!--     perc_conversion_None = colDef( -->
<!--       name = "Conversion Rate - No Tickets", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#0082B3", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalscheduled_None = 0 -->
<!--         let totalnon_converted_None = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalscheduled_None += row['scheduled_None'] -->
<!--           totalnon_converted_None += row['non_converted_None'] -->
<!--         }) -->
<!--         return (totalscheduled_None) / (totalscheduled_None + totalnon_converted_None) || '-' -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1) -->
<!--     ), -->

<!--     perc_conversion_Automated = colDef( -->
<!--       name = "Conversion Rate - Automated Tickets", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#0082B3", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalscheduled_Automated = 0 -->
<!--         let totalnon_converted_Automated = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalscheduled_Automated += row['scheduled_Automated'] -->
<!--           totalnon_converted_Automated += row['non_converted_Automated'] -->
<!--         }) -->
<!--         return (totalscheduled_Automated) / (totalscheduled_Automated + totalnon_converted_Automated) || '-' -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1) -->
<!--     ), -->

<!--     perc_conversion_Scheduler = colDef( -->
<!--       name = "Conversion Rate - Scheduler Tickets", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#0082B3", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalscheduled_Scheduler = 0 -->
<!--         let totalnon_converted_Scheduler = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalscheduled_Scheduler += row['scheduled_Scheduler'] -->
<!--           totalnon_converted_Scheduler += row['non_converted_Scheduler'] -->
<!--         }) -->
<!--         return (totalscheduled_Scheduler) / (totalscheduled_Scheduler + totalnon_converted_Scheduler) || '-' -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1) -->
<!--     ), -->

<!--     perc_conversion_Both = colDef( -->
<!--       name = "Conversion Rate - Both Tickets", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#0082B3", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalscheduled_Both = 0 -->
<!--         let totalnon_converted_Both = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalscheduled_Both += row['scheduled_Both'] -->
<!--           totalnon_converted_Both += row['non_converted_Both'] -->
<!--         }) -->
<!--         return (totalscheduled_Both) / (totalscheduled_Both + totalnon_converted_Both) || '-' -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1) -->
<!--     ), -->

<!--     perc_avail_online = colDef( -->
<!--       name = "% Appts Available Online", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalavail_N_sched_N = 0 -->
<!--         let totalavail_Y_sched_N = 0 -->
<!--         let totalavail_Y_sched_Y = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalavail_N_sched_N += row['avail_N_sched_N'] -->
<!--           totalavail_Y_sched_N += row['avail_Y_sched_N'] -->
<!--           totalavail_Y_sched_Y += row['avail_Y_sched_Y'] -->
<!--         }) -->
<!--         return (totalavail_Y_sched_N + totalavail_Y_sched_Y) / (totalavail_N_sched_N + totalavail_Y_sched_N + totalavail_Y_sched_Y) || '-' -->
<!--       }"), -->
<!--       style = JS("function(rowInfo) { -->
<!--         var value = rowInfo.row['perc_avail_online'] -->
<!--         if (value >= 0.35) { -->
<!--           var color = '#008000' -->
<!--         } else if (value < 0.35) { -->
<!--           var color = '#e00000' -->
<!--         } else { -->
<!--           var color = '#000000' -->
<!--         } -->
<!--         return { color: color, fontFamily: 'calibri', fontWeight: 'bold'} -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1) -->
<!--     ), -->

<!--     # perc_sched_online = colDef( -->
<!--     #   name = "% Online Available Appts Scheduled Online", -->
<!--     #   maxWidth = 100, -->
<!--     #   headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--     #   aggregate = JS("function(values, rows) { -->
<!--     #     let totalavail_Y_sched_N = 0 -->
<!--     #     let totalavail_Y_sched_Y = 0 -->
<!--     #     rows.forEach(function(row) { -->
<!--     #       totalavail_Y_sched_N += row['avail_Y_sched_N'] -->
<!--     #       totalavail_Y_sched_Y += row['avail_Y_sched_Y'] -->
<!--     #     }) -->
<!--     #     return (totalavail_Y_sched_Y) / (totalavail_Y_sched_N + totalavail_Y_sched_Y) || '-' -->
<!--     #   }"), -->
<!--     #   format = colFormat(percent = TRUE, digits = 1) -->
<!--     # ), -->

<!--     perc_sched_online = colDef( -->
<!--       name = "% Online Available Appts Scheduled Online", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalavail_N_sched_N = 0 -->
<!--         let totalavail_Y_sched_N = 0 -->
<!--         let totalavail_Y_sched_Y = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalavail_N_sched_N += row['avail_N_sched_N'] -->
<!--           totalavail_Y_sched_N += row['avail_Y_sched_N'] -->
<!--           totalavail_Y_sched_Y += row['avail_Y_sched_Y'] -->
<!--         }) -->
<!--         return (totalavail_Y_sched_Y) / (totalavail_N_sched_N + totalavail_Y_sched_N + totalavail_Y_sched_Y) || '-' -->
<!--       }"), -->
<!--       style = JS("function(rowInfo) { -->
<!--         var value = rowInfo.row['perc_sched_online'] -->
<!--         if (value >= 0.13) { -->
<!--           var color = '#008000' -->
<!--         } else if (value < 0.13 ) { -->
<!--           var color = '#e00000' -->
<!--         } else { -->
<!--           var color = '#000000' -->
<!--         } -->
<!--         return { color: color, fontFamily: 'calibri', fontWeight: 'bold'} -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1) -->
<!--     ), -->

<!--     perc_mcr = colDef( -->
<!--       name = "% Medicare/ Medicare HMO", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#7030a0", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalMEDICARE_ESTABLISHED_LOS = 0 -->
<!--         let totalMEDICARE_NEW_LOS = 0 -->
<!--         let totalMEDICARE_HMO_ESTABLISHED_LOS = 0 -->
<!--         let totalMEDICARE_HMO_NEW_LOS = 0 -->
<!--         let totalArrived = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalMEDICARE_ESTABLISHED_LOS += row['MEDICARE_ESTABLISHED_LOS'] -->
<!--           totalMEDICARE_NEW_LOS += row['MEDICARE_NEW_LOS'] -->
<!--           totalMEDICARE_HMO_ESTABLISHED_LOS += row['MEDICARE_HMO_ESTABLISHED_LOS'], -->
<!--           totalMEDICARE_HMO_NEW_LOS += row['MEDICARE_HMO_NEW_LOS'], -->
<!--           totalArrived += row['Arrived'] -->
<!--         }) -->
<!--         return (totalMEDICARE_ESTABLISHED_LOS + totalMEDICARE_NEW_LOS + totalMEDICARE_HMO_ESTABLISHED_LOS + totalMEDICARE_HMO_NEW_LOS) / (totalArrived) || '-' -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1) -->
<!--     ), -->

<!--     perc_mcd = colDef( -->
<!--       name = "% Medicaid/ Medicaid HMO", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#7030a0", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalMEDICAID_ESTABLISHED_LOS = 0 -->
<!--         let totalMEDICAID_NEW_LOS = 0 -->
<!--         let totalMEDICAID_HMO_ESTABLISHED_LOS = 0 -->
<!--         let totalMEDICAID_HMO_NEW_LOS = 0 -->
<!--         let totalArrived = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalMEDICAID_ESTABLISHED_LOS += row['MEDICAID_ESTABLISHED_LOS'] -->
<!--           totalMEDICAID_NEW_LOS += row['MEDICAID_NEW_LOS'] -->
<!--           totalMEDICAID_HMO_ESTABLISHED_LOS += row['MEDICAID_HMO_ESTABLISHED_LOS'], -->
<!--           totalMEDICAID_HMO_NEW_LOS += row['MEDICAID_HMO_NEW_LOS'], -->
<!--           totalArrived += row['Arrived'] -->
<!--         }) -->
<!--         return (totalMEDICAID_ESTABLISHED_LOS + totalMEDICAID_NEW_LOS + totalMEDICAID_HMO_ESTABLISHED_LOS + totalMEDICAID_HMO_NEW_LOS) / (totalArrived) || '-' -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1) -->
<!--     ), -->

<!--     perc_commercial = colDef( -->
<!--       name = "% Commercial/ Managed Care", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#7030a0", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalCOMMERCIAL_MANAGED_CARE_ESTABLISHED_LOS = 0 -->
<!--         let totalCOMMERCIAL_MANAGED_CARE_NEW_LOS = 0 -->
<!--         let totalArrived = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalCOMMERCIAL_MANAGED_CARE_ESTABLISHED_LOS += row['COMMERCIAL_MANAGED_CARE_ESTABLISHED_LOS'] -->
<!--           totalCOMMERCIAL_MANAGED_CARE_NEW_LOS += row['COMMERCIAL_MANAGED_CARE_NEW_LOS'] -->
<!--           totalArrived += row['Arrived'] -->
<!--         }) -->
<!--         return (totalCOMMERCIAL_MANAGED_CARE_ESTABLISHED_LOS + totalCOMMERCIAL_MANAGED_CARE_NEW_LOS) / (totalArrived) || '-' -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1) -->
<!--     ), -->

<!--     perc_self = colDef( -->
<!--       name = "% Self-Pay", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#7030a0", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalSELF_PAY_ESTABLISHED_LOS = 0 -->
<!--         let totalSELF_PAY_NEW_LOS = 0 -->
<!--         let totalArrived = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalSELF_PAY_ESTABLISHED_LOS += row['SELF_PAY_ESTABLISHED_LOS'] -->
<!--           totalSELF_PAY_NEW_LOS += row['SELF_PAY_NEW_LOS'] -->
<!--           totalArrived += row['Arrived'] -->
<!--         }) -->
<!--         return (totalSELF_PAY_ESTABLISHED_LOS + totalSELF_PAY_NEW_LOS) / (totalArrived) || '-' -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1) -->
<!--     ), -->

<!--     perc_other = colDef( -->
<!--       name = "% Other", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#7030a0", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalOTHER_ESTABLISHED_LOS = 0 -->
<!--         let totalOTHER_NEW_LOS = 0 -->
<!--         let totalArrived = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalOTHER_ESTABLISHED_LOS += row['OTHER_ESTABLISHED_LOS'] -->
<!--           totalOTHER_NEW_LOS += row['OTHER_NEW_LOS'] -->
<!--           totalArrived += row['Arrived'] -->
<!--         }) -->
<!--         return (totalOTHER_ESTABLISHED_LOS + totalOTHER_NEW_LOS) / (totalArrived) || '-' -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1) -->
<!--     ), -->

<!--     perc_no_coverage = colDef( -->
<!--       name = "% No Coverage Assigned", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#7030a0", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalNO_COVERAGE_ASSIGNED_ESTABLISHED_LOS = 0 -->
<!--         let totalNO_COVERAGE_ASSIGNED_NEW_LOS = 0 -->
<!--         let totalArrived = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalNO_COVERAGE_ASSIGNED_ESTABLISHED_LOS += row['NO_COVERAGE_ASSIGNED_ESTABLISHED_LOS'] -->
<!--           totalNO_COVERAGE_ASSIGNED_NEW_LOS += row['NO_COVERAGE_ASSIGNED_NEW_LOS'] -->
<!--           totalArrived += row['Arrived'] -->
<!--         }) -->
<!--         return (totalNO_COVERAGE_ASSIGNED_ESTABLISHED_LOS + totalNO_COVERAGE_ASSIGNED_NEW_LOS) / (totalArrived) || '-' -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1) -->
<!--     ), -->

<!--     perc_est_lead_14days_mcr = colDef( -->
<!--       name = "% Established Medicare Scheduled within 14 Days", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#ffcc00", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalMEDICARE_ESTABLISHED_lead_14days = 0 -->
<!--         let totalMEDICARE_ESTABLISHED_lead_14days_more = 0 -->
<!--         let totalMEDICARE_HMO_ESTABLISHED_lead_14days = 0 -->
<!--         let totalMEDICARE_HMO_ESTABLISHED_lead_14days_more = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalMEDICARE_ESTABLISHED_lead_14days += row['MEDICARE_ESTABLISHED_lead_14days'] -->
<!--           totalMEDICARE_ESTABLISHED_lead_14days_more += row['MEDICARE_ESTABLISHED_lead_14days_more'] -->
<!--           totalMEDICARE_HMO_ESTABLISHED_lead_14days += row['MEDICARE_HMO_ESTABLISHED_lead_14days'] -->
<!--           totalMEDICARE_HMO_ESTABLISHED_lead_14days_more += row['MEDICARE_HMO_ESTABLISHED_lead_14days_more'] -->
<!--         }) -->
<!--         return (totalMEDICARE_ESTABLISHED_lead_14days + totalMEDICARE_HMO_ESTABLISHED_lead_14days) / (totalMEDICARE_ESTABLISHED_lead_14days + totalMEDICARE_ESTABLISHED_lead_14days_more + totalMEDICARE_HMO_ESTABLISHED_lead_14days + totalMEDICARE_HMO_ESTABLISHED_lead_14days_more) || '-' -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1) -->
<!--     ), -->

<!--     perc_est_lead_14days_mcd = colDef( -->
<!--       name = "% Established Medicaid Scheduled within 14 Days", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#ffcc00", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalMEDICAID_ESTABLISHED_lead_14days = 0 -->
<!--         let totalMEDICAID_ESTABLISHED_lead_14days_more = 0 -->
<!--         let totalMEDICAID_HMO_ESTABLISHED_lead_14days = 0 -->
<!--         let totalMEDICAID_HMO_ESTABLISHED_lead_14days_more = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalMEDICAID_ESTABLISHED_lead_14days += row['MEDICAID_ESTABLISHED_lead_14days'] -->
<!--           totalMEDICAID_ESTABLISHED_lead_14days_more += row['MEDICAID_ESTABLISHED_lead_14days_more'] -->
<!--           totalMEDICAID_HMO_ESTABLISHED_lead_14days += row['MEDICAID_HMO_ESTABLISHED_lead_14days'] -->
<!--           totalMEDICAID_HMO_ESTABLISHED_lead_14days_more += row['MEDICAID_HMO_ESTABLISHED_lead_14days_more'] -->
<!--         }) -->
<!--         return (totalMEDICAID_ESTABLISHED_lead_14days + totalMEDICAID_HMO_ESTABLISHED_lead_14days) / (totalMEDICAID_ESTABLISHED_lead_14days + totalMEDICAID_ESTABLISHED_lead_14days_more + totalMEDICAID_HMO_ESTABLISHED_lead_14days + totalMEDICAID_HMO_ESTABLISHED_lead_14days_more) || '-' -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1) -->
<!--     ), -->

<!--     perc_est_lead_14days_commercial = colDef( -->
<!--       name = "% Established Commercial Scheduled within 14 Days", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#ffcc00", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalCOMMERCIAL_MANAGED_CARE_ESTABLISHED_lead_14days = 0 -->
<!--         let totalCOMMERCIAL_MANAGED_CARE_ESTABLISHED_lead_14days_more = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalCOMMERCIAL_MANAGED_CARE_ESTABLISHED_lead_14days += row['COMMERCIAL_MANAGED_CARE_ESTABLISHED_lead_14days'] -->
<!--           totalCOMMERCIAL_MANAGED_CARE_ESTABLISHED_lead_14days_more += row['COMMERCIAL_MANAGED_CARE_ESTABLISHED_lead_14days_more'] -->
<!--         }) -->
<!--         return (totalCOMMERCIAL_MANAGED_CARE_ESTABLISHED_lead_14days) / (totalCOMMERCIAL_MANAGED_CARE_ESTABLISHED_lead_14days + totalCOMMERCIAL_MANAGED_CARE_ESTABLISHED_lead_14days_more) || '-' -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1) -->
<!--     ), -->

<!--     perc_new_lead_14days_mcr = colDef( -->
<!--       name = "% New Medicare Scheduled within 14 Days", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#cca300", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalMEDICARE_NEW_lead_14days = 0 -->
<!--         let totalMEDICARE_NEW_lead_14days_more = 0 -->
<!--         let totalMEDICARE_HMO_NEW_lead_14days = 0 -->
<!--         let totalMEDICARE_HMO_NEW_lead_14days_more = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalMEDICARE_NEW_lead_14days += row['MEDICARE_NEW_lead_14days'] -->
<!--           totalMEDICARE_NEW_lead_14days_more += row['MEDICARE_NEW_lead_14days_more'] -->
<!--           totalMEDICARE_HMO_NEW_lead_14days += row['MEDICARE_HMO_NEW_lead_14days'] -->
<!--           totalMEDICARE_HMO_NEW_lead_14days_more += row['MEDICARE_HMO_NEW_lead_14days_more'] -->
<!--         }) -->
<!--         return (totalMEDICARE_NEW_lead_14days + totalMEDICARE_HMO_NEW_lead_14days) / (totalMEDICARE_NEW_lead_14days + totalMEDICARE_NEW_lead_14days_more + totalMEDICARE_HMO_NEW_lead_14days + totalMEDICARE_HMO_NEW_lead_14days_more) || '-' -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1) -->
<!--     ), -->

<!--     perc_new_lead_14days_mcd = colDef( -->
<!--       name = "% New Medicaid Scheduled within 14 Days", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#cca300", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalMEDICAID_NEW_lead_14days = 0 -->
<!--         let totalMEDICAID_NEW_lead_14days_more = 0 -->
<!--         let totalMEDICAID_HMO_NEW_lead_14days = 0 -->
<!--         let totalMEDICAID_HMO_NEW_lead_14days_more = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalMEDICAID_NEW_lead_14days += row['MEDICAID_NEW_lead_14days'] -->
<!--           totalMEDICAID_NEW_lead_14days_more += row['MEDICAID_NEW_lead_14days_more'] -->
<!--           totalMEDICAID_HMO_NEW_lead_14days += row['MEDICAID_HMO_NEW_lead_14days'] -->
<!--           totalMEDICAID_HMO_NEW_lead_14days_more += row['MEDICAID_HMO_NEW_lead_14days_more'] -->
<!--         }) -->
<!--         return (totalMEDICAID_NEW_lead_14days + totalMEDICAID_HMO_NEW_lead_14days) / (totalMEDICAID_NEW_lead_14days + totalMEDICAID_NEW_lead_14days_more + totalMEDICAID_HMO_NEW_lead_14days + totalMEDICAID_HMO_NEW_lead_14days_more) || '-' -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1) -->
<!--     ), -->

<!--     perc_new_lead_14days_commercial = colDef( -->
<!--       name = "% New Commercial Scheduled within 14 Days", -->
<!--       maxWidth = 100, -->
<!--       headerStyle = list(background = "#cca300", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalCOMMERCIAL_MANAGED_CARE_NEW_lead_14days = 0 -->
<!--         let totalCOMMERCIAL_MANAGED_CARE_NEW_lead_14days_more = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalCOMMERCIAL_MANAGED_CARE_NEW_lead_14days += row['COMMERCIAL_MANAGED_CARE_NEW_lead_14days'] -->
<!--           totalCOMMERCIAL_MANAGED_CARE_NEW_lead_14days_more += row['COMMERCIAL_MANAGED_CARE_NEW_lead_14days_more'] -->
<!--         }) -->
<!--         return (totalCOMMERCIAL_MANAGED_CARE_NEW_lead_14days) / (totalCOMMERCIAL_MANAGED_CARE_NEW_lead_14days + totalCOMMERCIAL_MANAGED_CARE_NEW_lead_14days_more) || '-' -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1) -->
<!--     ), -->

<!--     Month = colDef(show =F), -->
<!--     DEPARTMENT_ID = colDef(show =F), -->
<!--     sched_hours = colDef(show =F), -->
<!--     arrived_hours = colDef(show =F), -->
<!--     sched_hours = colDef(show =F), -->
<!--     arrived_hours = colDef(show =F), -->
<!--     Arrived = colDef(show =F), -->
<!--     SameDay_Canceled = colDef(show =F), -->
<!--     No_Show = colDef(show =F), -->
<!--     perc_noShow = colDef(show =F), -->
<!--     perc_SameDayCanceled = colDef(show =F), -->
<!--     NEW_LOS = colDef(show =F), -->
<!--     appts_arrived = colDef(show =F), -->
<!--     ESTABLISHED_LOS = colDef(show =F), -->
<!--     total_referrals = colDef(show =F), -->
<!--     # total_scheduled = colDef(show =F), -->
<!--     total_completed = colDef(show =F), -->
<!--     total_tkt_sent_automated = colDef(show =F), -->
<!--     total_tkt_sent_scheduler = colDef(show =F), -->
<!--     total_tkt_sent_both = colDef(show =F), -->
<!--     total_tkt_sent = colDef(show =F), -->
<!--     non_converted_None = colDef(show =F), -->
<!--     non_converted_Automated = colDef(show =F), -->
<!--     non_converted_Scheduler = colDef(show =F), -->
<!--     non_converted_Both = colDef(show =F), -->
<!--     scheduled_None = colDef(show =F), -->
<!--     scheduled_Automated = colDef(show =F), -->
<!--     scheduled_Scheduler = colDef(show =F), -->
<!--     scheduled_Both = colDef(show =F), -->
<!--     perc_tkt_sent_scheduler = colDef(show =F), -->
<!--     perc_tkt_sent_both = colDef(show =F), -->
<!--     completed_None = colDef(show =F), -->
<!--     completed_Automated = colDef(show =F), -->
<!--     completed_Scheduler = colDef(show =F), -->
<!--     completed_Both = colDef(show =F), -->
<!--     ESTABLISHED = colDef(show =F), -->
<!--     NEW = colDef(show =F), -->
<!--     appts_scheduled = colDef(show =F), -->
<!--     perc_new = colDef(show =F), -->
<!--     NEW_lead_14days = colDef(show =F), -->
<!--     NEW_lead_14days_more = colDef(show =F), -->
<!--     NEW_appts_scheduled = colDef(show =F), -->
<!--     perc_new_lead_14days = colDef(show =F), -->
<!--     avail_N_sched_N = colDef(show =F), -->
<!--     avail_Y_sched_N = colDef(show =F), -->
<!--     avail_Y_sched_Y = colDef(show =F), -->

<!--     MEDICARE_HMO_ESTABLISHED_LOS = colDef(show =F), -->
<!--     COMMERCIAL_MANAGED_CARE_NEW_LOS = colDef(show =F), -->
<!--     MEDICARE_ESTABLISHED_LOS = colDef(show =F), -->
<!--     OTHER_ESTABLISHED_LOS = colDef(show =F), -->
<!--     MEDICARE_NEW_LOS = colDef(show =F), -->
<!--     MEDICAID_HMO_ESTABLISHED_LOS = colDef(show =F), -->
<!--     COMMERCIAL_MANAGED_CARE_ESTABLISHED_LOS = colDef(show =F), -->
<!--     MEDICAID_ESTABLISHED_LOS = colDef(show =F), -->
<!--     MEDICARE_HMO_NEW_LOS = colDef(show =F), -->
<!--     SELF_PAY_ESTABLISHED_LOS = colDef(show =F), -->
<!--     SELF_PAY_NEW_LOS = colDef(show =F), -->
<!--     MEDICAID_HMO_NEW_LOS = colDef(show =F), -->
<!--     OTHER_NEW_LOS = colDef(show =F), -->
<!--     MEDICAID_NEW_LOS = colDef(show =F), -->
<!--     NO_COVERAGE_ASSIGNED_ESTABLISHED_LOS = colDef(show =F), -->
<!--     NO_COVERAGE_ASSIGNED_NEW_LOS = colDef(show =F), -->
<!--     MEDICAID_ESTABLISHED_lead_14days = colDef(show =F), -->
<!--     MEDICARE_HMO_ESTABLISHED_lead_14days_more = colDef(show =F), -->
<!--     MEDICARE_NEW_lead_14days_more = colDef(show =F), -->
<!--     MEDICAID_NEW_lead_14days_more = colDef(show =F), -->
<!--     MEDICARE_ESTABLISHED_lead_14days = colDef(show =F), -->
<!--     MEDICAID_HMO_ESTABLISHED_lead_14days_more = colDef(show =F), -->
<!--     COMMERCIAL_MANAGED_CARE_ESTABLISHED_lead_14days_more = colDef(show =F), -->
<!--     MEDICAID_HMO_ESTABLISHED_lead_14days = colDef(show =F), -->
<!--     COMMERCIAL_MANAGED_CARE_NEW_lead_14days = colDef(show =F), -->
<!--     MEDICAID_HMO_NEW_lead_14days_more = colDef(show =F), -->
<!--     COMMERCIAL_MANAGED_CARE_ESTABLISHED_lead_14days = colDef(show =F), -->
<!--     SELF_PAY_NEW_lead_14days = colDef(show =F), -->
<!--     MEDICARE_NEW_lead_14days = colDef(show =F), -->
<!--     MEDICARE_ESTABLISHED_lead_14days_more = colDef(show =F), -->
<!--     SELF_PAY_ESTABLISHED_lead_14days = colDef(show =F), -->
<!--     MEDICARE_HMO_ESTABLISHED_lead_14days = colDef(show =F), -->
<!--     COMMERCIAL_MANAGED_CARE_NEW_lead_14days_more = colDef(show =F), -->
<!--     MEDICARE_HMO_NEW_lead_14days = colDef(show =F), -->
<!--     SELF_PAY_ESTABLISHED_lead_14days_more = colDef(show =F), -->
<!--     OTHER_ESTABLISHED_lead_14days_more = colDef(show =F), -->
<!--     MEDICAID_NEW_lead_14days = colDef(show =F), -->
<!--     SELF_PAY_NEW_lead_14days_more = colDef(show =F), -->
<!--     NO_COVERAGE_ASSIGNED_ESTABLISHED_lead_14days_more = colDef(show =F), -->
<!--     MEDICAID_ESTABLISHED_lead_14days_more = colDef(show =F), -->
<!--     MEDICARE_HMO_NEW_lead_14days_more = colDef(show =F), -->
<!--     MEDICAID_HMO_NEW_lead_14days = colDef(show =F), -->
<!--     NO_COVERAGE_ASSIGNED_NEW_lead_14days_more = colDef(show =F), -->
<!--     NO_COVERAGE_ASSIGNED_ESTABLISHED_lead_14days = colDef(show =F), -->
<!--     OTHER_ESTABLISHED_lead_14days = colDef(show =F), -->
<!--     NO_COVERAGE_ASSIGNED_NEW_lead_14days = colDef(show =F), -->
<!--     OTHER_NEW_lead_14days = colDef(show =F), -->
<!--     OTHER_NEW_lead_14days_more = colDef(show =F) -->


<!--   ) # Close Columns -->

<!--   ) # Close Reactable -->
<!-- ) # Close Taglist -->
<!-- ) # Close htmltools -->

<!-- ``` -->
<!-- <br/> -->
<!-- <p style="font-size:10pt; font-style:italic">*New Patient is defined by level of service; New Patient Ratio is calculated based on (Total New Patients Arrived) / (Total Patients Arrived)<p/> -->
<!-- <p style="font-size:10pt; font-style:italic">*Primary Care includes Adolescent Medicine, Community and Preventative Medicine, Internal Medicine, Family Medicine, Pediatrics, Geriatrics, Urgent Care<p/> -->



## Metrics by Provider
```{r By Provider Output, echo = FALSE, warning = FALSE, message = FALSE}


# htmltools::browsable(
#   tagList(
#     tags$button(
#       tagList(fontawesome::fa("download"), "Download Table"),
#       onclick = "Reactable.downloadDataCSV('access-metrics-prov', 'Metric Overview by Provider')"
#     ),

htmltools::browsable(
  tagList(
    div(tags$label("Summary by", `for` = "access-metrics-prov")),
    tags$select(
      id = "new-pt-waitTime",
      onchange = "Reactable.setGroupBy('access-metrics', this.value ? [this.value] : [])",
      tags$option("None", value = ""),
      lapply(c("Year", "Year-Month", "SITE", "Specialty Type", "Specialty"), tags$option)
    ),

    tags$hr("aria-hidden" = "true"),

reactable(
  provider_merged,
  elementId = "access-metrics-prov",
  # elementId = "referral-vol-download-table",
  style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "left",
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),
  # RowStyle = function(index) {
  #           if (index %in% c(nrow(referral_vol_site_data_mshs))) {
  #             list(`border-top` = "2px solid rgb(184,184,184)",
  #                  fontWeight = "Bold")
  #           }
  #         },
    highlight = TRUE,
    filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
  searchable = TRUE,

  groupBy = c("Year", "Year-Month", "SITE", "Specialty Type", "Specialty", "DEPARTMENT_NAME", "PROV_TYPE", "PROV_NAME"),

  columnGroups = list(
    colGroup(name = "", columns = c("Year", "Year-Month", "SITE", "Specialty Type", "Specialty", "DEPARTMENT_NAME", "PROV_TYPE", "PROV_NAME"),
             headerStyle = list(color = "black", fontSize = "15px"),
             sticky = "left"),
    colGroup(name = paste0("Template Utilization (Physicians Only)"),
             columns = c("avail_hours", "sched_util", "prov_util"),
             headerStyle = list(background = "#212070", color = "white", fontSize = "15px")),
    colGroup(name = paste0("No Show"),
             columns = c("perc_noShowPlus"),
             headerStyle = list(background = "#d80b8c", color = "white", fontSize = "15px")),
    colGroup(name = paste0("New Patient Access"),
             columns = c("perc_new_lead_14days", "perc_new_los"),
             headerStyle = list(background = "#9E1A6D", color = "white", fontSize = "15px")),
    colGroup(name = paste0("Referrals + Ticket Scheduling"),
             columns = c("total_referrals", "total_scheduled", "perc_conversion", "perc_completion",
                         "perc_tkt_sent", "perc_tkt_sent_automated",
                         "perc_conversion_None", "perc_conversion_Automated", "perc_conversion_Scheduler", "perc_conversion_Both"),
             headerStyle = list(background = "#00aeef", color = "white", fontSize = "15px")),
    colGroup(name = paste0("Digital Scheduling"),
             columns = c("perc_avail_online", "perc_sched_online"),
             headerStyle = list(background = "#7f7f7f", color = "white", fontSize = "15px")),
    colGroup(name = paste0("Payer Mix: Volume"),
             columns = c("perc_mcr", "perc_mcd", "perc_commercial", "perc_self", "perc_other", "perc_no_coverage"),
             headerStyle = list(background = "#7030a0", color = "white", fontSize = "15px")),
    colGroup(name = paste0("Payer Mix: Established Patient Access"),
             columns = c("perc_est_lead_14days_mcr", "perc_est_lead_14days_mcd", "perc_est_lead_14days_commercial"),
             headerStyle = list(background = "#ffcc00", color = "white", fontSize = "15px")),
    colGroup(name = paste0("Payer Mix: New Patient Access"),
             columns = c("perc_new_lead_14days_mcr", "perc_new_lead_14days_mcd", "perc_new_lead_14days_commercial"),
             headerStyle = list(background = "#cca300", color = "white", fontSize = "15px"))
    ),

  columns = list(

    Year = colDef(
      maxWidth = 100),

    `Year-Month` = colDef(
      maxWidth = 220),

    SITE = colDef(
      # footer = "Total",
      name = "Site",
      maxWidth = 150),

    `Specialty Type` = colDef(
      name = "Specialty Type*",
      maxWidth = 150),

    Specialty = colDef(
      maxWidth = 230),

    DEPARTMENT_NAME = colDef(
      name = "Department",
      maxWidth = 230),

    PROV_TYPE = colDef(
      name = "Provider Type",
      maxWidth = 230),

    PROV_NAME = colDef(
      name = "ProvideR",
      maxWidth = 230),

    avail_hours = colDef(
      name = "Available Hrs",
      aggregate = "sum",
      maxWidth = 100,
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      format = colFormat(separators = TRUE, digits = 0)),

    sched_util = colDef(
      name = "Schedule Utilization",
      maxWidth = 100,
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      # Calculate the aggregate conversion rate as `(total-pending) / total`
      aggregate = JS("function(values, rows) {
        let totalsched_hours = 0
        let totalavail_hours = 0
        rows.forEach(function(row) {
          totalsched_hours+= row['sched_hours']
          totalavail_hours += row['avail_hours']
        })
        return (totalsched_hours) / (totalavail_hours) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 0)
    ),

    prov_util = colDef(
      name = "Provider Utilization",
      maxWidth = 100,
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      # Calculate the aggregate conversion rate as `(total-pending) / total`
      aggregate = JS("function(values, rows) {
        let totalavail_hours = 0
        let totalarrived_hours = 0
        rows.forEach(function(row) {
          totalavail_hours += row['avail_hours']
          totalarrived_hours += row['arrived_hours']
        })
        return (totalarrived_hours) / (totalavail_hours) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 0)
    ),

    perc_noShowPlus = colDef(
      name = "No Show Plus Rate",
      maxWidth = 100,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      # Calculate the aggregate conversion rate as `(total-pending) / total`
      aggregate = JS("function(values, rows) {
        let totalArrived = 0
        let totalNo_Show = 0
        let totalSameDay_Canceled = 0
        rows.forEach(function(row) {
          totalArrived += row['Arrived']
          totalNo_Show += row['No_Show']
          totalSameDay_Canceled += row['SameDay_Canceled']
        })
        return (totalNo_Show + totalSameDay_Canceled) / (totalArrived + totalNo_Show + totalSameDay_Canceled) || '-'
      }"),
      style = JS("function(rowInfo) {
        var value = rowInfo.row['perc_noShowPlus']
        if (value >= 0.12) {
          var color = '#e00000'
        } else if (value < 0.12) {
          var color = '#008000'
        } else {
          var color = '#000000'
        }
        return { color: color, fontFamily: 'calibri', fontWeight: 'bold'}
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),

    perc_new_lead_14days = colDef(
      name = "% New Scheduled within 14 Days",
      maxWidth = 100,
      headerStyle = list(background = "#9E1A6D", color = "white", fontWeight = "Bold", fontSize = "14px"),
      # Calculate the aggregate conversion rate as `(total-pending) / total`
      aggregate = JS("function(values, rows) {
        let totalNEW_lead_14days = 0
        let totalNEW_appts_scheduled = 0
        rows.forEach(function(row) {
          totalNEW_lead_14days += row['NEW_lead_14days']
          totalNEW_appts_scheduled += row['NEW_appts_scheduled']
        })
        return (totalNEW_lead_14days) / (totalNEW_appts_scheduled) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),

    perc_new_los = colDef(
      name = "New Patient Ratio*",
      maxWidth = 100,
      headerStyle = list(background = "#9E1A6D", color = "white", fontWeight = "Bold", fontSize = "14px"),
      # Calculate the aggregate conversion rate as `(total-pending) / total`
      aggregate = JS("function(values, rows) {
        let totalNEW_LOS = 0
        let totalESTABLISHED_LOS = 0
        rows.forEach(function(row) {
          totalNEW_LOS += row['NEW_LOS']
          totalESTABLISHED_LOS += row['ESTABLISHED_LOS']
        })
        return (totalNEW_LOS) / (totalNEW_LOS + totalESTABLISHED_LOS) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),

    total_referrals = colDef(
      name = "Total Referrals",
      aggregate = "sum",
      maxWidth = 100,
      headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"),
      format = colFormat(separators = TRUE, digits = 0)),

    total_scheduled = colDef(
      name = "Total Referrals Scheduled",
      aggregate = "sum",
      maxWidth = 100,
      headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"),
      format = colFormat(separators = TRUE, digits = 0)),

    perc_conversion = colDef(
      name = "Conversion Rate",
      maxWidth = 100,
      headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totaltotal_referrals = 0
        let totaltotal_scheduled = 0
        rows.forEach(function(row) {
          totaltotal_referrals += row['total_referrals']
          totaltotal_scheduled += row['total_scheduled']
        })
        return (totaltotal_scheduled) / (totaltotal_referrals) || '-'
      }"),
      style = JS("function(rowInfo) {
        var value = rowInfo.row['perc_conversion']
        if (value >= 0.60) {
          var color = '#008000'
        } else if (value < 0.60) {
          var color = '#e00000'
        } else {
          var color = '#000000'
        }
        return { color: color, fontFamily: 'calibri', fontWeight: 'bold'}
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),

    perc_completion = colDef(
      name = "Completion Rate",
      maxWidth = 100,
      headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totaltotal_referrals = 0
        let totaltotal_completed = 0
        rows.forEach(function(row) {
          totaltotal_referrals += row['total_referrals']
          totaltotal_completed += row['total_completed']
        })
        return (totaltotal_completed) / (totaltotal_referrals) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),

    perc_tkt_sent = colDef(
      name = "% Tickets Sent",
      maxWidth = 100,
      headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totaltotal_referrals = 0
        let totaltotal_tkt_sent = 0
        rows.forEach(function(row) {
          totaltotal_referrals += row['total_referrals']
          totaltotal_tkt_sent += row['total_tkt_sent']
        })
        return (totaltotal_tkt_sent) / (totaltotal_referrals) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),

    perc_tkt_sent_automated = colDef(
      name = "% Automated Tickets Sent",
      maxWidth = 100,
      headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totaltotal_referrals = 0
        let totaltotal_tkt_sent_automated = 0
        rows.forEach(function(row) {
          totaltotal_referrals += row['total_referrals']
          totaltotal_tkt_sent_automated += row['total_tkt_sent_automated']
        })
        return (totaltotal_tkt_sent_automated) / (totaltotal_referrals) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),

    # perc_tkt_sent_scheduler = colDef(
    #   name = "% Scheduler Tickets Sent",
    #   maxWidth = 100,
    #   headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"),
    #   aggregate = JS("function(values, rows) {
    #     let totaltotal_referrals = 0
    #     let totaltotal_tkt_sent_scheduler = 0
    #     rows.forEach(function(row) {
    #       totaltotal_referrals += row['total_referrals']
    #       totaltotal_tkt_sent_scheduler += row['total_tkt_sent_scheduler']
    #     })
    #     return (totaltotal_tkt_sent_scheduler) / (totaltotal_referrals)
    #   }"),
    #   format = colFormat(percent = TRUE, digits = 1)
    # ),

    # perc_tkt_sent_both = colDef(
    #   name = "% Both Tickets Sent",
    #   maxWidth = 100,
    #   headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"),
    #   aggregate = JS("function(values, rows) {
    #     let totaltotal_referrals = 0
    #     let totaltotal_tkt_sent_both = 0
    #     rows.forEach(function(row) {
    #       totaltotal_referrals += row['total_referrals']
    #       totaltotal_tkt_sent_both += row['total_tkt_sent_both']
    #     })
    #     return (totaltotal_tkt_sent_both) / (totaltotal_referrals)
    #   }"),
    #   format = colFormat(percent = TRUE, digits = 1)
    # ),

    perc_conversion_None = colDef(
      name = "Conversion Rate - No Tickets",
      maxWidth = 100,
      headerStyle = list(background = "#0082B3", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalscheduled_None = 0
        let totalnon_converted_None = 0
        rows.forEach(function(row) {
          totalscheduled_None += row['scheduled_None']
          totalnon_converted_None += row['non_converted_None']
        })
        return (totalscheduled_None) / (totalscheduled_None + totalnon_converted_None) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),

    perc_conversion_Automated = colDef(
      name = "Conversion Rate - Automated Tickets",
      maxWidth = 100,
      headerStyle = list(background = "#0082B3", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalscheduled_Automated = 0
        let totalnon_converted_Automated = 0
        rows.forEach(function(row) {
          totalscheduled_Automated += row['scheduled_Automated']
          totalnon_converted_Automated += row['non_converted_Automated']
        })
        return (totalscheduled_Automated) / (totalscheduled_Automated + totalnon_converted_Automated) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),

    perc_conversion_Scheduler = colDef(
      name = "Conversion Rate - Scheduler Tickets",
      maxWidth = 100,
      headerStyle = list(background = "#0082B3", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalscheduled_Scheduler = 0
        let totalnon_converted_Scheduler = 0
        rows.forEach(function(row) {
          totalscheduled_Scheduler += row['scheduled_Scheduler']
          totalnon_converted_Scheduler += row['non_converted_Scheduler']
        })
        return (totalscheduled_Scheduler) / (totalscheduled_Scheduler + totalnon_converted_Scheduler) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),

    perc_conversion_Both = colDef(
      name = "Conversion Rate - Both Tickets",
      maxWidth = 100,
      headerStyle = list(background = "#0082B3", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalscheduled_Both = 0
        let totalnon_converted_Both = 0
        rows.forEach(function(row) {
          totalscheduled_Both += row['scheduled_Both']
          totalnon_converted_Both += row['non_converted_Both']
        })
        return (totalscheduled_Both) / (totalscheduled_Both + totalnon_converted_Both) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),

    perc_avail_online = colDef(
      name = "% Appts Available Online",
      maxWidth = 100,
      headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalavail_N_sched_N = 0
        let totalavail_Y_sched_N = 0
        let totalavail_Y_sched_Y = 0
        rows.forEach(function(row) {
          totalavail_N_sched_N += row['avail_N_sched_N']
          totalavail_Y_sched_N += row['avail_Y_sched_N']
          totalavail_Y_sched_Y += row['avail_Y_sched_Y']
        })
        return (totalavail_Y_sched_N + totalavail_Y_sched_Y) / (totalavail_N_sched_N + totalavail_Y_sched_N + totalavail_Y_sched_Y) || '-'
      }"),
      style = JS("function(rowInfo) {
        var value = rowInfo.row['perc_avail_online']
        if (value >= 0.35) {
          var color = '#008000'
        } else if (value < 0.35) {
          var color = '#e00000'
        } else {
          var color = '#000000'
        }
        return { color: color, fontFamily: 'calibri', fontWeight: 'bold'}
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),

    # perc_sched_online = colDef(
    #   name = "% Online Available Appts Scheduled Online",
    #   maxWidth = 100,
    #   headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
    #   aggregate = JS("function(values, rows) {
    #     let totalavail_Y_sched_N = 0
    #     let totalavail_Y_sched_Y = 0
    #     rows.forEach(function(row) {
    #       totalavail_Y_sched_N += row['avail_Y_sched_N']
    #       totalavail_Y_sched_Y += row['avail_Y_sched_Y']
    #     })
    #     return (totalavail_Y_sched_Y) / (totalavail_Y_sched_N + totalavail_Y_sched_Y) || '-'
    #   }"),
    #   format = colFormat(percent = TRUE, digits = 1)
    # ),

    perc_sched_online = colDef(
      name = "% Online Available Appts Scheduled Online",
      maxWidth = 100,
      headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalavail_N_sched_N = 0
        let totalavail_Y_sched_N = 0
        let totalavail_Y_sched_Y = 0
        rows.forEach(function(row) {
          totalavail_N_sched_N += row['avail_N_sched_N']
          totalavail_Y_sched_N += row['avail_Y_sched_N']
          totalavail_Y_sched_Y += row['avail_Y_sched_Y']
        })
        return (totalavail_Y_sched_Y) / (totalavail_N_sched_N + totalavail_Y_sched_N + totalavail_Y_sched_Y) || '-'
      }"),
      style = JS("function(rowInfo) {
        var value = rowInfo.row['perc_sched_online']
        if (value >= 0.13) {
          var color = '#008000'
        } else if (value < 0.13 ) {
          var color = '#e00000'
        } else {
          var color = '#000000'
        }
        return { color: color, fontFamily: 'calibri', fontWeight: 'bold'}
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),

    perc_mcr = colDef(
      name = "% Medicare/ Medicare HMO",
      maxWidth = 100,
      headerStyle = list(background = "#7030a0", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalMEDICARE_ESTABLISHED_LOS = 0
        let totalMEDICARE_NEW_LOS = 0
        let totalMEDICARE_HMO_ESTABLISHED_LOS = 0
        let totalMEDICARE_HMO_NEW_LOS = 0
        let totalArrived = 0
        rows.forEach(function(row) {
          totalMEDICARE_ESTABLISHED_LOS += row['MEDICARE_ESTABLISHED_LOS']
          totalMEDICARE_NEW_LOS += row['MEDICARE_NEW_LOS']
          totalMEDICARE_HMO_ESTABLISHED_LOS += row['MEDICARE_HMO_ESTABLISHED_LOS'],
          totalMEDICARE_HMO_NEW_LOS += row['MEDICARE_HMO_NEW_LOS'],
          totalArrived += row['Arrived']
        })
        return (totalMEDICARE_ESTABLISHED_LOS + totalMEDICARE_NEW_LOS + totalMEDICARE_HMO_ESTABLISHED_LOS + totalMEDICARE_HMO_NEW_LOS) / (totalArrived) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),

    perc_mcd = colDef(
      name = "% Medicaid/ Medicaid HMO",
      maxWidth = 100,
      headerStyle = list(background = "#7030a0", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalMEDICAID_ESTABLISHED_LOS = 0
        let totalMEDICAID_NEW_LOS = 0
        let totalMEDICAID_HMO_ESTABLISHED_LOS = 0
        let totalMEDICAID_HMO_NEW_LOS = 0
        let totalArrived = 0
        rows.forEach(function(row) {
          totalMEDICAID_ESTABLISHED_LOS += row['MEDICAID_ESTABLISHED_LOS']
          totalMEDICAID_NEW_LOS += row['MEDICAID_NEW_LOS']
          totalMEDICAID_HMO_ESTABLISHED_LOS += row['MEDICAID_HMO_ESTABLISHED_LOS'],
          totalMEDICAID_HMO_NEW_LOS += row['MEDICAID_HMO_NEW_LOS'],
          totalArrived += row['Arrived']
        })
        return (totalMEDICAID_ESTABLISHED_LOS + totalMEDICAID_NEW_LOS + totalMEDICAID_HMO_ESTABLISHED_LOS + totalMEDICAID_HMO_NEW_LOS) / (totalArrived) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),

    perc_commercial = colDef(
      name = "% Commercial/ Managed Care",
      maxWidth = 100,
      headerStyle = list(background = "#7030a0", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalCOMMERCIAL_MANAGED_CARE_ESTABLISHED_LOS = 0
        let totalCOMMERCIAL_MANAGED_CARE_NEW_LOS = 0
        let totalArrived = 0
        rows.forEach(function(row) {
          totalCOMMERCIAL_MANAGED_CARE_ESTABLISHED_LOS += row['COMMERCIAL_MANAGED_CARE_ESTABLISHED_LOS']
          totalCOMMERCIAL_MANAGED_CARE_NEW_LOS += row['COMMERCIAL_MANAGED_CARE_NEW_LOS']
          totalArrived += row['Arrived']
        })
        return (totalCOMMERCIAL_MANAGED_CARE_ESTABLISHED_LOS + totalCOMMERCIAL_MANAGED_CARE_NEW_LOS) / (totalArrived) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),

    perc_self = colDef(
      name = "% Self-Pay",
      maxWidth = 100,
      headerStyle = list(background = "#7030a0", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalSELF_PAY_ESTABLISHED_LOS = 0
        let totalSELF_PAY_NEW_LOS = 0
        let totalArrived = 0
        rows.forEach(function(row) {
          totalSELF_PAY_ESTABLISHED_LOS += row['SELF_PAY_ESTABLISHED_LOS']
          totalSELF_PAY_NEW_LOS += row['SELF_PAY_NEW_LOS']
          totalArrived += row['Arrived']
        })
        return (totalSELF_PAY_ESTABLISHED_LOS + totalSELF_PAY_NEW_LOS) / (totalArrived) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),

    perc_other = colDef(
      name = "% Other",
      maxWidth = 100,
      headerStyle = list(background = "#7030a0", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalOTHER_ESTABLISHED_LOS = 0
        let totalOTHER_NEW_LOS = 0
        let totalArrived = 0
        rows.forEach(function(row) {
          totalOTHER_ESTABLISHED_LOS += row['OTHER_ESTABLISHED_LOS']
          totalOTHER_NEW_LOS += row['OTHER_NEW_LOS']
          totalArrived += row['Arrived']
        })
        return (totalOTHER_ESTABLISHED_LOS + totalOTHER_NEW_LOS) / (totalArrived) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),

    perc_no_coverage = colDef(
      name = "% No Coverage Assigned",
      maxWidth = 100,
      headerStyle = list(background = "#7030a0", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalNO_COVERAGE_ASSIGNED_ESTABLISHED_LOS = 0
        let totalNO_COVERAGE_ASSIGNED_NEW_LOS = 0
        let totalArrived = 0
        rows.forEach(function(row) {
          totalNO_COVERAGE_ASSIGNED_ESTABLISHED_LOS += row['NO_COVERAGE_ASSIGNED_ESTABLISHED_LOS']
          totalNO_COVERAGE_ASSIGNED_NEW_LOS += row['NO_COVERAGE_ASSIGNED_NEW_LOS']
          totalArrived += row['Arrived']
        })
        return (totalNO_COVERAGE_ASSIGNED_ESTABLISHED_LOS + totalNO_COVERAGE_ASSIGNED_NEW_LOS) / (totalArrived) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),

    perc_est_lead_14days_mcr = colDef(
      name = "% Established Medicare Scheduled within 14 Days",
      maxWidth = 100,
      headerStyle = list(background = "#ffcc00", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalMEDICARE_ESTABLISHED_lead_14days = 0
        let totalMEDICARE_ESTABLISHED_lead_14days_more = 0
        let totalMEDICARE_HMO_ESTABLISHED_lead_14days = 0
        let totalMEDICARE_HMO_ESTABLISHED_lead_14days_more = 0
        rows.forEach(function(row) {
          totalMEDICARE_ESTABLISHED_lead_14days += row['MEDICARE_ESTABLISHED_lead_14days']
          totalMEDICARE_ESTABLISHED_lead_14days_more += row['MEDICARE_ESTABLISHED_lead_14days_more']
          totalMEDICARE_HMO_ESTABLISHED_lead_14days += row['MEDICARE_HMO_ESTABLISHED_lead_14days']
          totalMEDICARE_HMO_ESTABLISHED_lead_14days_more += row['MEDICARE_HMO_ESTABLISHED_lead_14days_more']
        })
        return (totalMEDICARE_ESTABLISHED_lead_14days + totalMEDICARE_HMO_ESTABLISHED_lead_14days) / (totalMEDICARE_ESTABLISHED_lead_14days + totalMEDICARE_ESTABLISHED_lead_14days_more + totalMEDICARE_HMO_ESTABLISHED_lead_14days + totalMEDICARE_HMO_ESTABLISHED_lead_14days_more) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),

    perc_est_lead_14days_mcd = colDef(
      name = "% Established Medicaid Scheduled within 14 Days",
      maxWidth = 100,
      headerStyle = list(background = "#ffcc00", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalMEDICAID_ESTABLISHED_lead_14days = 0
        let totalMEDICAID_ESTABLISHED_lead_14days_more = 0
        let totalMEDICAID_HMO_ESTABLISHED_lead_14days = 0
        let totalMEDICAID_HMO_ESTABLISHED_lead_14days_more = 0
        rows.forEach(function(row) {
          totalMEDICAID_ESTABLISHED_lead_14days += row['MEDICAID_ESTABLISHED_lead_14days']
          totalMEDICAID_ESTABLISHED_lead_14days_more += row['MEDICAID_ESTABLISHED_lead_14days_more']
          totalMEDICAID_HMO_ESTABLISHED_lead_14days += row['MEDICAID_HMO_ESTABLISHED_lead_14days']
          totalMEDICAID_HMO_ESTABLISHED_lead_14days_more += row['MEDICAID_HMO_ESTABLISHED_lead_14days_more']
        })
        return (totalMEDICAID_ESTABLISHED_lead_14days + totalMEDICAID_HMO_ESTABLISHED_lead_14days) / (totalMEDICAID_ESTABLISHED_lead_14days + totalMEDICAID_ESTABLISHED_lead_14days_more + totalMEDICAID_HMO_ESTABLISHED_lead_14days + totalMEDICAID_HMO_ESTABLISHED_lead_14days_more) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),

    perc_est_lead_14days_commercial = colDef(
      name = "% Established Commercial Scheduled within 14 Days",
      maxWidth = 100,
      headerStyle = list(background = "#ffcc00", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalCOMMERCIAL_MANAGED_CARE_ESTABLISHED_lead_14days = 0
        let totalCOMMERCIAL_MANAGED_CARE_ESTABLISHED_lead_14days_more = 0
        rows.forEach(function(row) {
          totalCOMMERCIAL_MANAGED_CARE_ESTABLISHED_lead_14days += row['COMMERCIAL_MANAGED_CARE_ESTABLISHED_lead_14days']
          totalCOMMERCIAL_MANAGED_CARE_ESTABLISHED_lead_14days_more += row['COMMERCIAL_MANAGED_CARE_ESTABLISHED_lead_14days_more']
        })
        return (totalCOMMERCIAL_MANAGED_CARE_ESTABLISHED_lead_14days) / (totalCOMMERCIAL_MANAGED_CARE_ESTABLISHED_lead_14days + totalCOMMERCIAL_MANAGED_CARE_ESTABLISHED_lead_14days_more) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),

    perc_new_lead_14days_mcr = colDef(
      name = "% New Medicare Scheduled within 14 Days",
      maxWidth = 100,
      headerStyle = list(background = "#cca300", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalMEDICARE_NEW_lead_14days = 0
        let totalMEDICARE_NEW_lead_14days_more = 0
        let totalMEDICARE_HMO_NEW_lead_14days = 0
        let totalMEDICARE_HMO_NEW_lead_14days_more = 0
        rows.forEach(function(row) {
          totalMEDICARE_NEW_lead_14days += row['MEDICARE_NEW_lead_14days']
          totalMEDICARE_NEW_lead_14days_more += row['MEDICARE_NEW_lead_14days_more']
          totalMEDICARE_HMO_NEW_lead_14days += row['MEDICARE_HMO_NEW_lead_14days']
          totalMEDICARE_HMO_NEW_lead_14days_more += row['MEDICARE_HMO_NEW_lead_14days_more']
        })
        return (totalMEDICARE_NEW_lead_14days + totalMEDICARE_HMO_NEW_lead_14days) / (totalMEDICARE_NEW_lead_14days + totalMEDICARE_NEW_lead_14days_more + totalMEDICARE_HMO_NEW_lead_14days + totalMEDICARE_HMO_NEW_lead_14days_more) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),

    perc_new_lead_14days_mcd = colDef(
      name = "% New Medicaid Scheduled within 14 Days",
      maxWidth = 100,
      headerStyle = list(background = "#cca300", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalMEDICAID_NEW_lead_14days = 0
        let totalMEDICAID_NEW_lead_14days_more = 0
        let totalMEDICAID_HMO_NEW_lead_14days = 0
        let totalMEDICAID_HMO_NEW_lead_14days_more = 0
        rows.forEach(function(row) {
          totalMEDICAID_NEW_lead_14days += row['MEDICAID_NEW_lead_14days']
          totalMEDICAID_NEW_lead_14days_more += row['MEDICAID_NEW_lead_14days_more']
          totalMEDICAID_HMO_NEW_lead_14days += row['MEDICAID_HMO_NEW_lead_14days']
          totalMEDICAID_HMO_NEW_lead_14days_more += row['MEDICAID_HMO_NEW_lead_14days_more']
        })
        return (totalMEDICAID_NEW_lead_14days + totalMEDICAID_HMO_NEW_lead_14days) / (totalMEDICAID_NEW_lead_14days + totalMEDICAID_NEW_lead_14days_more + totalMEDICAID_HMO_NEW_lead_14days + totalMEDICAID_HMO_NEW_lead_14days_more) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),

    perc_new_lead_14days_commercial = colDef(
      name = "% New Commercial Scheduled within 14 Days",
      maxWidth = 100,
      headerStyle = list(background = "#cca300", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalCOMMERCIAL_MANAGED_CARE_NEW_lead_14days = 0
        let totalCOMMERCIAL_MANAGED_CARE_NEW_lead_14days_more = 0
        rows.forEach(function(row) {
          totalCOMMERCIAL_MANAGED_CARE_NEW_lead_14days += row['COMMERCIAL_MANAGED_CARE_NEW_lead_14days']
          totalCOMMERCIAL_MANAGED_CARE_NEW_lead_14days_more += row['COMMERCIAL_MANAGED_CARE_NEW_lead_14days_more']
        })
        return (totalCOMMERCIAL_MANAGED_CARE_NEW_lead_14days) / (totalCOMMERCIAL_MANAGED_CARE_NEW_lead_14days + totalCOMMERCIAL_MANAGED_CARE_NEW_lead_14days_more) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 1)
    ),

    Month = colDef(show =F),
    DEPARTMENT_ID = colDef(show =F),
    PROV_ID = colDef(show =F),
    sched_hours = colDef(show =F),
    arrived_hours = colDef(show =F),
    sched_hours = colDef(show =F),
    arrived_hours = colDef(show =F),
    Arrived = colDef(show =F),
    SameDay_Canceled = colDef(show =F),
    No_Show = colDef(show =F),
    perc_noShow = colDef(show =F),
    perc_SameDayCanceled = colDef(show =F),
    NEW_LOS = colDef(show =F),
    appts_arrived = colDef(show =F),
    ESTABLISHED_LOS = colDef(show =F),
    total_referrals = colDef(show =F),
    # total_scheduled = colDef(show =F),
    total_completed = colDef(show =F),
    total_tkt_sent_automated = colDef(show =F),
    total_tkt_sent_scheduler = colDef(show =F),
    total_tkt_sent_both = colDef(show =F),
    total_tkt_sent = colDef(show =F),
    non_converted_None = colDef(show =F),
    non_converted_Automated = colDef(show =F),
    non_converted_Scheduler = colDef(show =F),
    non_converted_Both = colDef(show =F),
    scheduled_None = colDef(show =F),
    scheduled_Automated = colDef(show =F),
    scheduled_Scheduler = colDef(show =F),
    scheduled_Both = colDef(show =F),
    perc_tkt_sent_scheduler = colDef(show =F),
    perc_tkt_sent_both = colDef(show =F),
    completed_None = colDef(show =F),
    completed_Automated = colDef(show =F),
    completed_Scheduler = colDef(show =F),
    completed_Both = colDef(show =F),
    ESTABLISHED = colDef(show =F),
    NEW = colDef(show =F),
    appts_scheduled = colDef(show =F),
    perc_new = colDef(show =F),
    NEW_lead_14days = colDef(show =F),
    NEW_lead_14days_more = colDef(show =F),
    NEW_appts_scheduled = colDef(show =F),
    perc_new_lead_14days = colDef(show =F),
    avail_N_sched_N = colDef(show =F),
    avail_Y_sched_N = colDef(show =F),
    avail_Y_sched_Y = colDef(show =F),

    MEDICARE_HMO_ESTABLISHED_LOS = colDef(show =F),
    COMMERCIAL_MANAGED_CARE_NEW_LOS = colDef(show =F),
    MEDICARE_ESTABLISHED_LOS = colDef(show =F),
    OTHER_ESTABLISHED_LOS = colDef(show =F),
    MEDICARE_NEW_LOS = colDef(show =F),
    MEDICAID_HMO_ESTABLISHED_LOS = colDef(show =F),
    COMMERCIAL_MANAGED_CARE_ESTABLISHED_LOS = colDef(show =F),
    MEDICAID_ESTABLISHED_LOS = colDef(show =F),
    MEDICARE_HMO_NEW_LOS = colDef(show =F),
    SELF_PAY_ESTABLISHED_LOS = colDef(show =F),
    SELF_PAY_NEW_LOS = colDef(show =F),
    MEDICAID_HMO_NEW_LOS = colDef(show =F),
    OTHER_NEW_LOS = colDef(show =F),
    MEDICAID_NEW_LOS = colDef(show =F),
    NO_COVERAGE_ASSIGNED_ESTABLISHED_LOS = colDef(show =F),
    NO_COVERAGE_ASSIGNED_NEW_LOS = colDef(show =F),
    MEDICAID_ESTABLISHED_lead_14days = colDef(show =F),
    MEDICARE_HMO_ESTABLISHED_lead_14days_more = colDef(show =F),
    MEDICARE_NEW_lead_14days_more = colDef(show =F),
    MEDICAID_NEW_lead_14days_more = colDef(show =F),
    MEDICARE_ESTABLISHED_lead_14days = colDef(show =F),
    MEDICAID_HMO_ESTABLISHED_lead_14days_more = colDef(show =F),
    COMMERCIAL_MANAGED_CARE_ESTABLISHED_lead_14days_more = colDef(show =F),
    MEDICAID_HMO_ESTABLISHED_lead_14days = colDef(show =F),
    COMMERCIAL_MANAGED_CARE_NEW_lead_14days = colDef(show =F),
    MEDICAID_HMO_NEW_lead_14days_more = colDef(show =F),
    COMMERCIAL_MANAGED_CARE_ESTABLISHED_lead_14days = colDef(show =F),
    SELF_PAY_NEW_lead_14days = colDef(show =F),
    MEDICARE_NEW_lead_14days = colDef(show =F),
    MEDICARE_ESTABLISHED_lead_14days_more = colDef(show =F),
    SELF_PAY_ESTABLISHED_lead_14days = colDef(show =F),
    MEDICARE_HMO_ESTABLISHED_lead_14days = colDef(show =F),
    COMMERCIAL_MANAGED_CARE_NEW_lead_14days_more = colDef(show =F),
    MEDICARE_HMO_NEW_lead_14days = colDef(show =F),
    SELF_PAY_ESTABLISHED_lead_14days_more = colDef(show =F),
    OTHER_ESTABLISHED_lead_14days_more = colDef(show =F),
    MEDICAID_NEW_lead_14days = colDef(show =F),
    SELF_PAY_NEW_lead_14days_more = colDef(show =F),
    NO_COVERAGE_ASSIGNED_ESTABLISHED_lead_14days_more = colDef(show =F),
    MEDICAID_ESTABLISHED_lead_14days_more = colDef(show =F),
    MEDICARE_HMO_NEW_lead_14days_more = colDef(show =F),
    MEDICAID_HMO_NEW_lead_14days = colDef(show =F),
    NO_COVERAGE_ASSIGNED_NEW_lead_14days_more = colDef(show =F),
    NO_COVERAGE_ASSIGNED_ESTABLISHED_lead_14days = colDef(show =F),
    OTHER_ESTABLISHED_lead_14days = colDef(show =F),
    NO_COVERAGE_ASSIGNED_NEW_lead_14days = colDef(show =F),
    OTHER_NEW_lead_14days = colDef(show =F),
    OTHER_NEW_lead_14days_more = colDef(show =F)


  ) # Close Columns

  ) # Close Reactable
) # Close Taglist
) # Close htmltools

```
<br/>
<p style="font-size:10pt; font-style:italic">*New Patient is defined by level of service; New Patient Ratio is calculated based on (Total New Patients Arrived) / (Total Patients Arrived)<p/>
<p style="font-size:10pt; font-style:italic">*Primary Care includes Adolescent Medicine, Community and Preventative Medicine, Internal Medicine, Family Medicine, Pediatrics, Geriatrics, Urgent Care<p/>



<br/>
<br/>
